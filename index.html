<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ef6c00">
  <meta name="description" content="Streakify - Build a Streak. Track streaks for your daily tasks.">
  <link rel="manifest" href="manifest.json">
  <script type="module" src="firebase-config.js"></script>
  <title>Streakify</title>
  <style>
    :root {
      --bg-deep: #fff8f0;
      --bg-surface: #fff5e8;
      --bg-elevated: #fffbf5;
      --bg-card: rgba(255, 252, 248, 0.95);
      --border: rgba(220, 180, 140, 0.5);
      --border-focus: rgba(255, 152, 0, 0.5);
      --text: #2c1810;
      --text-muted: #6b5344;
      --text-dim: #8b7355;
      --accent: #d32f2f;
      --accent-hover: #e53935;
      --accent-glow: rgba(211, 47, 47, 0.2);
      --primary: #ef6c00;
      --primary-hover: #ff9800;
      --primary-glow: rgba(239, 108, 0, 0.2);
      --gem: #f9a825;
      --gem-glow: rgba(249, 168, 37, 0.3);
      --saver: #ffb74d;
      --saver-glow: rgba(255, 183, 77, 0.35);
      --radius: 14px;
      --radius-sm: 10px;
      --radius-lg: 18px;
      --shadow: 0 2px 20px rgba(120, 80, 50, 0.08);
      --shadow-hover: 0 8px 32px rgba(120, 80, 50, 0.12);
      --transition: 0.22s ease;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, 'Helvetica Neue', sans-serif;
      max-width: 480px;
      margin: 0 auto;
      padding: 1.5rem;
      min-height: 100vh;
      color: var(--text);
      background: linear-gradient(165deg, #fff8f0 0%, #fff0e0 35%, #ffebe0 70%, #fff5e8 100%);
      background-attachment: fixed;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
      color: var(--text);
      letter-spacing: -0.02em;
    }
    .tagline {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }
    .add-form {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
    }
    .add-form input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-elevated);
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .add-form input::placeholder {
      color: var(--text-dim);
    }
    .add-form input:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .add-form-time-label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 0.5rem 0 0.25rem 0;
    }
    .add-form-time-label .required {
      color: var(--accent);
    }
    .add-form-time {
      width: 100%;
      max-width: 140px;
      padding: 0.5rem 0.65rem;
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-elevated);
      color: var(--text);
      font-family: inherit;
    }
    .streak-time {
      font-weight: normal;
      color: var(--text-muted);
      font-size: 0.9em;
    }
    .add-form input.invalid {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }
    .activity-error {
      font-size: 0.85rem;
      color: var(--accent);
      margin-top: 0.5rem;
      display: none;
    }
    .activity-error.visible {
      display: block;
    }
    .add-form button {
      padding: 0.75rem 1.2rem;
      background: linear-gradient(180deg, var(--primary) 0%, #f57c00 100%);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition);
      box-shadow: 0 3px 12px var(--primary-glow);
    }
    .add-form button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--primary-glow);
    }
    .streak-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .streak-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.1rem;
      background: var(--bg-card);
      border-radius: var(--radius);
      margin-bottom: 0.65rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .streak-item:hover {
      border-color: rgba(255, 152, 0, 0.25);
      box-shadow: var(--shadow-hover);
    }
    .streak-info {
      flex: 1;
      min-width: 0;
    }
    .streak-name {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.2rem;
      color: var(--text);
    }
    .streak-count {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .streak-count strong {
      color: var(--accent);
      font-size: 1.05rem;
      font-weight: 700;
      text-shadow: 0 0 20px var(--accent-glow);
    }
    .btn-done {
      padding: 0.6rem 1.1rem;
      background: linear-gradient(180deg, var(--accent) 0%, #e06b50 100%);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      white-space: nowrap;
      transition: transform var(--transition), box-shadow var(--transition);
      box-shadow: 0 3px 12px var(--accent-glow);
    }
    .btn-done:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px var(--accent-glow);
    }
    .btn-done:disabled {
      background: var(--bg-elevated);
      color: var(--text-dim);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .btn-delete {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      padding: 0.35rem;
      font-size: 1.2rem;
      line-height: 1;
      border-radius: var(--radius-sm);
      transition: color var(--transition), background var(--transition);
    }
    .btn-delete:hover {
      color: var(--accent);
      background: rgba(229, 57, 53, 0.12);
    }
    .empty {
      text-align: center;
      color: var(--text-muted);
      padding: 2.5rem 1.5rem;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    /* Nav */
    .nav {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 1.5rem;
      background: var(--bg-elevated);
      padding: 0.35rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .nav button {
      flex: 1;
      padding: 0.65rem 1rem;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-weight: 600;
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: color var(--transition), background var(--transition);
    }
    .nav button.active {
      background: var(--bg-surface);
      color: var(--primary);
      box-shadow: 0 2px 10px rgba(255, 152, 0, 0.2);
    }
    .nav button:hover:not(.active) {
      color: var(--text);
    }

    /* Full main menu */
    .top-bar {
      position: relative;
      z-index: 150;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin: -0.5rem -0.5rem 0 -0.5rem;
      padding: 0.85rem 1rem;
      background: var(--bg-card);
      border-radius: 0 0 var(--radius) var(--radius);
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-top: none;
      box-shadow: var(--shadow);
    }
    .menu-toggle {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text);
      cursor: pointer;
      font-size: 1.4rem;
      transition: background var(--transition), color var(--transition);
    }
    .menu-toggle:hover {
      background: rgba(255, 152, 0, 0.15);
      color: var(--primary);
    }
    .menu-toggle[aria-expanded="true"] {
      background: rgba(255, 152, 0, 0.2);
      color: var(--primary);
    }
    .top-bar .logo {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      background: linear-gradient(135deg, rgba(229, 57, 53, 0.2) 0%, rgba(255, 152, 0, 0.15) 100%);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }
    .top-bar .title-wrap {
      flex: 1;
      min-width: 0;
    }
    .top-bar h1 {
      margin: 0;
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--text);
    }
    .top-bar .tagline {
      margin: 0;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .menu-check-hidden {
      position: fixed;
      left: -9999px;
      opacity: 0;
      width: 1px;
      height: 1px;
      margin: -1px;
      overflow: hidden;
    }
    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.25s ease, visibility 0.25s ease;
      pointer-events: none;
    }
    #menuCheck:checked ~ .menu-overlay {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .menu-drawer {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: min(280px, 85vw);
      max-width: 100%;
      background: var(--bg-surface);
      border-right: 1px solid var(--border);
      z-index: 101;
      box-shadow: 8px 0 32px rgba(0, 0, 0, 0.45);
      display: flex;
      flex-direction: column;
      transform: translateX(-100%);
      transition: transform 0.25s ease-out;
    }
    #menuCheck:checked ~ .menu-overlay .menu-drawer {
      transform: translateX(0);
    }
    .menu-drawer-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1.25rem 1.25rem 1rem;
      border-bottom: 1px solid var(--border);
    }
    .menu-drawer-header .logo {
      width: 44px;
      height: 44px;
      font-size: 1.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(229, 57, 53, 0.2) 0%, rgba(255, 152, 0, 0.15) 100%);
      border-radius: var(--radius-sm);
    }
    .menu-drawer-header h2 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
    }
    .menu-nav {
      list-style: none;
      padding: 0.75rem 0;
      margin: 0;
      flex: 1;
    }
    .menu-nav li {
      margin: 0;
    }
    .menu-nav a,
    .menu-nav button {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
      padding: 0.9rem 1.25rem;
      border: none;
      background: none;
      color: var(--text-muted);
      font-size: 1rem;
      text-align: left;
      cursor: pointer;
      text-decoration: none;
      font-family: inherit;
      transition: background var(--transition), color var(--transition);
    }
    .menu-nav a:hover,
    .menu-nav button:hover {
      background: rgba(255, 152, 0, 0.12);
      color: var(--primary);
    }
    .menu-nav a.active,
    .menu-nav button.active {
      background: rgba(255, 152, 0, 0.15);
      color: var(--primary);
      font-weight: 600;
    }
    .menu-nav .menu-icon {
      width: 24px;
      text-align: center;
      font-size: 1.1rem;
    }
    .menu-drawer-footer {
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--border);
    }
    .menu-drawer-footer button {
      width: 100%;
      padding: 0.7rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      font-size: 0.9rem;
      font-family: inherit;
      cursor: pointer;
      transition: background var(--transition), color var(--transition);
    }
    .menu-drawer-footer button:hover {
      background: var(--bg-card);
      color: var(--text);
    }

    /* Confirm completion modal â€“ keep streaks legitimate */
    .confirm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      pointer-events: none;
    }
    .confirm-overlay.open {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .confirm-dialog {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 1.5rem;
      max-width: 320px;
      width: 100%;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    }
    .confirm-dialog h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.1rem;
      color: var(--text);
    }
    .confirm-dialog p {
      margin: 0 0 1.25rem 0;
      font-size: 0.95rem;
      color: var(--text-muted);
      line-height: 1.45;
    }
    .confirm-dialog .confirm-task-name {
      font-weight: 600;
      color: var(--accent);
    }
    .confirm-dialog .confirm-time-row {
      margin: 1rem 0;
    }
    .confirm-dialog .confirm-time-row label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }
    .confirm-dialog .confirm-time-row input[type="time"] {
      padding: 0.5rem 0.65rem;
      font-size: 1rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: inherit;
    }
    .confirm-dialog .confirm-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }
    .confirm-dialog .confirm-actions button {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      font-family: inherit;
    }
    .confirm-dialog .btn-cancel {
      background: var(--bg-elevated);
      color: var(--text-muted);
    }
    .confirm-dialog .btn-cancel:hover {
      background: var(--border);
      color: var(--text);
    }
    .confirm-dialog .btn-confirm {
      background: linear-gradient(180deg, var(--accent) 0%, #e06b50 100%);
      color: #fff;
      transition: transform var(--transition);
    }
    .confirm-dialog .btn-confirm:hover {
      transform: translateY(-1px);
    }

    .section-title {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin: 1rem 0 0.5rem 0;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .section-title:first-of-type {
      margin-top: 0;
    }

    /* Panels */
    .panel {
      display: none;
    }
    .panel.active {
      display: block;
    }

    /* Calendar */
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .calendar-header h2 {
      font-size: 1.15rem;
      font-weight: 600;
      margin: 0;
      color: var(--text);
    }
    .calendar-header button {
      padding: 0.5rem 0.9rem;
      background: var(--bg-elevated);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1rem;
      font-family: inherit;
      transition: background var(--transition), border-color var(--transition), color var(--transition);
    }
    .calendar-header button:hover {
      background: var(--bg-surface);
      border-color: var(--primary);
      color: var(--primary);
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 0.5rem;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-dim);
      text-align: center;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid transparent;
      position: relative;
      transition: background var(--transition), transform var(--transition), border-color var(--transition), box-shadow var(--transition);
    }
    .calendar-day:hover {
      background: var(--bg-surface);
      transform: scale(1.05);
    }
    .calendar-day.other-month {
      color: var(--text-dim);
      opacity: 0.7;
    }
    .calendar-day.today {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent), 0 0 12px var(--accent-glow);
    }
    .calendar-day.has-activity::after {
      content: '';
      position: absolute;
      bottom: 5px;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--accent);
    }
    .calendar-day.selected {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    /* Day view */
    .day-view {
      margin-top: 1.25rem;
    }
    .day-view h3 {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 0.75rem 0;
      color: var(--text-muted);
    }
    .day-view .add-activity-form {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .day-view .add-activity-form .form-fields {
      flex: 1;
      min-width: 0;
    }
    .day-view .add-activity-form .form-fields input[type="text"] {
      width: 100%;
    }
    .day-view .add-activity-form input {
      flex: 1;
      padding: 0.65rem 0.9rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-elevated);
      color: var(--text);
      font-size: 0.95rem;
      font-family: inherit;
    }
    .day-view .add-activity-form button {
      padding: 0.65rem 1rem;
      background: linear-gradient(180deg, var(--primary) 0%, #f57c00 100%);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
    }
    .day-activities .streak-item {
      margin-bottom: 0.5rem;
    }
    .day-activities .streak-item.done .streak-name {
      text-decoration: line-through;
      color: var(--text-dim);
    }
    .day-activities .empty {
      padding: 1rem;
      font-size: 0.9rem;
    }
    .activity-type {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .activity-type label {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.85rem;
      color: var(--text-muted);
      cursor: pointer;
    }
    .activity-type input {
      margin: 0;
    }
    .past-day-msg {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }
    .activity-badge {
      font-size: 0.7rem;
      color: var(--text-dim);
      font-weight: 500;
    }
    .regular-options {
      margin-top: 0.5rem;
      padding: 0.5rem 0;
      border-top: 1px solid var(--border);
    }
    .regular-options label,
    .regular-options .label-text {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .frequency-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .frequency-row label {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
    }
    .weekdays-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.35rem;
    }
    .weekdays-row label {
      display: flex;
      align-items: center;
      padding: 0.3rem 0.55rem;
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      cursor: pointer;
      font-size: 0.75rem;
      transition: background var(--transition), border-color var(--transition);
    }
    .weekdays-row label:has(input:checked) {
      background: rgba(255, 152, 0, 0.15);
      border-color: var(--primary);
      color: var(--primary);
    }
    .month-days-input {
      margin-top: 0.35rem;
      width: 100%;
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: inherit;
    }
    .month-days-input::placeholder {
      color: var(--text-dim);
    }

    /* Gem mode */
    .gem-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.75rem 1.1rem;
      background: var(--bg-card);
      border-radius: var(--radius);
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .gem-bar .gem-stat {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--gem);
      text-shadow: 0 0 24px var(--gem-glow);
    }
    .gem-bar .saver-stat {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--saver);
      text-shadow: 0 0 20px var(--saver-glow);
    }
    .btn-buy-saver {
      padding: 0.5rem 0.85rem;
      background: linear-gradient(180deg, rgba(255, 152, 0, 0.25) 0%, rgba(255, 152, 0, 0.15) 100%);
      color: var(--primary);
      border: 1px solid rgba(255, 152, 0, 0.45);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: background var(--transition), transform var(--transition);
    }
    .btn-buy-saver:hover:not(:disabled) {
      background: rgba(255, 152, 0, 0.2);
      transform: translateY(-1px);
    }
    .btn-buy-saver:disabled {
      background: var(--bg-elevated);
      color: var(--text-dim);
      border-color: var(--border);
      cursor: not-allowed;
    }
    .btn-use-saver {
      padding: 0.5rem 0.85rem;
      background: linear-gradient(180deg, var(--saver) 0%, #2ea043 100%);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      white-space: nowrap;
      transition: transform var(--transition), box-shadow var(--transition);
      box-shadow: 0 2px 10px var(--saver-glow);
    }
    .btn-use-saver:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px var(--saver-glow);
    }
    .streak-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    /* StreakTopia - 2D city */
    #panelStreaktopia {
      max-width: 100%;
    }
    .streaktopia-city-wrap {
      width: 85vw;
      max-width: none;
      margin-left: calc(-42.5vw + 50%);
    }
    .streaktopia-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    .streaktopia-gems-badge {
      padding: 0.4rem 0.75rem;
      background: linear-gradient(135deg, rgba(249,168,37,0.25) 0%, rgba(255,183,77,0.15) 100%);
      border-radius: 20px;
      font-weight: 700;
      font-size: 1rem;
      border: 1px solid rgba(249,168,37,0.4);
    }
    .streaktopia-tagline {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin: 0;
    }
    .city-level {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--primary);
      margin-left: 0.25rem;
    }
    .streaktopia-city-wrap {
      position: relative;
      margin-bottom: 1rem;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5), 0 0 0 1px rgba(0,0,0,0.25);
    }
    .streaktopia-world {
      position: relative;
      min-height: 820px;
      overflow: hidden;
      border-radius: var(--radius) var(--radius) 0 0;
    }
    /* Sky - bright blue gradient */
    .streaktopia-sky {
      position: absolute;
      inset: 0;
      background:
        linear-gradient(180deg, #78a7ff 0%, #7eb3e8 22%, #8bc4f0 45%, #a8d4f8 70%, #c6e5ff 88%, #d4ebff 100%);
      pointer-events: none;
      transition: background 1s ease;
    }
    .streaktopia-sky.night {
      background: linear-gradient(180deg, #0a1628 0%, #1a237e 40%, #283593 70%, #3949ab 100%);
    }
    .streaktopia-sky.night .streaktopia-cloud { opacity: 0.4; }
    .streaktopia-sky.night::after {
      background: #fff9c4;
      box-shadow: 0 0 30px 10px rgba(255,249,196,0.6);
    }
    .streaktopia-birds-layer, .streaktopia-particles-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .streaktopia-bird, .streaktopia-butterfly {
      position: absolute;
      font-size: 1.2rem;
      opacity: 0.7;
      animation: birdFly 20s linear infinite;
    }
    .streaktopia-butterfly { animation: butterflyFloat 15s ease-in-out infinite; }
    @keyframes birdFly {
      0% { left: -5%; transform: translateY(0) scaleX(1); }
      50% { left: 105%; transform: translateY(-20px) scaleX(1); }
      51% { transform: translateY(-20px) scaleX(-1); }
      100% { left: -5%; transform: translateY(0) scaleX(-1); }
    }
    @keyframes butterflyFloat {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(10px, -15px) rotate(5deg); }
      50% { transform: translate(-5px, -25px) rotate(-3deg); }
      75% { transform: translate(15px, -10px) rotate(8deg); }
    }
    .streaktopia-sparkle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      animation: sparkleTwinkle 3s ease-in-out infinite;
    }
    @keyframes sparkleTwinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.5); }
    }
    .streaktopia-citizen-wander.streaktopia-flame {
      filter: drop-shadow(0 0 12px rgba(255, 140, 0, 0.8)) drop-shadow(0 0 24px rgba(255, 100, 0, 0.4)) drop-shadow(0 2px 4px rgba(0,0,0,0.4));
    }
    .streaktopia-sky::before {
      display: none;
    }
    .streaktopia-sky::after {
      content: '';
      position: absolute;
      top: 12%;
      right: 18%;
      width: 36px;
      height: 36px;
      background: #fff8dc;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.9);
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    /* Horizon - grass fade */
    .streaktopia-horizon {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 45%;
      background: linear-gradient(180deg, transparent 0%, rgba(91, 163, 50, 0.3) 40%, #5da331 100%);
      pointer-events: none;
    }
    .streaktopia-horizon::before {
      display: none;
    }
    /* 2D scene container */
    .streaktopia-scene {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
    }
    /* Ground - flat 2D grass strip */
    .streaktopia-ground {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 60px;
      background: linear-gradient(180deg, #6bb83d 0%, #5da331 50%, #4a7c1e 100%);
      border-top: 3px solid #7bc84a;
    }
    .streaktopia-ground::before {
      display: none;
    }
    .streaktopia-ground::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.06) 50%, transparent 100%);
      pointer-events: none;
    }
    /* City platform - transparent, grass shows through */
    .streaktopia-city {
      min-height: 280px;
      width: 96%;
      max-width: 100%;
      padding: 1.5rem 1.25rem 2.5rem;
      margin-bottom: 0;
      background: transparent;
      border-radius: 12px 12px 0 0;
      border: none;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      align-content: flex-end;
      gap: 1rem;
      position: relative;
      box-shadow: none;
    }
    .streaktopia-city::before {
      display: none;
    }
    .streaktopia-city::after {
      display: none;
    }
    /* 2D fog - subtle */
    .streaktopia-fog {
      position: absolute;
      inset: 0;
      background: linear-gradient(0deg, transparent 0%, transparent 50%, rgba(0,0,0,0.08) 100%);
      pointer-events: none;
      border-radius: var(--radius) var(--radius) 0 0;
    }
    .streaktopia-vignette {
      position: absolute;
      inset: 0;
      box-shadow: inset 0 0 40px 10px rgba(0,0,0,0.15);
      pointer-events: none;
      border-radius: var(--radius) var(--radius) 0 0;
    }
    .streaktopia-city.empty-city {
      min-height: 260px;
      align-items: center;
      justify-content: center;
    }
    .streaktopia-city.empty-city .streaktopia-buildings-row {
      width: 100%;
      justify-content: center;
      text-align: center;
    }
    .streaktopia-empty-preview {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem;
    }
    .streaktopia-empty-preview .empty-emoji { font-size: 3rem; opacity: 0.6; }
    .streaktopia-empty-preview .empty-text { font-weight: 600; color: var(--text-muted); }
    .streaktopia-empty-preview .empty-hint { font-size: 0.9rem; color: var(--text-dim); }
    .streaktopia-buildings-row {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      align-content: flex-end;
      gap: 0.75rem;
      position: relative;
      z-index: 1;
      transform-style: preserve-3d;
    }
    .streaktopia-building {
      font-size: 2.75rem;
      line-height: 1;
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 56px;
      height: 56px;
      transition: transform 0.15s ease;
      filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.3)) drop-shadow(0 3px 0 rgba(0,0,0,0.2)) drop-shadow(0 0 12px rgba(255,200,100,0.2));
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      animation: buildingIdle 4s ease-in-out infinite;
    }
    .streaktopia-building:nth-child(odd) { animation-delay: -1s; }
    .streaktopia-building:nth-child(3n) { animation-delay: -2.5s; }
    @keyframes buildingIdle {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
    }
    .streaktopia-building::before {
      content: '';
      position: absolute;
      inset: -2px;
      z-index: -1;
      background: #8b8b8b;
      border-bottom: 2px solid #6b6b6b;
      border-right: 2px solid #6b6b6b;
      border-radius: 4px;
    }
    .streaktopia-building::after {
      content: '';
      position: absolute;
      left: 50%;
      bottom: -4px;
      width: 85%;
      height: 4px;
      transform: translateX(-50%);
      background: #5a5a5a;
      border-radius: 2px;
      pointer-events: none;
    }
    .streaktopia-building:hover {
      transform: scale(1.1) translateY(-2px);
      filter: drop-shadow(3px 3px 0 rgba(0,0,0,0.3)) drop-shadow(0 4px 0 rgba(0,0,0,0.2)) drop-shadow(0 0 16px rgba(255,200,100,0.35));
      animation: none;
    }
    .streaktopia-building:active {
      transform: scale(1.05);
    }
    .streaktopia-citizens-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 2;
      border-radius: 0;
      overflow: hidden;
    }
    .streaktopia-citizens-layer .streaktopia-citizen-wander {
      pointer-events: auto;
      cursor: pointer;
      position: absolute;
    }
    .streaktopia-citizen-wander.tap-bounce {
      animation: citizenBounce 0.4s ease-out !important;
    }
    @keyframes citizenBounce {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.4); filter: drop-shadow(0 0 20px rgba(255, 200, 0, 0.9)); }
    }
    .streaktopia-building.build-pop {
      animation: buildPop 0.5s ease-out;
    }
    @keyframes buildPop {
      0% { transform: scale(0.3); opacity: 0.5; }
      70% { transform: scale(1.15); }
      100% { transform: scale(1); opacity: 1; }
    }
    .streaktopia-building.clickable {
      cursor: pointer;
    }
    .streaktopia-happiness-bar {
      height: 6px;
      background: rgba(0,0,0,0.15);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .streaktopia-happiness-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff9800, #ffd54f);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    .streaktopia-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 1rem;
    }
    .streaktopia-modal {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      max-width: 280px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      border: 1px solid var(--border);
    }
    .streaktopia-modal-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem; }
    .streaktopia-modal-desc { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem; }
    .streaktopia-modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
    .streaktopia-modal-actions button {
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      border: none;
    }
    .streaktopia-modal-sell {
      background: #e53935;
      color: #fff;
      transition: transform var(--transition);
    }
    .streaktopia-modal-sell:hover { background: #c62828; transform: translateY(-1px); }
    .streaktopia-modal-close {
      background: var(--bg-elevated);
      color: var(--text);
    }
    .streaktopia-toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.85rem 1.35rem;
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      border: 1px solid var(--border);
      font-weight: 600;
      z-index: 201;
      animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 0.6s forwards;
    }
    @keyframes toastIn {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    @keyframes toastOut {
      from { opacity: 1; }
      to { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }
    .streaktopia-happiness[title] { cursor: help; }
    .streaktopia-player {
      position: absolute;
      left: 10%;
      bottom: 22%;
      font-size: 2rem;
      z-index: 3;
      transform: translate(-50%, 0);
      filter: drop-shadow(0 0 12px rgba(255, 152, 0, 0.5)) drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      cursor: pointer;
      animation: playerIdle 3s ease-in-out infinite;
      pointer-events: auto;
    }
    .streaktopia-player:hover {
      filter: drop-shadow(0 0 16px rgba(255, 152, 0, 0.7)) drop-shadow(0 3px 6px rgba(0,0,0,0.4));
    }
    .streaktopia-pet {
      position: absolute;
      font-size: 1.8rem;
      z-index: 3;
      transform: translate(-50%, 0);
      filter: drop-shadow(0 0 10px rgba(255, 140, 0, 0.5)) drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      cursor: pointer;
      pointer-events: auto;
    }
    .streaktopia-pet.tap-bounce {
      animation: citizenBounce 0.4s ease-out !important;
    }
    .streaktopia-player.wave {
      animation: playerWave 0.6s ease-out;
    }
    @keyframes playerIdle {
      0%, 100% { transform: translate(-50%, 0) scale(1); }
      50% { transform: translate(-50%, -3px) scale(1.02); }
    }
    @keyframes playerWave {
      0% { transform: translate(-50%, 0) rotate(0deg); }
      25% { transform: translate(-50%, -5px) rotate(-15deg); }
      50% { transform: translate(-50%, -8px) rotate(10deg); }
      75% { transform: translate(-50%, -4px) rotate(-5deg); }
      100% { transform: translate(-50%, 0) rotate(0deg); }
    }
    .streaktopia-citizen-wander {
      position: absolute;
      font-size: 1.5rem;
      filter: drop-shadow(0 0 10px rgba(255, 140, 0, 0.7)) drop-shadow(0 2px 4px rgba(0,0,0,0.4));
      transform: translate(-50%, -50%);
    }
    @keyframes wander1 {
      0%, 100% { left: 15%; top: 65%; }
      25% { left: 45%; top: 35%; }
      50% { left: 75%; top: 60%; }
      75% { left: 35%; top: 80%; }
    }
    @keyframes wander2 {
      0%, 100% { left: 80%; top: 70%; }
      33% { left: 25%; top: 45%; }
      66% { left: 60%; top: 25%; }
    }
    @keyframes wander3 {
      0%, 100% { left: 50%; top: 75%; }
      20% { left: 20%; top: 40%; }
      40% { left: 70%; top: 50%; }
      60% { left: 40%; top: 30%; }
      80% { left: 75%; top: 70%; }
    }
    @keyframes wander4 {
      0%, 100% { left: 30%; top: 50%; }
      50% { left: 70%; top: 55%; }
    }
    @keyframes wander5 {
      0%, 100% { left: 60%; top: 40%; }
      33% { left: 35%; top: 75%; }
      66% { left: 80%; top: 35%; }
    }
    .streaktopia-happiness {
      text-align: center;
      padding: 0.85rem 1rem;
      background: var(--bg-card);
      border-radius: 0 0 var(--radius) var(--radius);
      border: 1px solid var(--border);
      border-top: none;
      font-size: 1.5rem;
      letter-spacing: 0.15em;
    }
    .streaktopia-happiness-label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.35rem;
      letter-spacing: 0.02em;
    }
    .streaktopia-stats {
      display: flex;
      gap: 1.5rem;
      padding: 0.5rem 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    .streaktopia-stat span { font-weight: 700; color: var(--primary); }
    .streaktopia-citizens {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 1rem;
    }
    .streaktopia-citizens-title {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
      width: 100%;
    }
    .streaktopia-quests-hint {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin: -0.25rem 0 0.5rem 0;
    }
    .streaktopia-quest-item {
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.35rem;
      background: var(--bg-elevated);
      border-radius: 8px;
      font-size: 0.9rem;
      border-left: 3px solid var(--border);
      transition: border-color 0.2s;
    }
    .streaktopia-quest-item.done {
      border-left-color: #43a047;
      color: var(--text-muted);
    }
    .streaktopia-citizen {
      font-size: 1.5rem;
      filter: drop-shadow(0 0 6px rgba(255, 140, 0, 0.4));
    }
    .streaktopia-citizens .streaktopia-citizen-count {
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    .streaktopia-shop {
      margin-top: 1rem;
    }
    .streaktopia-shop-title {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
      font-weight: 600;
    }
    .streaktopia-shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
    }
    .streaktopia-shop-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 0.75rem;
      background: linear-gradient(145deg, #1a237e 0%, #16213e 100%);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .streaktopia-shop-item:hover:not(.locked) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    .streaktopia-shop-item.locked {
      opacity: 0.85;
    }
    .streaktopia-shop-item .shop-emoji {
      font-size: 2rem;
    }
    .streaktopia-shop-item .shop-name {
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
    }
    .streaktopia-shop-item .cost {
      color: #ffd700;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .streaktopia-shop-item button {
      padding: 0.4rem 0.75rem;
      background: #0f3460;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .streaktopia-shop-item button:hover {
      background: #1a4a7a;
    }
    .streaktopia-shop-item button:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }

    .reminders-tagline {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 1.25rem;
    }
    .reminder-form {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .reminder-form label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
    }
    .reminder-form input[type="email"],
    .reminder-form input[type="time"] {
      padding: 0.65rem 0.9rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-elevated);
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
    }
    .reminder-form input:focus {
      outline: none;
      border-color: var(--border-focus);
    }
    .reminder-checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500 !important;
      cursor: pointer;
    }
    .reminder-checkbox-label input {
      margin: 0;
    }
    .btn-save-reminder {
      padding: 0.75rem 1.25rem;
      background: linear-gradient(180deg, var(--primary) 0%, #f57c00 100%);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-family: inherit;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 0.25rem;
    }
    .btn-save-reminder:hover {
      opacity: 0.95;
    }
    .reminder-saved-msg {
      color: var(--saver);
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }
    .reminder-note {
      font-size: 0.8rem;
      color: var(--text-dim);
      line-height: 1.4;
    }

    /* GameHub - Poki-style */
    .gamehub-header {
      margin-bottom: 1rem;
    }
    .gamehub-title {
      font-size: 1.5rem;
      font-weight: 800;
      margin: 0 0 0.25rem 0;
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #ffc107 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .gamehub-tagline {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin: 0;
    }
    .gamehub-locked {
      padding: 2rem;
      background: linear-gradient(145deg, rgba(255,107,53,0.08) 0%, rgba(247,147,30,0.05) 100%);
      border-radius: 16px;
      border: 2px dashed var(--border);
      text-align: center;
    }
    .gamehub-locked-icon {
      font-size: 3rem;
      margin-bottom: 0.75rem;
      opacity: 0.8;
    }
    .gamehub-locked-msg {
      font-size: 1rem;
      color: var(--text-muted);
      margin: 0 0 0.5rem 0;
    }
    .gamehub-progress {
      font-size: 0.9rem;
      color: var(--primary);
      margin: 0;
      font-weight: 600;
    }
    .gamehub-unlocked-msg {
      font-size: 1.1rem;
      color: var(--text);
      margin: 0 0 1.25rem 0;
      font-weight: 700;
    }
    .gamehub-games {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.85rem;
    }
    .gamehub-game-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.25rem 0.75rem;
      border: none;
      border-radius: var(--radius-lg);
      cursor: pointer;
      text-align: center;
      font-family: inherit;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      min-height: 110px;
      box-shadow: 0 4px 16px rgba(80, 60, 40, 0.1);
    }
    .gamehub-game-card:hover {
      transform: scale(1.04);
      box-shadow: 0 8px 28px rgba(80, 60, 40, 0.15);
    }
    .gamehub-game-card:active {
      transform: scale(0.98);
    }
    .gamehub-game-emoji {
      font-size: 2.25rem;
      margin-bottom: 0.35rem;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    .gamehub-game-name {
      font-weight: 700;
      font-size: 0.95rem;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .gamehub-game-desc {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.9);
      margin-top: 0.2rem;
      text-shadow: 0 1px 1px rgba(0,0,0,0.2);
    }
    .gamehub-play-area {
      margin-top: 1rem;
      padding: 1.25rem;
      background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(254,250,246,0.98) 100%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: 0 4px 24px rgba(80, 60, 40, 0.06);
    }
    .gamehub-back {
      padding: 0.65rem 1.1rem;
      background: linear-gradient(135deg, #5d4037 0%, #8d6e63 100%);
      border: none;
      border-radius: var(--radius-sm);
      color: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 1rem;
      font-family: inherit;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: transform var(--transition), box-shadow var(--transition);
    }
    .gamehub-back:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    }
    .gamehub-reaction-btn {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      border: none;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.1s;
      font-family: inherit;
    }
    .gamehub-reaction-btn.waiting { background: #e53935; color: #fff; }
    .gamehub-reaction-btn.ready { background: #43a047; color: #fff; cursor: pointer; }
    .gamehub-tap-btn {
      width: 100%;
      padding: 2rem;
      font-size: 2rem;
      border-radius: var(--radius);
      border: 2px solid var(--border);
      background: linear-gradient(180deg, var(--bg-elevated) 0%, var(--bg-surface) 100%);
      cursor: pointer;
      font-family: inherit;
      transition: transform 0.15s, box-shadow 0.2s;
    }
    .gamehub-tap-btn:active { transform: scale(0.98); }
    .gamehub-memory-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
    }
    .gamehub-memory-card {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      background: linear-gradient(180deg, var(--bg-elevated) 0%, var(--bg-surface) 100%);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition);
    }
    .gamehub-memory-card.flipped, .gamehub-memory-card.matched {
      background: var(--bg-card);
      cursor: default;
    }
    .gamehub-memory-card.matched { opacity: 0.6; }
    .gamehub-memory-card:hover { transform: scale(1.03); }
    .gamehub-memory-card:hover:not(.flipped):not(.matched) { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .gamehub-memory-card.flipped { transform: scale(1.02); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .gamehub-memory-card.matched { animation: gameMatchPop 0.4s ease-out; }
    @keyframes gameMatchPop { 0% { transform: scale(1.1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .gamehub-memory-card.wrong { animation: gameShake 0.4s ease-out; }
    @keyframes gameShake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
    .gamehub-btn { padding: 0.65rem 1.2rem; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; font-family: inherit; transition: transform 0.15s, box-shadow 0.2s; background: linear-gradient(135deg, var(--primary) 0%, #f57c00 100%); color: #fff; box-shadow: 0 3px 10px var(--primary-glow); }
    .gamehub-btn:hover { transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .gamehub-btn:active { transform: scale(0.97); }
    .gamehub-score { font-size: 1.25rem; font-weight: 700; padding: 0.5rem 1rem; background: linear-gradient(135deg, rgba(67,160,71,0.2) 0%, rgba(76,175,80,0.15) 100%); border-radius: var(--radius-sm); display: inline-block; margin-bottom: 0.75rem; }
    .gamehub-instruction { font-size: 0.95rem; color: var(--text-muted); margin-bottom: 1rem; line-height: 1.5; padding: 0.85rem 1rem; background: var(--bg-elevated); border-radius: var(--radius-sm); border-left: 4px solid var(--primary); }
    .gamehub-win-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; border-radius: var(--radius); z-index: 10; animation: gameFadeIn 0.3s ease; }
    @keyframes gameFadeIn { from { opacity: 0; } to { opacity: 1; } }
    .gamehub-win-box { background: linear-gradient(135deg, #fff 0%, #fffbf5 100%); padding: 1.5rem 2rem; border-radius: var(--radius-lg); text-align: center; box-shadow: 0 12px 40px rgba(0,0,0,0.25); animation: gameWinPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes gameWinPop { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.08); } 100% { transform: scale(1); opacity: 1; } }
    .gamehub-win-emoji { font-size: 2.5rem; margin-bottom: 0.5rem; animation: gameBounce 0.6s ease infinite alternate; }
    @keyframes gameBounce { from { transform: translateY(0); } to { transform: translateY(-2px); } }
    .gamehub-tap-btn { transition: transform 0.1s, box-shadow 0.2s; }
    .gamehub-tap-btn:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
    .gamehub-reaction-btn { transition: transform 0.2s, box-shadow 0.2s; }
    .gamehub-reaction-btn.ready { animation: gamePulse 1.5s ease-in-out infinite; }
    @keyframes gamePulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(67,160,71,0.5); } 50% { box-shadow: 0 0 0 12px rgba(67,160,71,0); } }
    .gamehub-reaction-btn.ready:hover { transform: scale(1.05); } .gamehub-reaction-btn.ready:active { transform: scale(0.98); }

    .celebration-toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 1.25rem 1.75rem;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
      border: 2px solid var(--primary);
      font-weight: 700;
      font-size: 1.2rem;
      z-index: 250;
      animation: celebrationPop 0.4s ease-out;
    }
    @keyframes celebrationPop {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      70% { transform: translate(-50%, -50%) scale(1.1); }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    @keyframes confettiFall {
      to { transform: translate(calc((var(--tx, 0px))), calc(var(--ty, 150px))) rotate(360deg); opacity: 0; }
    }
    .confetti-piece {
      position: fixed;
      width: 8px;
      height: 8px;
      pointer-events: none;
      z-index: 249;
    }
    .in-app-reminder-banner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.85rem 1.1rem;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, rgba(255, 167, 87, 0.15) 0%, rgba(255, 183, 77, 0.1) 100%);
      border: 1px solid rgba(255, 167, 87, 0.35);
      border-radius: var(--radius);
      color: var(--text);
      font-weight: 600;
      box-shadow: var(--shadow);
    }
    .in-app-reminder-text {
      font-size: 0.95rem;
    }
    .in-app-reminder-dismiss {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.25rem;
      line-height: 1;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: var(--radius-sm);
    }
    .in-app-reminder-dismiss:hover {
      color: var(--text);
      background: rgba(0, 0, 0, 0.08);
    }
    .achievements-tagline { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem; }
    .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem; }
    .achievement-badge { display: flex; flex-direction: column; align-items: center; padding: 0.85rem; background: var(--bg-card); border-radius: var(--radius); border: 2px solid var(--border); text-align: center; transition: transform var(--transition), box-shadow var(--transition); }
    .achievement-badge:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
    .achievement-badge.earned { border-color: var(--primary); background: linear-gradient(135deg, rgba(255,152,0,0.15) 0%, rgba(239,108,0,0.08) 100%); }
    .achievement-badge .emoji { font-size: 2rem; margin-bottom: 0.25rem; }
    .achievement-badge .label { font-size: 0.75rem; font-weight: 600; color: var(--text); }
    .achievement-badge .req { font-size: 0.7rem; color: var(--text-muted); }
    .achievement-badge.locked .emoji { filter: grayscale(1); opacity: 0.5; }
    .sticker-board { min-height: 120px; padding: 1rem; background: var(--bg-elevated); border-radius: var(--radius); border: 2px dashed var(--border); display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: flex-start; align-content: flex-start; }
    .sticker-board .sticker { font-size: 2rem; cursor: pointer; }
    .weekly-goal { padding: 0.75rem 1rem; background: var(--bg-elevated); border-radius: var(--radius); margin-bottom: 1rem; }
    .weekly-goal.achieved { background: linear-gradient(135deg, rgba(67,160,71,0.2) 0%, rgba(76,175,80,0.15) 100%); border: 1px solid rgba(67,160,71,0.4); }
    .theme-btn { padding: 0.5rem 1rem; border-radius: 8px; border: 2px solid var(--border); background: var(--bg-elevated); cursor: pointer; }
    .theme-btn.active { border-color: var(--primary); background: rgba(255,152,0,0.15); }
    body.theme-ocean { --primary: #0288d1; background: linear-gradient(165deg, #e1f5fe 0%, #b3e5fc 50%, #81d4fa 100%); }
    body.theme-forest { --primary: #2e7d32; background: linear-gradient(165deg, #e8f5e9 0%, #c8e6c9 50%, #a5d6a7 100%); }
    body.theme-space { --primary: #7c4dff; background: linear-gradient(165deg, #ede7f6 0%, #d1c4e9 50%, #b39ddb 100%); }
    .streak-item.today-focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-glow); }
    .streak-item.today-focus::before { content: 'â­ '; }
    .btn-free-freeze { padding: 0.55rem 1rem; background: linear-gradient(180deg, #2e7d32 0%, #43a047 100%); color: #fff; border: none; border-radius: var(--radius-sm); font-weight: 600; cursor: pointer; font-size: 0.9rem; }
    .btn-free-freeze:hover { transform: translateY(-1px); }
    body.dark-mode { --bg-deep: #1a1a1a; --bg-surface: #252525; --bg-elevated: #2d2d2d; --bg-card: rgba(45,45,45,0.95); --border: rgba(255,255,255,0.15); --text: #f0f0f0; --text-muted: #b0b0b0; --text-dim: #888; background: linear-gradient(165deg, #1a1a1a 0%, #252525 100%); }
    .stats-panel { padding: 1rem; background: var(--bg-card); border-radius: var(--radius); margin-bottom: 1rem; border: 1px solid var(--border); }
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
    .stat-card { padding: 0.75rem; background: var(--bg-elevated); border-radius: var(--radius-sm); text-align: center; }
    .stat-card .value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
    .stat-card .label { font-size: 0.8rem; color: var(--text-muted); }
    .heatmap-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin: 0.5rem 0; }
    .heatmap-day { aspect-ratio: 1; border-radius: 3px; background: var(--bg-elevated); }
    .heatmap-day.done { background: var(--primary); opacity: 0.6; }
    .heatmap-day.streak { background: var(--accent); }
    .share-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 300; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .share-modal-inner { background: var(--bg-card); border-radius: var(--radius); padding: 1.5rem; max-width: 320px; }
    .install-banner { display: flex; align-items: center; justify-content: space-between; gap: 1rem; padding: 0.75rem 1rem; background: linear-gradient(135deg, var(--primary) 0%, #ff9800 100%); color: #fff; border-radius: var(--radius); margin-bottom: 1rem; }
    .install-banner button { background: #fff; color: var(--primary); border: none; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .install-prompt-banner { display: flex; align-items: center; justify-content: space-between; gap: 1rem; padding: 0.75rem 1rem; background: linear-gradient(135deg, var(--primary) 0%, #ff9800 100%); color: #fff; border-radius: var(--radius); margin-bottom: 1rem; position: relative; }
    .install-prompt-banner .install-prompt-dismiss { position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(255,255,255,0.3); color: #fff; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 1.2rem; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; }
    .install-prompt-banner .install-prompt-dismiss:hover { background: rgba(255,255,255,0.5); }
    .install-prompt-banner .install-prompt-text { flex: 1; padding-right: 2rem; }
    .install-prompt-banner .install-prompt-btn { background: #fff; color: var(--primary); border: none; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .for-parents-section { padding: 1rem; background: var(--bg-elevated); border-radius: var(--radius); margin-top: 1rem; }
    .daily-progress-banner { padding: 0.85rem 1rem; background: linear-gradient(135deg, rgba(239,108,0,0.15) 0%, rgba(255,152,0,0.1) 100%); border-radius: var(--radius); margin-bottom: 1rem; border: 1px solid rgba(239,108,0,0.3); }
    .daily-progress-banner.all-done { background: linear-gradient(135deg, rgba(67,160,71,0.2) 0%, rgba(102,187,106,0.15) 100%); border-color: rgba(67,160,71,0.4); }
    .daily-progress-bar { height: 8px; background: var(--bg-elevated); border-radius: 4px; overflow: hidden; margin-top: 0.5rem; }
    .daily-progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%); border-radius: 4px; transition: width 0.3s ease; }
    .quick-add-suggestions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
    .quick-add-chip { padding: 0.4rem 0.75rem; font-size: 0.85rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 999px; cursor: pointer; color: var(--text-muted); transition: all var(--transition); }
    .quick-add-chip:hover { background: var(--bg-surface); border-color: var(--primary); color: var(--primary); }
    .heatmap-day.light { opacity: 0.5; }
    .heatmap-day.medium { opacity: 0.75; }
    .heatmap-day.heavy { opacity: 1; }
    .milestone-toast { font-size: 1.1rem; font-weight: 600; padding: 1rem 1.5rem; }
    .streak-flame { font-size: 1.2em; filter: drop-shadow(0 0 4px rgba(255,100,0,0.5)); }
    .streak-item.at-risk { border-color: #ff9800; animation: pulse-border 2s infinite; }
    @keyframes pulse-border { 0%,100% { box-shadow: 0 0 0 0 rgba(255,152,0,0.3); } 50% { box-shadow: 0 0 0 4px rgba(255,152,0,0.2); } }
    .btn-edit, .btn-duplicate { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 0.25rem; font-size: 0.9rem; }
    .btn-edit:hover, .btn-duplicate:hover { color: var(--primary); }
    .onboarding-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 500; display: flex; align-items: center; justify-content: center; padding: 1.5rem; }
    .onboarding-card { background: var(--bg-card); border-radius: var(--radius); padding: 1.5rem; max-width: 360px; border: 1px solid var(--border); }
    .search-quests { width: 100%; padding: 0.6rem 1rem; margin-bottom: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 0.95rem; }
    .offline-banner { position: fixed; top: 0; left: 0; right: 0; background: #e53935; color: #fff; text-align: center; padding: 0.4rem; font-size: 0.85rem; z-index: 200; }
    .lucky-day-badge { display: inline-block; background: linear-gradient(135deg,#f9a825,#ffca28); color: #5d4037; padding: 0.2rem 0.5rem; border-radius: 999px; font-size: 0.75rem; font-weight: 700; margin-left: 0.25rem; }
  </style>
</head>
<body>
  <input type="checkbox" id="menuCheck" class="menu-check-hidden" aria-hidden="true">
  <header class="top-bar">
    <label for="menuCheck" class="menu-toggle" aria-label="Open menu">â˜°</label>
    <span class="logo" aria-hidden="true">ðŸ”¥</span>
    <div class="title-wrap">
      <h1>Streakify</h1>
      <p class="tagline"><span id="dueNowBadge" style="display:none;background:var(--accent);color:#fff;padding:0.15rem 0.4rem;border-radius:999px;font-size:0.75rem;margin-right:0.25rem;"></span>Build a Streak</p>
    </div>
    <button type="button" id="quickDarkToggle" aria-label="Toggle dark mode" style="background:none;border:none;font-size:1.2rem;cursor:pointer;padding:0.35rem;" title="Dark mode">ðŸŒ™</button>
  </header>

  <div class="menu-overlay" id="menuOverlay" aria-hidden="true" role="dialog" aria-label="Main menu">
    <div class="menu-drawer" role="dialog" aria-label="Main menu">
      <div class="menu-drawer-header">
        <span class="logo" aria-hidden="true">ðŸ”¥</span>
        <h2>Menu</h2>
      </div>
      <ul class="menu-nav">
        <li>
          <button type="button" class="menu-item active" data-panel="streaks">
            <span class="menu-icon">ðŸ”¥</span>
            <span>Streaks</span>
          </button>
        </li>
        <li>
          <button type="button" class="menu-item" data-panel="calendar">
            <span class="menu-icon">ðŸ“…</span>
            <span>Calendar</span>
          </button>
        </li>
        <li>
          <button type="button" class="menu-item" data-panel="streaktopia">
            <span class="menu-icon">ðŸï¸</span>
            <span>StreakTopia</span>
          </button>
        </li>
        <li>
          <button type="button" class="menu-item" data-panel="gamehub">
            <span class="menu-icon">ðŸŽ®</span>
            <span>GameHub</span>
          </button>
        </li>
        <li>
          <button type="button" class="menu-item" data-panel="achievements">
            <span class="menu-icon">ðŸ†</span>
            <span>Achievements</span>
          </button>
        </li>
        <li>
          <button type="button" class="menu-item" data-panel="reminders">
            <span class="menu-icon">ðŸ“§</span>
            <span>Reminders</span>
          </button>
        </li>
        <li>
          <button type="button" class="menu-item" data-panel="stats">
            <span class="menu-icon">ðŸ“Š</span>
            <span>Stats</span>
          </button>
        </li>
        <li>
          <button type="button" class="menu-item" data-panel="settings">
            <span class="menu-icon">âš™ï¸</span>
            <span>Settings</span>
          </button>
        </li>
        <li>
          <button type="button" class="menu-item" data-panel="forParents">
            <span class="menu-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§</span>
            <span>For Parents</span>
          </button>
        </li>
        <li>
          <button type="button" class="menu-item" id="menuExportData">
            <span class="menu-icon">ðŸ“¤</span>
            <span>Export data</span>
          </button>
        </li>
        <li>
          <button type="button" class="menu-item" id="menuImportData">
            <span class="menu-icon">ðŸ“¥</span>
            <span>Import data</span>
          </button>
        </li>
      </ul>
      <div class="menu-drawer-footer">
        <button type="button" id="menuClose">Close menu</button>
      </div>
    </div>
  </div>

  <div id="parentGateOverlay" class="confirm-overlay" aria-hidden="true">
    <div class="confirm-dialog" style="max-width:320px;">
      <h3>ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ Parent verification</h3>
      <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:1rem;">Solve this to access parent settings:</p>
      <p id="parentGateEquation" style="font-size:1.5rem;font-weight:700;text-align:center;margin:1rem 0;font-family:monospace;"></p>
      <input type="number" id="parentGateAnswer" placeholder="Your answer" style="width:100%;padding:0.75rem;font-size:1.1rem;border-radius:8px;border:1px solid var(--border);margin-bottom:0.5rem;" aria-label="Answer">
      <p id="parentGateError" style="color:var(--accent);font-size:0.9rem;margin-bottom:0.5rem;display:none;">Incorrect. Try again.</p>
      <div class="confirm-actions">
        <button type="button" class="btn-cancel" id="parentGateCancel">Cancel</button>
        <button type="button" class="btn-confirm" id="parentGateSubmit">Verify</button>
      </div>
    </div>
  </div>
  <div class="confirm-overlay" id="confirmOverlay" aria-hidden="true">
    <div class="confirm-dialog">
      <h3>Quest complete?</h3>
      <p>Confirm you finished <span class="confirm-task-name" id="confirmTaskName"></span>.</p>
      <div class="confirm-time-row">
        <label for="confirmTimeInput">What time? (optional)</label>
        <input type="time" id="confirmTimeInput" aria-label="Time completed">
      </div>
      <div class="confirm-actions">
        <button type="button" class="btn-cancel" id="confirmCancel">Cancel</button>
        <button type="button" class="btn-confirm" id="confirmYes">Yes, I did it!</button>
      </div>
    </div>
  </div>

  <div id="inAppReminderBanner" class="in-app-reminder-banner" role="alert" style="display: none;">
    <span class="in-app-reminder-text">ðŸ”¥ Time for your quests!</span>
    <button type="button" class="in-app-reminder-dismiss" aria-label="Dismiss">Ã—</button>
  </div>
  <div id="offlineBanner" class="offline-banner" style="display:none;">ðŸ“µ You're offline. Data will sync when connected.</div>
  <div id="onboardingOverlay" class="onboarding-overlay" style="display:none;" aria-hidden="true">
    <div class="onboarding-card">
      <div style="text-align:center;font-size:3rem;margin-bottom:0.5rem;">ðŸ”¥</div>
      <h2 style="margin:0 0 0.5rem 0;text-align:center;">Turn routines into quests</h2>
      <p style="color:var(--text-muted);font-size:0.95rem;margin-bottom:1rem;text-align:center;">Add what you do every day. Complete it. Build streaks. Earn gems. Grow your city.</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:1rem;">
        <div style="padding:0.75rem;background:rgba(239,108,0,0.1);border-radius:8px;text-align:center;">
          <span style="font-size:1.5rem;">ðŸ“‹</span>
          <div style="font-size:0.85rem;font-weight:600;">Add quests</div>
          <div style="font-size:0.8rem;color:var(--text-muted);">Brush teeth, Read, etc.</div>
        </div>
        <div style="padding:0.75rem;background:rgba(239,108,0,0.1);border-radius:8px;text-align:center;">
          <span style="font-size:1.5rem;">ðŸ’Ž</span>
          <div style="font-size:0.85rem;font-weight:600;">Earn gems</div>
          <div style="font-size:0.8rem;color:var(--text-muted);">Build your city</div>
        </div>
      </div>
      <button type="button" id="onboardingGotIt" style="width:100%;padding:0.85rem;background:linear-gradient(180deg,var(--primary) 0%,#f57c00 100%);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;">Start my first quest ðŸš€</button>
    </div>
  </div>

  <div class="gem-bar" id="gemBar">
    <div class="gem-stat">ðŸ’Ž <span id="gemsCount">0</span> gems<span id="luckyDayBadge" class="lucky-day-badge" style="display:none;">2Ã— TODAY!</span></div>
    <div class="saver-stat">ðŸ›¡ï¸ <span id="saversCount">0</span> streak savers</div>
    <button type="button" class="btn-buy-saver" id="buySaverBtn">Buy saver (<span id="saverCost">20</span> ðŸ’Ž)</button>
  </div>

  <section id="panelStreaks" class="panel active">
    <div class="install-prompt-banner" data-install-prompt style="display:none;">
      <span class="install-prompt-text">ðŸ“± Download Streakify for quick access!</span>
      <button type="button" class="install-prompt-btn" data-install-btn>Install</button>
      <button type="button" class="install-prompt-dismiss" data-install-dismiss aria-label="Dismiss">Ã—</button>
    </div>
    <form class="add-form" id="addForm">
      <div style="flex:1;min-width:0;">
        <input type="text" id="taskInput" placeholder="e.g. Brush teeth, Make bed" required>
        <p class="activity-error" id="streakNameError" role="alert"></p>
        <label class="add-form-time-label">What time do you do this every day? <span class="required">*</span></label>
        <input type="time" id="streakTimeInput" class="add-form-time" aria-label="Time you do this every day" required>
      </div>
      <button type="submit">Add</button>
    </form>
    <div id="dailyProgressBanner" class="daily-progress-banner" style="display:none;">
      <div id="dailyGreeting" class="daily-greeting"></div>
      <div id="dailyProgressText" class="daily-progress-text"></div>
      <div class="daily-progress-bar"><div id="dailyProgressFill" class="daily-progress-fill" style="width:0%"></div></div>
      <div id="weeklyGoalBanner" style="margin-top:0.5rem;font-size:0.85rem;color:var(--text-muted);display:none;"></div>
      <div id="dailyTip" style="margin-top:0.75rem;font-size:0.8rem;color:var(--text-dim);font-style:italic;display:none;"></div>
    </div>
    <div id="allDoneBanner" class="daily-progress-banner all-done" style="display:none;">
      <span style="font-size:1.5rem;">ðŸŽ‰</span> <strong>All quests done today!</strong> You're a star!
    </div>
    <div class="quick-add-suggestions" id="quickAddSuggestions">
      <span style="font-size:0.8rem;color:var(--text-dim);align-self:center;margin-right:0.25rem;">Quick add:</span>
    </div>
    <input type="text" id="searchQuests" class="search-quests" placeholder="ðŸ” Search quests..." style="display:none;" aria-label="Search quests">
    <p class="section-title" id="dailyStreaksTitle">Daily quests</p>
    <ul class="streak-list" id="streakList"></ul>
    <p class="section-title" id="todaySectionTitle" style="display: none;">Today&apos;s missions</p>
    <ul class="streak-list" id="todayActivitiesList"></ul>
  </section>

  <section id="panelCalendar" class="panel">
    <div class="install-prompt-banner" data-install-prompt style="display:none;">
      <span class="install-prompt-text">ðŸ“± Download Streakify for quick access!</span>
      <button type="button" class="install-prompt-btn" data-install-btn>Install</button>
      <button type="button" class="install-prompt-dismiss" data-install-dismiss aria-label="Dismiss">Ã—</button>
    </div>
    <div class="calendar-header">
      <button type="button" id="calendarPrev" aria-label="Previous month">â†</button>
      <h2 id="calendarMonthTitle"></h2>
      <button type="button" id="calendarNext" aria-label="Next month">â†’</button>
    </div>
    <div class="calendar-weekdays">
      <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
    <div class="day-view" id="dayView">
      <h3 id="selectedDateLabel"></h3>
      <p class="past-day-msg" id="pastDayMsg" style="display: none;">You can't add activities to past days.</p>
      <form class="add-activity-form" id="addActivityForm" style="display: none;">
        <div class="form-fields">
          <input type="text" id="activityInput" placeholder="Add activity for this day">
          <p class="activity-error" id="activityNameError" role="alert"></p>
          <div class="activity-type">
            <label><input type="radio" name="activityType" value="once" checked> Only once</label>
            <label><input type="radio" name="activityType" value="regular"> Regular</label>
          </div>
          <div class="regular-options" id="regularOptions" style="display: none;">
            <div class="label-text">How often?</div>
            <div class="frequency-row">
              <label><input type="radio" name="frequency" value="daily" checked> Daily</label>
              <label><input type="radio" name="frequency" value="weekly"> Weekly</label>
              <label><input type="radio" name="frequency" value="monthly"> Monthly</label>
            </div>
            <div id="weeklyDaysRow" style="display: none;">
              <div class="label-text">On which days?</div>
              <div class="weekdays-row">
                <label><input type="checkbox" name="weekday" value="0"> Sun</label>
                <label><input type="checkbox" name="weekday" value="1"> Mon</label>
                <label><input type="checkbox" name="weekday" value="2"> Tue</label>
                <label><input type="checkbox" name="weekday" value="3"> Wed</label>
                <label><input type="checkbox" name="weekday" value="4"> Thu</label>
                <label><input type="checkbox" name="weekday" value="5"> Fri</label>
                <label><input type="checkbox" name="weekday" value="6"> Sat</label>
              </div>
            </div>
            <div id="monthlyDaysRow" style="display: none;">
              <div class="label-text">Which days of the month? (e.g. 1, 15, 30)</div>
              <input type="text" class="month-days-input" id="monthDaysInput" placeholder="1, 15, 30">
            </div>
          </div>
        </div>
        <button type="submit">Add</button>
      </form>
      <ul class="day-activities streak-list" id="dayActivitiesList"></ul>
    </div>
  </section>

  <section id="panelAchievements" class="panel">
    <div class="install-prompt-banner" data-install-prompt style="display:none;">
      <span class="install-prompt-text">ðŸ“± Download Streakify for quick access!</span>
      <button type="button" class="install-prompt-btn" data-install-btn>Install</button>
      <button type="button" class="install-prompt-dismiss" data-install-dismiss aria-label="Dismiss">Ã—</button>
    </div>
    <h2 style="font-size:1.25rem;margin:0 0 0.25rem 0;">ðŸ† Achievements</h2>
    <p class="achievements-tagline">Earn badges by building your streaks!</p>
    <div id="weeklyGoal" class="weekly-goal" style="display:none;"></div>
    <div id="achievementsGrid" class="achievements-grid"></div>
    <button type="button" id="shareAchievementBtnMain" style="margin-bottom:1rem;padding:0.6rem 1rem;background:var(--primary);color:#fff;border:none;border-radius:8px;cursor:pointer;">ðŸ“¤ Share my achievements</button>
    <div class="achievements-stickers" id="achievementsStickers">
      <h3 style="font-size:1rem;margin:1rem 0 0.5rem 0;">Sticker board</h3>
      <p style="color:var(--text-muted);font-size:0.9rem;">Tap earned badges to add stickers. Tap stickers to remove.</p>
      <div id="stickerBoard" class="sticker-board"></div>
    </div>
    <div class="parent-rewards" id="parentRewards">
      <h3 style="font-size:1rem;margin:1.5rem 0 0.5rem 0;">ðŸŽ Reward from parent</h3>
      <p style="color:var(--text-muted);font-size:0.9rem;">Parents: Set a reward for completing this week&apos;s goal!</p>
      <input type="text" id="parentRewardInput" placeholder="e.g. 30 min screen time, ice cream" style="width:100%;padding:0.6rem;margin-top:0.5rem;border-radius:8px;border:1px solid var(--border);">
      <button type="button" id="parentRewardSave" style="margin-top:0.5rem;padding:0.5rem 1rem;background:var(--primary);color:#fff;border:none;border-radius:8px;cursor:pointer;">Save reward</button>
    </div>
  </section>

  <section id="panelStreaktopia" class="panel">
    <div class="install-prompt-banner" data-install-prompt style="display:none;">
      <span class="install-prompt-text">ðŸ“± Download Streakify for quick access!</span>
      <button type="button" class="install-prompt-btn" data-install-btn>Install</button>
      <button type="button" class="install-prompt-dismiss" data-install-dismiss aria-label="Dismiss">Ã—</button>
    </div>
    <div class="streaktopia-header">
      <div>
        <h2 style="font-size:1.25rem;margin:0 0 0.25rem 0;"><span id="streaktopiaCityNameDisplay">StreakTopia</span> <span class="city-level" id="streaktopiaCityLevel"></span></h2>
        <p class="streaktopia-tagline">You're the mayor! Build your city with gems. <button type="button" id="streaktopiaEditName" style="background:none;border:none;color:var(--primary);cursor:pointer;font-size:0.85rem;">Edit name</button></p>
      </div>
      <div class="streaktopia-gems-badge" id="streaktopiaGemsBadge">ðŸ’Ž <span id="streaktopiaGemsCount">0</span></div>
    </div>
    <div class="streaktopia-city-wrap">
      <div class="streaktopia-world">
        <div class="streaktopia-sky">
          <div class="streaktopia-cloud" style="top:15%;animation-delay:0s;"></div>
          <div class="streaktopia-cloud" style="top:25%;animation-delay:-8s;animation-duration:30s;"></div>
          <div class="streaktopia-cloud" style="top:8%;animation-delay:-15s;animation-duration:35s;"></div>
          <div id="streaktopiaBirds" class="streaktopia-birds-layer"></div>
          <div id="streaktopiaParticles" class="streaktopia-particles-layer"></div>
        </div>
        <div class="streaktopia-horizon"></div>
        <div class="streaktopia-scene">
          <div class="streaktopia-ground"></div>
          <div class="streaktopia-city" id="streaktopiaCity">
            <div class="streaktopia-buildings-row" id="streaktopiaBuildings"></div>
            <div class="streaktopia-citizens-layer" id="streaktopiaCitizensLayer"></div>
            <div class="streaktopia-pet" id="streaktopiaPet" title="Your companion!"></div>
            <div class="streaktopia-player" id="streaktopiaPlayer" title="That's you!"></div>
            <div class="streaktopia-decorations" id="streaktopiaDecorations"></div>
          </div>
        </div>
        <div class="streaktopia-fog"></div>
        <div class="streaktopia-vignette"></div>
      </div>
      <div class="streaktopia-happiness" id="streaktopiaHappiness">
        <span id="streaktopiaHappinessEmoji"></span>
        <span class="streaktopia-happiness-label" id="streaktopiaHappinessLabel"></span>
        <div class="streaktopia-happiness-bar" id="streaktopiaHappinessBar"><div class="streaktopia-happiness-fill" id="streaktopiaHappinessFill"></div></div>
      </div>
    </div>
    <div class="streaktopia-stats" id="streaktopiaStats">
      <span class="streaktopia-stat"><span id="streaktopiaStatBuildings">0</span> buildings</span>
      <span class="streaktopia-stat"><span id="streaktopiaStatCitizens">0</span> flame citizens</span>
    </div>
    <div class="streaktopia-citizens">
      <div class="streaktopia-citizens-title">Flame citizens</div>
      <div id="streaktopiaCitizens"><span class="streaktopia-citizen-count" id="streaktopiaCitizenCount">Keep streaks to grow your flame citizens.</span></div>
    </div>
    <div class="streaktopia-quests" id="streaktopiaQuests">
      <div class="streaktopia-quests-title">ðŸ† City quests</div>
      <p class="streaktopia-quests-hint">Complete quests to earn bonus gems. Tap buildings for info, flame citizens for their streak!</p>
      <div id="streaktopiaQuestsList"></div>
    </div>
    <div class="streaktopia-shop">
      <div class="streaktopia-shop-title">Build with gems</div>
      <div id="streaktopiaShop"></div>
    </div>
  </section>

  <section id="panelSettings" class="panel">
    <div class="install-prompt-banner" data-install-prompt style="display:none;">
      <span class="install-prompt-text">ðŸ“± Download Streakify for quick access!</span>
      <button type="button" class="install-prompt-btn" data-install-btn>Install</button>
      <button type="button" class="install-prompt-dismiss" data-install-dismiss aria-label="Dismiss">Ã—</button>
    </div>
    <h2 style="font-size:1.25rem;margin:0 0 0.25rem 0;">âš™ï¸ Settings</h2>
    <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:1rem;">Customize your experience</p>
    <label class="settings-row" style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;">
      <input type="checkbox" id="soundsCheck" checked>
      <span>Sound effects when completing quests</span>
    </label>
    <label class="settings-row" style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;">
      <input type="checkbox" id="hideCompletedCheck">
      <span>Hide completed quests (focus mode)</span>
    </label>
    <div class="settings-row" style="margin-bottom:1rem;">
      <button type="button" id="requestNotificationBtn" style="padding:0.5rem 1rem;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;cursor:pointer;">ðŸ”” Enable notifications</button>
      <span style="font-size:0.85rem;color:var(--text-muted);margin-left:0.5rem;">For reminder alerts</span>
    </div>
    <div class="settings-themes" style="margin-top:1rem;">
      <h3 style="font-size:1rem;margin-bottom:0.5rem;">Theme</h3>
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
        <button type="button" class="theme-btn" data-theme="default">Default</button>
        <button type="button" class="theme-btn" data-theme="ocean">Ocean</button>
        <button type="button" class="theme-btn" data-theme="forest">Forest</button>
        <button type="button" class="theme-btn" data-theme="space">Space</button>
      </div>
    </div>
  </section>

  <section id="panelReminders" class="panel">
    <div class="install-prompt-banner" data-install-prompt style="display:none;">
      <span class="install-prompt-text">ðŸ“± Download Streakify for quick access!</span>
      <button type="button" class="install-prompt-btn" data-install-btn>Install</button>
      <button type="button" class="install-prompt-dismiss" data-install-dismiss aria-label="Dismiss">Ã—</button>
    </div>
    <h2 style="font-size:1.25rem;margin:0 0 0.5rem 0;">Email reminders</h2>
    <p class="reminders-tagline">Get a daily email at your chosen time so you don't forget to do your streaks.</p>
    <form id="reminderForm" class="reminder-form">
      <label for="reminderEmail">Email address</label>
      <input type="email" id="reminderEmail" placeholder="you@example.com" autocomplete="email">
      <label for="reminderTime">Remind me every day at</label>
      <input type="time" id="reminderTime" aria-label="Daily reminder time" value="09:00">
      <label class="reminder-checkbox-label">
        <input type="checkbox" id="reminderInApp" checked>
        Show notification in Streakify when it's time
      </label>
      <button type="submit" class="btn-save-reminder">Save reminder</button>
    </form>
    <p id="reminderSavedMsg" class="reminder-saved-msg" role="status" aria-live="polite" style="display:none;">Saved. You'll get a reminder at this time.</p>
    <p class="reminder-note">Reminders are saved on this device. To receive real emails at this time, this app needs to be connected to a reminder service (e.g. a small backend).</p>
  </section>

  <section id="panelGamehub" class="panel">
    <div class="install-prompt-banner" data-install-prompt style="display:none;">
      <span class="install-prompt-text">ðŸ“± Download Streakify for quick access!</span>
      <button type="button" class="install-prompt-btn" data-install-btn>Install</button>
      <button type="button" class="install-prompt-dismiss" data-install-dismiss aria-label="Dismiss">Ã—</button>
    </div>
    <div class="gamehub-header">
      <h2 class="gamehub-title">ðŸŽ® GameHub</h2>
      <p class="gamehub-tagline">Complete all due streaks and today&apos;s activities to unlock games!</p>
    </div>
    <div id="gamehubLocked" class="gamehub-locked">
      <div class="gamehub-locked-icon">ðŸ”’</div>
      <p class="gamehub-locked-msg">Finish streaks due by now and today&apos;s activities to unlock.</p>
      <p class="gamehub-progress" id="gamehubProgress"></p>
    </div>
    <div id="gamehubUnlocked" class="gamehub-unlocked" style="display:none;">
      <p class="gamehub-unlocked-msg">ðŸŽ‰ All done! Pick a game:</p>
      <div class="gamehub-games" id="gamehubGamesGrid"></div>
    </div>
    <div id="gamehubPlayArea" class="gamehub-play-area" style="display:none;">
      <button type="button" class="gamehub-back" id="gamehubBack">â† Back to games</button>
      <div id="gamehubGameContent"></div>
    </div>
  </section>

  <section id="panelStats" class="panel">
    <div class="install-prompt-banner" data-install-prompt style="display:none;">
      <span class="install-prompt-text">ðŸ“± Download Streakify for quick access!</span>
      <button type="button" class="install-prompt-btn" data-install-btn>Install</button>
      <button type="button" class="install-prompt-dismiss" data-install-dismiss aria-label="Dismiss">Ã—</button>
    </div>
    <h2 style="font-size:1.25rem;margin:0 0 0.5rem 0;">ðŸ“Š Stats</h2>
    <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:1rem;">Your progress at a glance</p>
    <div class="stats-panel">
      <div id="statsGrid" class="stats-grid"></div>
      <h3 style="font-size:1rem;margin:1rem 0 0.5rem 0;">Activity (last 28 days)</h3>
      <div id="streakHeatmap" class="heatmap-grid"></div>
      <button type="button" id="shareAchievementBtn" style="margin-top:1rem;padding:0.6rem 1rem;background:var(--primary);color:#fff;border:none;border-radius:8px;cursor:pointer;">ðŸ“¤ Share my progress</button>
    </div>
  </section>

  <section id="panelForParents" class="panel">
    <div class="install-prompt-banner" data-install-prompt style="display:none;">
      <span class="install-prompt-text">ðŸ“± Download Streakify for quick access!</span>
      <button type="button" class="install-prompt-btn" data-install-btn>Install</button>
      <button type="button" class="install-prompt-dismiss" data-install-dismiss aria-label="Dismiss">Ã—</button>
    </div>
    <h2 style="font-size:1.25rem;margin:0 0 0.5rem 0;">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ For Parents</h2>
    <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:1rem;">Customize rewards and badges for your child</p>
    <div class="for-parents-section">
      <h3 style="font-size:1rem;margin:0 0 0.5rem 0;">ðŸŽ¯ Weekly goal target</h3>
      <p style="color:var(--text-muted);font-size:0.9rem;">How many quests should they complete this week?</p>
      <input type="number" id="weeklyGoalTargetInput" min="1" max="20" value="5" style="width:80px;padding:0.6rem;margin-top:0.5rem;border-radius:8px;border:1px solid var(--border);">
      <button type="button" id="weeklyGoalTargetSave" style="margin-left:0.5rem;padding:0.5rem 1rem;background:var(--primary);color:#fff;border:none;border-radius:8px;cursor:pointer;">Save</button>
      <h3 style="font-size:1rem;margin:1.5rem 0 0.5rem 0;">ðŸŽ Reward for this week</h3>
      <p style="color:var(--text-muted);font-size:0.9rem;">Set a reward for completing this week&apos;s goal!</p>
      <input type="text" id="parentRewardInputForParents" placeholder="e.g. 30 min screen time, ice cream" style="width:100%;padding:0.6rem;margin-top:0.5rem;border-radius:8px;border:1px solid var(--border);">
      <button type="button" id="parentRewardSaveForParents" style="margin-top:0.5rem;padding:0.5rem 1rem;background:var(--primary);color:#fff;border:none;border-radius:8px;cursor:pointer;">Save reward</button>
      <h3 style="font-size:1rem;margin:1.5rem 0 0.5rem 0;">ðŸ… Add custom badge</h3>
      <p style="color:var(--text-muted);font-size:0.9rem;">Create custom badges that appear in Achievements.</p>
      <input type="text" id="customBadgeInput" placeholder="Badge name (e.g. Clean room)" style="width:100%;padding:0.6rem;margin-top:0.5rem;border-radius:8px;border:1px solid var(--border);">
      <button type="button" id="customBadgeSave" style="margin-top:0.5rem;padding:0.5rem 1rem;background:var(--primary);color:#fff;border:none;border-radius:8px;cursor:pointer;">Add badge</button>
    </div>
  </section>

  <script>
    const STORAGE_KEY = 'streaks-data';
    const CALENDAR_KEY = 'streaks-calendar';
    const GEM_STORAGE_KEY = 'streaks-gem-data';
    const STREAKTOPIA_KEY = 'streaks-streaktopia';
    const ACHIEVEMENTS_KEY = 'streaks-achievements';
    const WEEKLY_GOAL_KEY = 'streaks-weekly-goal';
    const PARENT_REWARD_KEY = 'streaks-parent-reward';
    const SETTINGS_KEY = 'streaks-settings';
    const REMINDER_KEY = 'streaks-reminder';
    const DAILY_BONUS_KEY = 'streaks-daily-bonus';
    const STATS_KEY = 'streaks-stats';
    const STREAK_FREEZE_KEY = 'streaks-freeze';
    const CUSTOM_BADGES_KEY = 'streaks-custom-badges';
    const INSTALL_PROMPT_KEY = 'streaks-install-dismissed';
    const STREAKTOPIA_DAILY_VISIT_KEY = 'streaks-streaktopia-daily-visit';
    const STREAKTOPIA_QUESTS_KEY = 'streaks-streaktopia-quests';
    const ONBOARDING_SEEN_KEY = 'streaks-onboarding-seen';
    const WEEKLY_GOAL_TARGET_KEY = 'streaks-weekly-goal-target';
    const LAST_BACKUP_REMINDER_KEY = 'streaks-last-backup-reminder';
    function loadSettings() {
      try {
        const raw = localStorage.getItem(SETTINGS_KEY);
        const d = raw ? JSON.parse(raw) : {};
        return {
          sounds: d.sounds !== false,
          theme: d.theme || 'default',
          darkMode: d.darkMode === true,
          hideCompleted: d.hideCompleted === true
        };
      } catch { return { sounds: true, theme: 'default', darkMode: false, hideCompleted: false }; }
    }
    function saveSettings(s) { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
    function playSuccessSound() {
      if (!loadSettings().sounds) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.setValueAtTime(523.25, ctx.currentTime);
        osc.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1);
        osc.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2);
        gain.gain.setValueAtTime(0.15, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.3);
      } catch (e) {}
    }
    const GEMS_PER_COMPLETION = 5;
    const STREAK_SAVER_COST = 20;

    const GAMEHUB_GAMES = [
      { id: 'reaction', emoji: 'âš¡', name: 'Reaction', desc: 'Click when green', gradient: 'linear-gradient(135deg, #43a047 0%, #66bb6a 100%)' },
      { id: 'tap', emoji: 'ðŸ‘†', name: 'Tap Race', desc: 'Tap 10x fast', gradient: 'linear-gradient(135deg, #e53935 0%, #ff5722 100%)' },
      { id: 'memory', emoji: 'ðŸ§ ', name: 'Memory', desc: 'Find pairs', gradient: 'linear-gradient(135deg, #7e57c2 0%, #ab47bc 100%)' },
      { id: 'snake', emoji: 'ðŸ', name: 'Snake', desc: 'Eat & grow', gradient: 'linear-gradient(135deg, #00897b 0%, #26a69a 100%)' },
      { id: 'whack', emoji: 'ðŸ”¨', name: 'Whack', desc: 'Tap the moles!', gradient: 'linear-gradient(135deg, #5d4037 0%, #8d6e63 100%)' },
      { id: 'typing', emoji: 'âŒ¨ï¸', name: 'Typing', desc: 'Type the word', gradient: 'linear-gradient(135deg, #1565c0 0%, #42a5f5 100%)' },
      { id: 'color', emoji: 'ðŸŽ¨', name: 'Color Match', desc: 'Click when it matches', gradient: 'linear-gradient(135deg, #c62828 0%, #ef5350 100%)' },
      { id: 'number', emoji: 'ðŸ”¢', name: 'Number Chain', desc: 'Tap 1 to 10', gradient: 'linear-gradient(135deg, #f9a825 0%, #ffca28 100%)' },
      { id: 'simon', emoji: 'ðŸ”´', name: 'Simon', desc: 'Repeat the sequence', gradient: 'linear-gradient(135deg, #2e7d32 0%, #4caf50 50%, #81c784 100%)' },
      { id: 'breakout', emoji: 'ðŸ§±', name: 'Breakout', desc: 'Break the bricks', gradient: 'linear-gradient(135deg, #6a1b9a 0%, #9c27b0 100%)' },
      { id: 'trivia', emoji: 'â“', name: 'Trivia', desc: 'Answer 5 questions', gradient: 'linear-gradient(135deg, #37474f 0%, #607d8b 100%)' },
      { id: 'dice', emoji: 'ðŸŽ²', name: 'Dice Roll', desc: 'Roll higher than 4', gradient: 'linear-gradient(135deg, #455a64 0%, #78909c 100%)' },
      { id: 'rps', emoji: 'âœŠ', name: 'Rock Paper Scissors', desc: 'Beat the computer', gradient: 'linear-gradient(135deg, #5d4037 0%, #a1887f 100%)' },
      { id: 'higher', emoji: 'ðŸ“ˆ', name: 'Higher or Lower', desc: 'Guess the next number', gradient: 'linear-gradient(135deg, #1b5e20 0%, #4caf50 100%)' },
      { id: 'tictactoe', emoji: 'â­•', name: 'Tic-Tac-Toe', desc: 'Get 3 in a row', gradient: 'linear-gradient(135deg, #0d47a1 0%, #1976d2 100%)' },
      { id: 'hangman', emoji: 'ðŸª¢', name: 'Hangman', desc: 'Guess the word', gradient: 'linear-gradient(135deg, #4a148c 0%, #7b1fa2 100%)' },
      { id: 'mathquiz', emoji: 'âž•', name: 'Math Quiz', desc: 'Solve 5 problems', gradient: 'linear-gradient(135deg, #e65100 0%, #ff9800 100%)' },
      { id: 'catch', emoji: 'ðŸŽ', name: 'Catch', desc: 'Catch falling fruit', gradient: 'linear-gradient(135deg, #2e7d32 0%, #66bb6a 100%)' },
      { id: 'flappy', emoji: 'ðŸ¦', name: 'Flappy', desc: 'Tap to fly', gradient: 'linear-gradient(135deg, #0288d1 0%, #03a9f4 100%)' },
      { id: 'wordscramble', emoji: 'ðŸ”¤', name: 'Word Scramble', desc: 'Unscramble the word', gradient: 'linear-gradient(135deg, #5e35b1 0%, #9575cd 100%)' },
      { id: 'pong', emoji: 'ðŸ“', name: 'Pong', desc: 'Bounce the ball', gradient: 'linear-gradient(135deg, #1565c0 0%, #42a5f5 100%)' },
      { id: 'target', emoji: 'ðŸŽ¯', name: 'Target', desc: 'Hit 10 targets fast', gradient: 'linear-gradient(135deg, #c62828 0%, #ef5350 100%)' },
      { id: 'minesweeper', emoji: 'ðŸ’£', name: 'Minesweeper', desc: 'Avoid the mines', gradient: 'linear-gradient(135deg, #37474f 0%, #78909c 100%)' },
      { id: 'puzzle', emoji: 'ðŸ§©', name: 'Slide Puzzle', desc: 'Arrange the tiles', gradient: 'linear-gradient(135deg, #6a1b9a 0%, #ab47bc 100%)' },
      { id: 'tetris', emoji: 'ðŸ“¦', name: 'Tetris', desc: 'Stack the blocks', gradient: 'linear-gradient(135deg, #1565c0 0%, #42a5f5 50%, #29b6f6 100%)' },
      { id: 'coinflip', emoji: 'ðŸª™', name: 'Coin Flip', desc: 'Heads or tails', gradient: 'linear-gradient(135deg, #ffd54f 0%, #ffb300 100%)' },
      { id: 'blackjack', emoji: 'ðŸƒ', name: 'Blackjack', desc: 'Get 21 or close', gradient: 'linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%)' },
      { id: 'oddone', emoji: 'ðŸ‘ï¸', name: 'Odd One Out', desc: 'Find the different one', gradient: 'linear-gradient(135deg, #009688 0%, #4db6ac 100%)' },
      { id: 'lightsout', emoji: 'ðŸ’¡', name: 'Lights Out', desc: 'Turn all lights off', gradient: 'linear-gradient(135deg, #ffc107 0%, #ffeb3b 100%)' },
      { id: 'dodge', emoji: 'ðŸƒ', name: 'Dodge', desc: 'Avoid obstacles 10s', gradient: 'linear-gradient(135deg, #d32f2f 0%, #f44336 100%)' },
      { id: 'spaceshooter', emoji: 'ðŸš€', name: 'Space Shooter', desc: 'Shoot the aliens', gradient: 'linear-gradient(135deg, #0d47a1 0%, #1976d2 100%)' },
      { id: 'catchletters', emoji: 'ðŸ”¤', name: 'Catch Letters', desc: 'Catch the right letter', gradient: 'linear-gradient(135deg, #5e35b1 0%, #7e57c2 100%)' },
      { id: 'bounce', emoji: 'ðŸ€', name: 'Bounce', desc: 'Bounce 15 times', gradient: 'linear-gradient(135deg, #c62828 0%, #ef5350 100%)' },
      { id: 'maze', emoji: 'ðŸ—ºï¸', name: 'Maze', desc: 'Reach the exit', gradient: 'linear-gradient(135deg, #455a64 0%, #78909c 100%)' },
      { id: 'guess', emoji: 'ðŸŽ¯', name: 'Guess Number', desc: 'Guess 1-100 in 7 tries', gradient: 'linear-gradient(135deg, #558b2f 0%, #7cb342 100%)' },
      { id: 'game2048', emoji: 'ðŸ”¢', name: '2048', desc: 'Merge tiles to 2048', gradient: 'linear-gradient(135deg, #ff6f00 0%, #ffab40 100%)' },
      { id: 'sumten', emoji: 'âž•', name: 'Sum to 10', desc: 'Tap numbers that add to 10', gradient: 'linear-gradient(135deg, #7b1fa2 0%, #ba68c8 100%)' },
      { id: 'connect4', emoji: 'ðŸ”´', name: 'Connect 4', desc: 'Get 4 in a row', gradient: 'linear-gradient(135deg, #c62828 0%, #ef5350 100%)' },
      { id: 'anagrams', emoji: 'ðŸ“', name: 'Anagrams', desc: 'Unscramble the word', gradient: 'linear-gradient(135deg, #00838f 0%, #26c6da 100%)' },
      { id: 'truefalse', emoji: 'âœ“', name: 'True or False', desc: '5 quick questions', gradient: 'linear-gradient(135deg, #2e7d32 0%, #66bb6a 100%)' },
      { id: 'splat', emoji: 'ðŸª²', name: 'Splat', desc: 'Squash 15 bugs', gradient: 'linear-gradient(135deg, #4e342e 0%, #8d6e63 100%)' },
      { id: 'spinner', emoji: 'ðŸŽ¡', name: 'Spinner', desc: 'Spin to win', gradient: 'linear-gradient(135deg, #e91e63 0%, #f48fb1 100%)' },
      { id: 'treasure', emoji: 'ðŸ’Ž', name: 'Treasure Hunt', desc: 'Find the treasure', gradient: 'linear-gradient(135deg, #ffd700 0%, #ffb300 100%)' },
      { id: 'wordchain', emoji: 'ðŸ”—', name: 'Word Chain', desc: 'Chain 5 words', gradient: 'linear-gradient(135deg, #1565c0 0%, #42a5f5 100%)' },
      { id: 'fruitninja', emoji: 'ðŸ‰', name: 'Fruit Ninja', desc: 'Slice 10 fruit', gradient: 'linear-gradient(135deg, #e65100 0%, #ff9800 100%)' },
      { id: 'guess', emoji: 'ðŸŽ¯', name: 'Guess Number', desc: 'Guess 1-100 in 7 tries', gradient: 'linear-gradient(135deg, #558b2f 0%, #7cb342 100%)' }
    ];

    const ACHIEVEMENT_BADGES = [
      { id: 'week', emoji: 'â­', label: 'Week Warrior', req: 7, sticker: 'â­' },
      { id: 'month', emoji: 'ðŸ†', label: 'Month Master', req: 30, sticker: 'ðŸ†' },
      { id: 'hundred', emoji: 'ðŸ‘‘', label: 'Century Champion', req: 100, sticker: 'ðŸ‘‘' },
      { id: 'first', emoji: 'ðŸŒ±', label: 'First Step', req: 1, sticker: 'ðŸŒ±' },
      { id: 'ten', emoji: 'ðŸ”¥', label: 'On Fire', req: 10, sticker: 'ðŸ”¥' },
      { id: 'twoweek', emoji: 'ðŸ’ª', label: 'Two Week Hero', req: 14, sticker: 'ðŸ’ª' },
      { id: 'fifty', emoji: 'ðŸŒŸ', label: 'Fifty Day Star', req: 50, sticker: 'ðŸŒŸ' },
      { id: 'earlybird', emoji: 'ðŸ¦', label: 'Early Bird', req: 3, sticker: 'ðŸ¦' }
    ];
    const QUICK_ADD_ACTIVITIES = [
      { name: 'Brush teeth', time: '07:30' },
      { name: 'Make bed', time: '07:00' },
      { name: 'Read', time: '20:00' },
      { name: 'Exercise', time: '08:00' },
      { name: 'Practice instrument', time: '16:00' },
      { name: 'Homework', time: '17:00' },
      { name: 'Chores', time: '18:00' },
      { name: 'Meditate', time: '07:15' },
      { name: 'Drink water', time: '08:00' },
      { name: 'Take vitamins', time: '08:30' }
    ];
    const ENCOURAGEMENT_MSGS = ['You\'re on fire! ðŸ”¥', 'Quest champion! â­', 'Amazing! Keep it up! ðŸŒŸ', 'You did it! ðŸŽ‰', 'Streak superstar! âœ¨', 'Another one done! ðŸ’ª', 'So proud of you! ðŸ†', 'You\'re crushing it! ðŸš€', 'Nice work! ðŸŒˆ', 'Keep going! ðŸŽ¯', 'You\'re unstoppable! ðŸ’«', 'Fantastic! ðŸ…'];
    const MILESTONE_MESSAGES = { 7: 'ðŸŒŸ Week Warrior! 7 days strong!', 14: 'ðŸ’ª Two weeks! You\'re a hero!', 30: 'ðŸ† Month Master! Incredible!', 50: 'ðŸŒŸ Fifty days! You\'re a star!', 100: 'ðŸ‘‘ Century Champion! Legendary!' };
    const GREETINGS = { morning: ['Good morning! â˜€ï¸', 'Rise and shine! ðŸŒ…', 'Morning, champion! â˜€ï¸'], afternoon: ['Hey there! ðŸ‘‹', 'Keep it up! ðŸ’ª', 'You\'ve got this! âœ¨'], evening: ['Good evening! ðŸŒ™', 'Almost there! ðŸŒŸ', 'Finish strong! ðŸ’«'] };
    const DAILY_TIPS = ['Small steps add up! Completing one quest builds momentum.', 'Set a consistent time for each quest to build strong habits.', 'Use streak savers wiselyâ€”they\'re there when life gets busy!', 'Visit StreakTopia to see your city grow with every quest.', 'Reach 5 quests this week to unlock your parent\'s reward!', 'The best streak is the one you\'re building right now.', 'Celebrate small winsâ€”they lead to big changes!', 'Build your city in StreakTopia with gems from completed quests.'];
    const QUEST_EMOJIS = ['ðŸ”¥','ðŸŽ¯','ðŸ“š','ðŸ’ª','ðŸƒ','ðŸ§¹','ðŸª¥','ðŸ›ï¸','ðŸ“–','ðŸŽµ','ðŸŽ¨','ðŸ’§','ðŸ’Š','ðŸ§˜','ðŸ ','ðŸ“'];
    const STREAKTOPIA_BUILDINGS = [
      { id: 'house', emoji: 'ðŸ ', name: 'House', cost: 10, desc: 'A cozy home where your flame citizens rest. Each house welcomes more streaks!' },
      { id: 'fountain', emoji: 'â›²', name: 'Fountain', cost: 25, desc: 'Citizens gather here to relax and share their streak stories. The sound of water soothes the soul.' },
      { id: 'tower', emoji: 'ðŸ°', name: 'Tower', cost: 50, desc: 'The pride of your city! A landmark that inspires citizens to reach new heights.' },
      { id: 'tree', emoji: 'ðŸŒ³', name: 'Tree', cost: 15, desc: 'Adds shade and greenery. Citizens love resting under its branches.' },
      { id: 'lamp', emoji: 'ðŸª”', name: 'Lamp', cost: 8, desc: 'Lights up the streets at night. Keeps your flame citizens safe and visible.' },
      { id: 'garden', emoji: 'ðŸŒ¸', name: 'Garden', cost: 18, desc: 'Flowers make everyone smile. A burst of color that boosts citizen happiness.' },
      { id: 'market', emoji: 'ðŸª', name: 'Market', cost: 35, desc: 'Where citizens trade gems and celebrate their progress. The heart of commerce!' },
      { id: 'park', emoji: 'ðŸžï¸', name: 'Park', cost: 30, desc: 'A green oasis for play and reflection. Citizens recharge their flames here.' },
      { id: 'library', emoji: 'ðŸ“š', name: 'Library', cost: 45, desc: 'Knowledge fuels growth. Citizens study habits and share wisdom.' },
      { id: 'statue', emoji: 'ðŸ—½', name: 'Statue', cost: 60, desc: 'A monument to your dedication. Inspires everyone to keep their streaks burning.' }
    ];

    let calendarCurrent = new Date();
    let calendarSelected = null; // YYYY-MM-DD or null

    function loadStreaks() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveStreaks(streaks) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(streaks));
    }

    function loadGemData() {
      try {
        const raw = localStorage.getItem(GEM_STORAGE_KEY);
        const data = raw ? JSON.parse(raw) : {};
        return {
          gems: typeof data.gems === 'number' ? data.gems : 0,
          streakSavers: typeof data.streakSavers === 'number' ? data.streakSavers : 0,
          totalQuestsCompleted: typeof data.totalQuestsCompleted === 'number' ? data.totalQuestsCompleted : 0,
          bestStreak: typeof data.bestStreak === 'number' ? data.bestStreak : 0
        };
      } catch {
        return { gems: 0, streakSavers: 0, totalQuestsCompleted: 0, bestStreak: 0 };
      }
    }

    function saveGemData(data) {
      localStorage.setItem(GEM_STORAGE_KEY, JSON.stringify(data));
    }

    function loadStreaktopia() {
      try {
        const raw = localStorage.getItem(STREAKTOPIA_KEY);
        const data = raw ? JSON.parse(raw) : {};
        return Array.isArray(data.buildings) ? data.buildings : [];
      } catch {
        return [];
      }
    }

    function loadStreaktopiaMeta() {
      try {
        const raw = localStorage.getItem(STREAKTOPIA_KEY);
        const data = raw ? JSON.parse(raw) : {};
        return { cityName: data.cityName || '', mayorEmoji: data.mayorEmoji || 'ðŸ§‘' };
      } catch { return { cityName: '', mayorEmoji: 'ðŸ§‘' }; }
    }
    function saveStreaktopia(buildings, meta) {
      const existing = (() => { try { const r = localStorage.getItem(STREAKTOPIA_KEY); return r ? JSON.parse(r) : {}; } catch { return {}; } })();
      localStorage.setItem(STREAKTOPIA_KEY, JSON.stringify({
        buildings: Array.isArray(buildings) ? buildings : (existing.buildings || []),
        cityName: meta && meta.cityName !== undefined ? meta.cityName : (existing.cityName || ''),
        mayorEmoji: meta && meta.mayorEmoji !== undefined ? meta.mayorEmoji : (existing.mayorEmoji || 'ðŸ§‘')
      }));
    }

    function loadReminderSettings() {
      try {
        const raw = localStorage.getItem(REMINDER_KEY);
        const data = raw ? JSON.parse(raw) : {};
        return {
          email: typeof data.email === 'string' ? data.email.trim() : '',
          time: typeof data.time === 'string' ? data.time : '09:00',
          inApp: data.inApp !== false
        };
      } catch {
        return { email: '', time: '09:00', inApp: true };
      }
    }

    const REMINDER_LAST_SHOWN_KEY = 'streaks-reminder-last-shown';

    function shouldShowInAppReminderNow() {
      const s = loadReminderSettings();
      if (!s.inApp || !s.time) return false;
      const today = new Date().toDateString();
      const lastShown = localStorage.getItem(REMINDER_LAST_SHOWN_KEY);
      if (lastShown === today) return false;
      const [h, m] = s.time.split(':').map(Number);
      const reminderMins = (h || 0) * 60 + (m || 0);
      const now = new Date();
      const nowMins = now.getHours() * 60 + now.getMinutes();
      return nowMins >= reminderMins;
    }

    function showInAppReminder() {
      const banner = document.getElementById('inAppReminderBanner');
      if (!banner) return;
      banner.style.display = 'flex';
      try {
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Streakify', { body: 'Time for your quests! Build your streak! ðŸ”¥', icon: 'ðŸ”¥' });
        }
      } catch (e) {}
    }

    function dismissInAppReminder() {
      const banner = document.getElementById('inAppReminderBanner');
      if (banner) banner.style.display = 'none';
      localStorage.setItem(REMINDER_LAST_SHOWN_KEY, new Date().toDateString());
    }

    function checkReminderNotification() {
      if (!shouldShowInAppReminderNow()) return;
      showInAppReminder();
      localStorage.setItem(REMINDER_LAST_SHOWN_KEY, new Date().toDateString());
    }

    function saveReminderSettings(data) {
      localStorage.setItem(REMINDER_KEY, JSON.stringify(data));
    }

    function renderReminders() {
      const s = loadReminderSettings();
      const emailEl = document.getElementById('reminderEmail');
      const timeEl = document.getElementById('reminderTime');
      const inAppEl = document.getElementById('reminderInApp');
      const msgEl = document.getElementById('reminderSavedMsg');
      if (emailEl) emailEl.value = s.email;
      if (timeEl) timeEl.value = s.time;
      if (inAppEl) inAppEl.checked = s.inApp;
      if (msgEl) msgEl.style.display = 'none';
    }

    function todayStr() {
      return new Date().toDateString();
    }

    function showConfetti() {
      const colors = ['#ef6c00','#ff9800','#f9a825','#43a047','#e53935'];
      const container = document.createElement('div');
      container.className = 'confetti-container';
      container.style.cssText = 'position:fixed;inset:0;pointer-events:none;z-index:9999;';
      document.body.appendChild(container);
      for (let i = 0; i < 50; i++) {
        const p = document.createElement('div');
        p.style.cssText = `position:absolute;left:50%;top:50%;width:8px;height:8px;background:${colors[i%colors.length]};border-radius:2px;animation:confettiFall ${1.5+Math.random()}s ease-out forwards;--tx:${(Math.random()-0.5)*400}px;--ty:${150+Math.random()*200}px;`;
        container.appendChild(p);
      }
      setTimeout(() => container.remove(), 3000);
    }
    function showEncouragementToast() {
      const msg = ENCOURAGEMENT_MSGS[Math.floor(Math.random() * ENCOURAGEMENT_MSGS.length)];
      const toast = document.createElement('div');
      toast.className = 'streaktopia-toast';
      toast.style.cssText = 'bottom:auto;top:4rem;left:50%;transform:translateX(-50%);';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }
    function markDone(id, userTime, backdateYesterday) {
      const streaks = loadStreaks();
      const item = streaks.find(s => s.id === id);
      if (!item) return;

      const today = todayStr();
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.toDateString();
      const dayBefore = new Date();
      dayBefore.setDate(dayBefore.getDate() - 2);
      const dayBeforeStr = dayBefore.toDateString();

      if (item.lastDone === today) return; // already done today

      const useYesterday = backdateYesterday && item.lastDone !== yesterdayStr;
      const targetDate = useYesterday ? yesterdayStr : today;

      let newStreak;
      if (useYesterday) {
        if (item.lastDone === dayBeforeStr) {
          item.streak += 1;
          newStreak = item.streak;
        } else {
          item.streak = 1;
          newStreak = 1;
        }
      } else if (item.lastDone === yesterdayStr) {
        item.streak += 1;
        newStreak = item.streak;
      } else {
        item.streak = 1;
        newStreak = 1;
      }
      item.lastDone = targetDate;
      item.lastDoneTime = (userTime && /^\d{1,2}:\d{2}$/.test(userTime))
        ? (() => { const d = new Date(); const [h, m] = userTime.split(':').map(Number); d.setHours(h, m, 0, 0); return d.toISOString(); })()
        : new Date().toISOString();
      saveStreaks(streaks);

      const gemData = loadGemData();
      let gemsEarned = GEMS_PER_COMPLETION;
      const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
      const isLuckyDay = dayOfYear % 7 === 3;
      if (isLuckyDay) gemsEarned *= 2;
      gemData.gems += gemsEarned;
      gemData.totalQuestsCompleted = (gemData.totalQuestsCompleted || 0) + 1;
      gemData.bestStreak = Math.max(gemData.bestStreak || 0, getMaxStreak());
      saveGemData(gemData);

      if ([7, 14, 30, 50, 100].includes(newStreak)) {
        showConfetti();
        const msg = MILESTONE_MESSAGES[newStreak];
        if (msg) {
          const toast = document.createElement('div');
          toast.className = 'streaktopia-toast milestone-toast';
          toast.style.cssText = 'bottom:auto;top:4rem;left:50%;transform:translateX(-50%);';
          toast.textContent = msg;
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3500);
        }
      } else {
        showEncouragementToast();
      }

      render();
    }

    function useStreakSaver(id) {
      const streaks = loadStreaks();
      const item = streaks.find(s => s.id === id);
      if (!item || item.streak <= 0) return;

      const today = todayStr();
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.toDateString();
      if (item.lastDone === today) return;
      if (item.lastDone === yesterday) return;

      const gemData = loadGemData();
      if (gemData.streakSavers <= 0) return;

      item.lastDone = today;
      gemData.streakSavers -= 1;
      saveStreaks(streaks);
      saveGemData(gemData);
      render();
    }

    function buyStreakSaver() {
      const gemData = loadGemData();
      if (gemData.gems < STREAK_SAVER_COST) return;
      gemData.gems -= STREAK_SAVER_COST;
      gemData.streakSavers += 1;
      saveGemData(gemData);
      render();
    }

    function deleteStreak(id) {
      const streaks = loadStreaks().filter(s => s.id !== id);
      saveStreaks(streaks);
      render();
    }
    function editStreak(id) {
      const streaks = loadStreaks();
      const s = streaks.find(x => x.id === id);
      if (!s) return;
      const name = prompt('Edit quest name:', s.name);
      if (name && name.trim()) {
        s.name = name.trim();
        saveStreaks(streaks);
        render();
      }
    }
    function duplicateStreak(id) {
      const streaks = loadStreaks();
      const s = streaks.find(x => x.id === id);
      if (!s) return;
      const copy = { ...s, id: Date.now().toString(), streak: 0, lastDone: null };
      streaks.push(copy);
      saveStreaks(streaks);
      render();
      if (navigator.vibrate) navigator.vibrate(30);
    }

    function loadCalendarActivities() {
      try {
        const raw = localStorage.getItem(CALENDAR_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveCalendarActivities(activities) {
      localStorage.setItem(CALENDAR_KEY, JSON.stringify(activities));
    }

    function dateToKey(d) {
      const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0');
      return y + '-' + m + '-' + day;
    }

    function isPastDate(dateKey) {
      return dateKey < dateToKey(new Date());
    }

    function regularMatchesDate(a, dateKey) {
      if (!a.startDate || a.startDate > dateKey) return false;
      const freq = a.frequency || 'daily';
      if (freq === 'daily') return true;
      const d = new Date(dateKey + 'T12:00:00');
      if (freq === 'weekly') {
        const weekdays = Array.isArray(a.weekdays) ? a.weekdays : [];
        if (weekdays.length === 0) return true;
        return weekdays.includes(d.getDay());
      }
      if (freq === 'monthly') {
        const monthDays = Array.isArray(a.monthDays) ? a.monthDays : [];
        if (monthDays.length === 0) return true;
        return monthDays.includes(d.getDate());
      }
      return true;
    }

    function getActivitiesForDate(dateKey) {
      const activities = loadCalendarActivities();
      const result = [];
      for (const a of activities) {
        const type = a.type || 'once';
        if (type === 'once') {
          if ((a.date || a.startDate) === dateKey) {
            result.push({ id: a.id, name: a.name, completed: a.completed === true, type: 'once', dateKey, freqLabel: null });
          }
        } else {
          if (regularMatchesDate(a, dateKey)) {
            const completed = Array.isArray(a.completedDates) && a.completedDates.includes(dateKey);
            const freq = a.frequency || 'daily';
            let freqLabel = 'Daily';
            if (freq === 'weekly' && Array.isArray(a.weekdays) && a.weekdays.length) {
              const names = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
              freqLabel = 'Weekly (' + a.weekdays.sort((x,y)=>x-y).map(w=>names[w]).join(', ') + ')';
            } else if (freq === 'monthly' && Array.isArray(a.monthDays) && a.monthDays.length) {
              freqLabel = 'Monthly (' + a.monthDays.sort((x,y)=>x-y).join(', ') + ')';
            }
            result.push({ id: a.id, name: a.name, completed, type: 'regular', dateKey, freqLabel });
          }
        }
      }
      return result;
    }

    function dateHasActivity(dateKey) {
      const activities = loadCalendarActivities();
      return activities.some(a => {
        const type = a.type || 'once';
        if (type === 'once') return (a.date || a.startDate) === dateKey;
        return regularMatchesDate(a, dateKey);
      });
    }

    function markCalendarDone(id, dateKey, userTime) {
      const activities = loadCalendarActivities();
      const a = activities.find(x => x.id === id);
      if (!a) return;
      const isoTime = (userTime && /^\d{1,2}:\d{2}$/.test(userTime))
        ? (() => { const d = new Date(dateKey + 'T12:00:00'); const [h, m] = userTime.split(':').map(Number); d.setHours(h, m, 0, 0); return d.toISOString(); })()
        : new Date().toISOString();
      const type = a.type || 'once';
      if (type === 'once') {
        a.completed = true;
        a.completedTime = isoTime;
      } else {
        if (!Array.isArray(a.completedDates)) a.completedDates = [];
        if (!a.completedDates.includes(dateKey)) a.completedDates.push(dateKey);
        if (!a.completedTimes) a.completedTimes = {};
        a.completedTimes[dateKey] = isoTime;
      }
      saveCalendarActivities(activities);
      renderCalendar();
      renderDayView();
      render();
    }

    function deleteCalendarActivity(id) {
      const activities = loadCalendarActivities().filter(a => a.id !== id);
      saveCalendarActivities(activities);
      renderCalendar();
      renderDayView();
      render();
    }

    function renderCalendar() {
      const year = calendarCurrent.getFullYear();
      const month = calendarCurrent.getMonth();
      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);
      const startPad = first.getDay();
      const daysInMonth = last.getDate();
      const todayKey = dateToKey(new Date());

      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      document.getElementById('calendarMonthTitle').textContent = monthNames[month] + ' ' + year;

      const grid = document.getElementById('calendarGrid');
      const cells = [];
      const prevMonth = new Date(year, month, 0);
      let prevDay = prevMonth.getDate();
      for (let i = 0; i < startPad; i++) {
        const d = new Date(year, month - 1, prevDay - startPad + i + 1);
        const key = dateToKey(d);
        cells.push({ key, label: d.getDate(), otherMonth: true, hasActivity: dateHasActivity(key), isToday: key === todayKey, selected: key === calendarSelected });
      }
      for (let day = 1; day <= daysInMonth; day++) {
        const key = dateToKey(new Date(year, month, day));
        cells.push({ key, label: day, otherMonth: false, hasActivity: dateHasActivity(key), isToday: key === todayKey, selected: key === calendarSelected });
      }
      const remaining = 42 - cells.length;
      for (let i = 0; i < remaining; i++) {
        const d = new Date(year, month + 1, i + 1);
        const key = dateToKey(d);
        cells.push({ key, label: d.getDate(), otherMonth: true, hasActivity: dateHasActivity(key), isToday: key === todayKey, selected: key === calendarSelected });
      }

      grid.innerHTML = cells.map(c => {
        const classes = ['calendar-day'];
        if (c.otherMonth) classes.push('other-month');
        if (c.isToday) classes.push('today');
        if (c.hasActivity) classes.push('has-activity');
        if (c.selected) classes.push('selected');
        return `<button type="button" class="${classes.join(' ')}" data-date="${c.key}">${c.label}</button>`;
      }).join('');

      grid.querySelectorAll('.calendar-day').forEach(btn => {
        btn.addEventListener('click', () => {
          calendarSelected = btn.dataset.date;
          renderCalendar();
          renderDayView();
        });
      });
    }

    function renderDayView() {
      const labelEl = document.getElementById('selectedDateLabel');
      const formEl = document.getElementById('addActivityForm');
      const pastMsg = document.getElementById('pastDayMsg');
      const listEl = document.getElementById('dayActivitiesList');
      if (!calendarSelected) {
        labelEl.textContent = 'Tap a day to add activities and mark streaks';
        formEl.style.display = 'none';
        pastMsg.style.display = 'none';
        listEl.innerHTML = '';
        return;
      }
      const d = new Date(calendarSelected + 'T12:00:00');
      const dateLabel = d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
      labelEl.textContent = dateLabel;

      const past = isPastDate(calendarSelected);
      if (past) {
        pastMsg.style.display = 'block';
        formEl.style.display = 'none';
      } else {
        pastMsg.style.display = 'none';
        formEl.style.display = 'flex';
        formEl.dataset.date = calendarSelected;
        const dateInput = document.getElementById('addActivityDate');
        if (dateInput) dateInput.value = calendarSelected;
      }

      const activities = getActivitiesForDate(calendarSelected);
      if (activities.length === 0) {
        listEl.innerHTML = '<li class="empty">' + (past ? 'No activities on this day.' : 'No activities. Add one above.') + '</li>';
      } else {
        listEl.innerHTML = activities.map(a => `
          <li class="streak-item ${a.completed ? 'done' : ''}" data-id="${a.id}">
            <div class="streak-info">
              <div class="streak-name">${escapeHtml(a.name)} <span class="activity-badge">${a.type === 'regular' ? (a.freqLabel || 'Regular') : 'Once'}</span></div>
              <div class="streak-count">${a.completed ? 'Done' : 'Not done yet'}</div>
            </div>
            ${a.completed
              ? '<span class="btn-done" style="cursor:default;opacity:0.8;">âœ“ Mission done!</span>'
              : `<button type="button" class="btn-done" data-id="${a.id}" data-date="${a.dateKey}" data-name="${escapeHtml(a.name)}">Mission complete!</button>`
            }
            <button type="button" class="btn-delete" data-id="${a.id}" aria-label="Delete">Ã—</button>
          </li>
        `).join('');
        listEl.querySelectorAll('.btn-done[data-id]').forEach(btn => {
          const id = btn.dataset.id;
          const dateKey = btn.dataset.date;
          const name = btn.dataset.name || 'This';
          btn.addEventListener('click', () => {
            showConfirmCompletion(name, (userTime) => markCalendarDone(id, dateKey, userTime));
          });
        });
        listEl.querySelectorAll('.btn-delete').forEach(btn => {
          btn.addEventListener('click', () => deleteCalendarActivity(btn.dataset.id));
        });
      }
    }

    function getMaxStreak() {
      const streaks = loadStreaks();
      return streaks.length ? Math.max(...streaks.map(s => Math.max(0, s.streak)), 0) : 0;
    }

    function countCitizens() {
      const streaks = loadStreaks();
      return streaks.reduce((sum, s) => sum + Math.max(0, s.streak), 0);
    }
    function getCitizenStreakLengths() {
      const streaks = loadStreaks();
      const arr = [];
      streaks.forEach(s => {
        const n = Math.max(0, s.streak);
        for (let i = 0; i < n; i++) arr.push(s.streak);
      });
      return arr;
    }

    function loadAchievements() {
      try {
        const raw = localStorage.getItem(ACHIEVEMENTS_KEY);
        return raw ? JSON.parse(raw) : { stickers: [] };
      } catch { return { stickers: [] }; }
    }
    function saveAchievements(data) {
      localStorage.setItem(ACHIEVEMENTS_KEY, JSON.stringify(data));
    }
    function getWeekStart() {
      const d = new Date();
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      const m = new Date(d);
      m.setDate(diff);
      m.setHours(0,0,0,0);
      return m;
    }
    function getCompletionsThisWeek() {
      const streaks = loadStreaks();
      const today = todayStr();
      const weekStart = getWeekStart();
      const weekStartStr = weekStart.toDateString();
      let count = 0;
      streaks.forEach(s => {
        if (s.lastDone && s.lastDone >= weekStartStr && s.lastDone <= today) count++;
      });
      const activities = loadCalendarActivities();
      const todayKey = dateToKey(new Date());
      const weekStartKey = dateToKey(weekStart);
      activities.forEach(a => {
        const type = a.type || 'once';
        if (type === 'once') {
          const d = a.date || a.startDate;
          if (d && d >= weekStartKey && d <= todayKey && a.completed) count++;
        } else if (type !== 'once' && a.completedDates) {
          a.completedDates.filter(d => d >= weekStartKey && d <= todayKey).forEach(() => count++);
        }
      });
      return count;
    }
    function loadParentReward() {
      try {
        return localStorage.getItem(PARENT_REWARD_KEY) || '';
      } catch { return ''; }
    }
    function getWeeklyGoalTarget() {
      try {
        const v = parseInt(localStorage.getItem(WEEKLY_GOAL_TARGET_KEY) || '5', 10);
        return isNaN(v) || v < 1 ? 5 : Math.min(20, v);
      } catch { return 5; }
    }
    function saveWeeklyGoalTarget(n) {
      localStorage.setItem(WEEKLY_GOAL_TARGET_KEY, String(Math.max(1, Math.min(20, n))));
    }
    function isStreakAtRisk(streak) {
      const today = todayStr();
      if (!streak.preferredTime || streak.lastDone === today) return false;
      const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
      if (streak.lastDone !== yesterday.toDateString()) return false;
      const [h, m] = streak.preferredTime.split(':').map(Number);
      const deadlineMins = h * 60 + m;
      const now = new Date();
      const nowMins = now.getHours() * 60 + now.getMinutes();
      return nowMins >= deadlineMins && nowMins < deadlineMins + 120;
    }
    function getMostProductiveDay() {
      const history = getCompletionHistory();
      const byDay = [0,0,0,0,0,0,0];
      history.forEach(h => {
        const d = new Date(h.date + 'T12:00:00');
        byDay[d.getDay()] += h.count;
      });
      const max = Math.max(...byDay);
      const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      const idx = byDay.indexOf(max);
      return max > 0 ? days[idx] : null;
    }
    function isLuckyDay() {
      const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
      return dayOfYear % 7 === 3;
    }
    function getDueNowCount() {
      const streaks = loadStreaks().filter(s => s.lastDone !== todayStr());
      const now = new Date();
      const nowMins = now.getHours() * 60 + now.getMinutes();
      return streaks.filter(s => {
        if (!s.preferredTime) return true;
        const [h, m] = s.preferredTime.split(':').map(Number);
        const deadlineMins = h * 60 + m;
        return nowMins >= deadlineMins;
      }).length;
    }

    function renderAchievements() {
      const maxStreak = getMaxStreak();
      const completions = getCompletionsThisWeek();
      const weeklyTarget = getWeeklyGoalTarget();
      const weeklyEl = document.getElementById('weeklyGoal');
      if (weeklyEl) {
        weeklyEl.style.display = 'block';
        const reward = loadParentReward();
        const rewardHtml = reward ? `<br><span style="font-size:0.9em;color:var(--text-muted);">ðŸŽ Reward: ${escapeHtml(reward)}</span>` : '';
        weeklyEl.innerHTML = `<strong>This week&apos;s goal:</strong> ${completions}/${weeklyTarget} quests done. ${completions >= weeklyTarget ? 'ðŸŽ‰ Goal reached!' : 'Keep going!'}${rewardHtml}`;
        weeklyEl.className = 'weekly-goal' + (completions >= weeklyTarget ? ' achieved' : '');
      }
      const rewardInput = document.getElementById('parentRewardInput');
      const rewardSave = document.getElementById('parentRewardSave');
      if (rewardInput) rewardInput.value = loadParentReward();
      if (rewardSave && rewardInput) {
        rewardSave.onclick = () => {
          const val = rewardInput.value.trim();
          try {
            localStorage.setItem(PARENT_REWARD_KEY, val);
            rewardInput.value = val;
            const toast = document.createElement('div');
            toast.className = 'streaktopia-toast';
            toast.style.cssText = 'bottom:auto;top:4rem;left:50%;transform:translateX(-50%);';
            toast.textContent = 'Reward saved! âœ“';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
          } catch (e) {
            alert('Could not save. Try again.');
          }
        };
      }
      const grid = document.getElementById('achievementsGrid');
      const badgeData = loadAchievements();
      const customBadges = (() => { try { const r = localStorage.getItem(CUSTOM_BADGES_KEY); return r ? JSON.parse(r) : []; } catch { return []; } })();
      const allBadges = [...ACHIEVEMENT_BADGES, ...customBadges.map(c => ({ id: c.id, emoji: c.emoji || 'ðŸ…', label: c.name, sticker: c.emoji || 'ðŸ…', req: 0 }))];
      grid.innerHTML = allBadges.map(b => {
        const earned = (b.req === 0) || maxStreak >= b.req;
        return `<div class="achievement-badge ${earned ? 'earned' : 'locked'}" data-id="${b.id}" data-emoji="${b.sticker}" title="${earned ? 'Earned!' : (b.req ? b.req + ' days needed' : 'Custom')}">
          <span class="emoji">${b.emoji}</span>
          <span class="label">${escapeHtml(b.label)}</span>
          <span class="req">${earned ? 'âœ“' : (b.req ? b.req + ' days' : '')}</span>
        </div>`;
      }).join('');
      grid.querySelectorAll('.achievement-badge.earned').forEach(el => {
        el.onclick = () => {
          if (el.dataset.emoji) {
            badgeData.stickers = badgeData.stickers || [];
            badgeData.stickers.push(el.dataset.emoji);
            saveAchievements(badgeData);
            renderAchievements();
          }
        };
      });
      const shareBtnMain = document.getElementById('shareAchievementBtnMain');
      if (shareBtnMain) shareBtnMain.onclick = () => shareProgress();
      const board = document.getElementById('stickerBoard');
      const stickers = badgeData.stickers || [];
      board.innerHTML = stickers.map((s, i) => `<span class="sticker" data-i="${i}">${s}</span>`).join('');
      board.querySelectorAll('.sticker').forEach(el => {
        el.onclick = () => {
          const i = +el.dataset.i;
          badgeData.stickers.splice(i, 1);
          saveAchievements(badgeData);
          renderAchievements();
        };
      });
    }

    function getHappiness(buildingsCount, citizensCount) {
      const total = buildingsCount + citizensCount;
      if (total === 0) return { emoji: 'ðŸ˜¢', label: 'The city is empty. Build and keep streaks!' };
      if (citizensCount === 0) return { emoji: 'ðŸ—ï¸', label: 'Buildings await their flame citizens. Complete quests!' };
      const baseScore = Math.floor(total / 3);
      const bonus = (buildingsCount >= 5 ? 1 : 0) + (buildingsCount >= 3 ? 1 : 0) + (citizensCount >= 3 ? 1 : 0);
      const score = Math.min(5, Math.min(4, baseScore) + Math.min(2, bonus));
      const levels = [
        { emoji: 'ðŸ˜¢', label: 'Your flame citizens need more homes and company.' },
        { emoji: 'ðŸ˜', label: 'The flames are flickering. Build more!' },
        { emoji: 'ðŸ™‚', label: 'Your citizens are content. Keep it up!' },
        { emoji: 'ðŸ˜Š', label: 'The flames burn bright. Your city thrives!' },
        { emoji: 'ðŸ¤©', label: 'Incredible! Your flame citizens are thriving!' },
        { emoji: 'ðŸŒŸ', label: 'Legendary! StreakTopia has never been happier!' }
      ];
      return levels[Math.min(score, levels.length - 1)];
    }

    const WANDER_ANIMS = ['wander1', 'wander2', 'wander3', 'wander4', 'wander5'];
    const CITIZEN_MESSAGES = ['Thanks for building our city!', 'We love it here!', "You're the best mayor!", 'Keep it up!', 'This place is amazing!', 'More buildings please!', 'We feel so happy!', 'Best city ever!', 'Our flames burn brighter here!', 'You rock!', 'Our home is beautiful!', 'Streaks make us strong!', 'We believe in you!', 'Keep those streaks going!', 'You are a star!', 'Every day we grow stronger!', 'This city fuels our fire!', 'Mayor for life!', 'Our streaks are unstoppable!', 'Building habits, building dreams!'];
    const CITY_LEVELS = ['', 'Hamlet', 'Town', 'City', 'Metropolis', 'Capital'];

    function getCityLevel(buildingsCount) {
      if (buildingsCount >= 15) return 5;
      if (buildingsCount >= 10) return 4;
      if (buildingsCount >= 5) return 3;
      if (buildingsCount >= 3) return 2;
      if (buildingsCount >= 1) return 1;
      return 0;
    }

    function showStreaktopiaConfetti() {
      const colors = ['#ef6c00','#ff9800','#f9a825','#43a047','#e53935','#7e57c2'];
      for (let i = 0; i < 24; i++) {
        const p = document.createElement('div');
        p.className = 'confetti-piece';
        p.style.left = (30 + Math.random() * 40) + '%';
        p.style.top = '40%';
        p.style.background = colors[i % colors.length];
        p.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        const tx = (Math.random() - 0.5) * 150;
        const ty = 80 + Math.random() * 80;
        p.style.animation = `confettiFall ${0.8 + Math.random() * 0.4}s ease-out forwards`;
        p.style.setProperty('--tx', tx + 'px');
        p.style.setProperty('--ty', ty + 'px');
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 1200);
      }
    }

    function renderStreaktopia(justBuiltIndex) {
      const buildings = loadStreaktopia();
      const gemData = loadGemData();
      const today = new Date().toDateString();

      if (typeof justBuiltIndex !== 'number') {
        const lastVisit = localStorage.getItem(STREAKTOPIA_DAILY_VISIT_KEY);
        if (lastVisit !== today) {
          localStorage.setItem(STREAKTOPIA_DAILY_VISIT_KEY, today);
          const bonus = 2;
          gemData.gems += bonus;
          saveGemData(gemData);
          const toast = document.createElement('div');
          toast.className = 'streaktopia-toast';
          toast.textContent = 'âœ¨ Daily visit bonus: +' + bonus + ' gems!';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);
        }
      }

      const prevLevel = parseInt(localStorage.getItem('streaks-streaktopia-level') || '0', 10);
      const newLevel = getCityLevel(buildings.length);
      if (newLevel > prevLevel && prevLevel > 0) {
        showStreaktopiaConfetti();
        const toast = document.createElement('div');
        toast.className = 'streaktopia-toast';
        toast.textContent = 'ðŸŽ‰ City level up! ' + CITY_LEVELS[prevLevel] + ' â†’ ' + CITY_LEVELS[newLevel] + '!';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2500);
      }
      if (newLevel > 0) localStorage.setItem('streaks-streaktopia-level', String(newLevel));

      const gemsEl = document.getElementById('streaktopiaGemsCount');
      if (gemsEl) gemsEl.textContent = gemData.gems;
      const levelEl = document.getElementById('streaktopiaCityLevel');
      if (levelEl) {
        levelEl.textContent = newLevel > 0 ? '(' + CITY_LEVELS[newLevel] + ')' : '';
      }
      const meta = loadStreaktopiaMeta();
      const cityNameEl = document.getElementById('streaktopiaCityNameDisplay');
      if (cityNameEl) cityNameEl.textContent = meta.cityName || 'StreakTopia';
      const editNameBtn = document.getElementById('streaktopiaEditName');
      if (editNameBtn) {
        editNameBtn.onclick = () => {
          const name = prompt('Name your city:', meta.cityName || '');
          if (name !== null) {
            saveStreaktopia(loadStreaktopia(), { cityName: name.trim() });
            if (cityNameEl) cityNameEl.textContent = name.trim() || 'StreakTopia';
          }
        };
      }
      const skyEl = document.querySelector('.streaktopia-sky');
      if (skyEl) {
        const h = new Date().getHours();
        skyEl.classList.toggle('night', h >= 19 || h < 6);
      }
      const birdsEl = document.getElementById('streaktopiaBirds');
      if (birdsEl) {
        birdsEl.innerHTML = '';
        ['ðŸ¦', 'ðŸ¦…', 'ðŸ¦‹', 'ðŸ¦‹'].forEach((emoji, i) => {
          const el = document.createElement('span');
          el.className = emoji === 'ðŸ¦‹' ? 'streaktopia-butterfly' : 'streaktopia-bird';
          el.textContent = emoji;
          el.style.left = (i * 25) + '%';
          el.style.top = (10 + (i % 3) * 8) + '%';
          el.style.animationDelay = (i * -5) + 's';
          birdsEl.appendChild(el);
        });
      }
      const particlesEl = document.getElementById('streaktopiaParticles');
      if (particlesEl) {
        particlesEl.innerHTML = '';
        for (let i = 0; i < 12; i++) {
          const s = document.createElement('div');
          s.className = 'streaktopia-sparkle';
          s.style.left = (5 + (i * 8) + Math.random() * 5) + '%';
          s.style.top = (15 + (i % 4) * 20) + '%';
          s.style.animationDelay = (i * -0.5) + 's';
          particlesEl.appendChild(s);
        }
      }
      const cityEl = document.getElementById('streaktopiaCity');
      const buildingsRow = document.getElementById('streaktopiaBuildings');
      const citizensLayer = document.getElementById('streaktopiaCitizensLayer');

      if (buildings.length > 0) {
        cityEl.classList.remove('empty-city');
        buildingsRow.innerHTML = buildings.map((b, i) => {
          const def = STREAKTOPIA_BUILDINGS.find(d => d.id === b.id) || b;
          const desc = def.desc || '';
          return `<span class="streaktopia-building clickable" data-index="${i}" data-id="${b.id}" data-emoji="${def.emoji}" data-name="${escapeHtml(b.name)}" data-desc="${escapeHtml(desc)}" data-cost="${def.cost}" title="Click for info">${def.emoji}</span>`;
        }).join('');
        buildingsRow.style.display = 'flex';
        buildingsRow.querySelectorAll('.streaktopia-building').forEach((el, i) => {
          el.addEventListener('click', () => showBuildingModal(buildings[i], i));
          if (i === justBuiltIndex) { el.classList.add('build-pop'); setTimeout(() => el.classList.remove('build-pop'), 500); }
        });
      } else {
        cityEl.classList.add('empty-city');
        buildingsRow.innerHTML = '<div class="streaktopia-empty-preview"><span class="empty-emoji">ðŸ </span><span class="empty-text">Empty lot</span><span class="empty-hint">Build something below to start your city!</span></div>';
        buildingsRow.style.display = 'flex';
      }

      citizensLayer.innerHTML = '';
      const citizenStreaks = getCitizenStreakLengths();
      const citizenCount = citizenStreaks.length;
      const happiness = getHappiness(buildings.length, citizenCount);
      if (citizenStreaks.length > 0) {
        citizenStreaks.forEach((streakLen, i) => {
          const anim = WANDER_ANIMS[i % WANDER_ANIMS.length];
          const duration = 10 + (i % 5) * 2;
          const delay = (i * 0.7) % 6;
          const size = streakLen >= 30 ? 1.4 : streakLen >= 7 ? 1.2 : 1;
          const citizen = document.createElement('span');
          citizen.className = 'streaktopia-citizen-wander streaktopia-flame';
          citizen.setAttribute('aria-hidden', 'true');
          citizen.textContent = 'ðŸ”¥';
          citizen.style.animation = `${anim} ${duration}s ease-in-out infinite`;
          citizen.style.animationDelay = `${delay}s`;
          citizen.style.fontSize = (1.5 * size) + 'rem';
          citizen.title = streakLen + '-day streak flame';
          const bounce = () => {
            citizen.classList.add('tap-bounce');
            const msg = CITIZEN_MESSAGES[(i + Math.floor(Date.now() / 1000)) % CITIZEN_MESSAGES.length];
            const streakNote = streakLen >= 7 ? ' (' + streakLen + '-day streak!)' : '';
            const toast = document.createElement('div');
            toast.className = 'streaktopia-toast';
            toast.style.bottom = 'auto'; toast.style.top = '2rem';
            toast.textContent = msg + streakNote;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
            setTimeout(() => citizen.classList.remove('tap-bounce'), 400);
          };
          citizen.onclick = (e) => { e.stopPropagation(); bounce(); };
          citizen.ontouchstart = () => bounce();
          citizensLayer.appendChild(citizen);
        });
      }
      const total = buildings.length + citizenCount;
      const happinessLevels = 6;
      const happinessScore = total === 0 ? 0 : Math.min(happinessLevels - 1, Math.floor(total / 3) + (buildings.length >= 3 ? 1 : 0) + (buildings.length >= 5 ? 1 : 0) + (citizenCount >= 3 ? 1 : 0));
      const happinessPct = (happinessScore / (happinessLevels - 1)) * 100;
      const playerEl = document.getElementById('streaktopiaPlayer');
      const PLAYER_AVATARS = [
        { emoji: 'ðŸ§‘', minStreak: 0 },
        { emoji: 'ðŸ¦¸', minStreak: 7 },
        { emoji: 'ðŸ‘¸', minStreak: 14 },
        { emoji: 'ðŸ¦¸â€â™‚ï¸', minStreak: 30 }
      ];
      const maxStreak = getMaxStreak();
      const avatar = PLAYER_AVATARS.slice().reverse().find(a => maxStreak >= a.minStreak) || PLAYER_AVATARS[0];
      if (playerEl) {
        playerEl.textContent = avatar.emoji;
        playerEl.onclick = playerEl.ontouchstart = (e) => { e.stopPropagation(); playerEl.classList.add('wave'); setTimeout(() => playerEl.classList.remove('wave'), 600); };
      }
      const happinessEl = document.getElementById('streaktopiaHappiness');
      happinessEl.title = 'Build more & keep streaks! 3+ buildings and 3+ citizens give boosts. Tap flame citizens to see their streak!';
      document.getElementById('streaktopiaHappinessEmoji').textContent = happiness.emoji;
      document.getElementById('streaktopiaHappinessLabel').textContent = happiness.label;
      document.getElementById('streaktopiaHappinessFill').style.width = happinessPct + '%';

      const statBuildingsEl = document.getElementById('streaktopiaStatBuildings');
      const statCitizensEl = document.getElementById('streaktopiaStatCitizens');
      if (statBuildingsEl) statBuildingsEl.textContent = buildings.length;
      if (statCitizensEl) statCitizensEl.textContent = citizenCount;

      const citizensCountEl = document.getElementById('streaktopiaCitizenCount');
      const byType = {};
      buildings.forEach(b => { byType[b.name] = (byType[b.name] || 0) + 1; });
      const statsStr = Object.entries(byType).map(([n, c]) => c > 1 ? c + ' ' + n + 's' : n).join(', ');
      if (citizenCount === 0) {
        citizensCountEl.innerHTML = buildings.length > 0
          ? (statsStr ? statsStr + '. ' : '') + 'Keep streaks to grow your flame citizens.'
          : 'Build your first structure below!';
      } else {
        citizensCountEl.innerHTML = (statsStr ? statsStr + ' Â· ' : '') + citizenCount + ' flame citizen' + (citizenCount !== 1 ? 's' : '') + ' wandering. Tap them!';
      }

      const petEl = document.getElementById('streaktopiaPet');
      const PETS = [{ emoji: 'ðŸ•', minStreak: 7 }, { emoji: 'ðŸ±', minStreak: 14 }, { emoji: 'ðŸ°', minStreak: 21 }];
      const petDef = PETS.slice().reverse().find(p => maxStreak >= p.minStreak);
      if (petEl) {
        if (petDef) {
          petEl.textContent = petDef.emoji;
          petEl.style.display = '';
          petEl.style.left = '35%';
          petEl.style.bottom = '45px';
          petEl.title = 'Your companion! Tap to pet.';
          petEl.onclick = petEl.ontouchstart = (e) => { e.stopPropagation(); petEl.classList.add('tap-bounce'); setTimeout(() => petEl.classList.remove('tap-bounce'), 400); };
        } else {
          petEl.style.display = 'none';
        }
      }

      const decorationsEl = document.getElementById('streaktopiaDecorations');
      if (decorationsEl) {
        const badgeData = loadAchievements();
        const earned = ACHIEVEMENT_BADGES.filter(b => getMaxStreak() >= b.req);
        decorationsEl.innerHTML = earned.slice(0, 4).map((b, i) =>
          `<span class="streaktopia-decoration" style="left:${15 + i * 22}%;bottom:55px;">${b.emoji}</span>`
        ).join('');
      }

      const questsEl = document.getElementById('streaktopiaQuestsList');
      if (questsEl) {
        const weekStart = getWeekStart().toDateString();
        let qData = {};
        try {
          const raw = localStorage.getItem(STREAKTOPIA_QUESTS_KEY);
          qData = raw ? JSON.parse(raw) : {};
        } catch {}
        if (qData.weekStart !== weekStart) {
          qData = { weekStart, buildHouses: 0, buildAny: 0, buildPark: qData.buildPark || false, buildTower: qData.buildTower || false };
        }
        const housesThisWeek = buildings.filter(b => b.id === 'house').length;
        const buildQuest = Math.min(3, housesThisWeek);
        const buildAnyQuest = Math.min(5, buildings.length);
        const hasPark = buildings.some(b => b.id === 'park');
        const hasTower = buildings.some(b => b.id === 'tower');
        const buildDone = buildQuest >= 3;
        const anyDone = buildAnyQuest >= 5;
        const parkDone = hasPark;
        const towerDone = hasTower;
        if (buildDone && !qData.buildReward) {
          qData.buildReward = true;
          gemData.gems += 5;
          saveGemData(gemData);
          const t = document.createElement('div');
          t.className = 'streaktopia-toast';
          t.textContent = 'ðŸ† Homes quest! +5 gems!';
          document.body.appendChild(t);
          setTimeout(() => t.remove(), 1500);
        }
        if (anyDone && !qData.anyReward) {
          qData.anyReward = true;
          gemData.gems += 3;
          saveGemData(gemData);
          const t = document.createElement('div');
          t.className = 'streaktopia-toast';
          t.textContent = 'ðŸ† Builder quest! +3 gems!';
          document.body.appendChild(t);
          setTimeout(() => t.remove(), 1500);
        }
        if (parkDone && !qData.buildPark) {
          qData.buildPark = true;
          gemData.gems += 4;
          saveGemData(gemData);
          const t = document.createElement('div');
          t.className = 'streaktopia-toast';
          t.textContent = 'ðŸžï¸ Park built! +4 gems!';
          document.body.appendChild(t);
          setTimeout(() => t.remove(), 1500);
        }
        if (towerDone && !qData.buildTower) {
          qData.buildTower = true;
          gemData.gems += 6;
          saveGemData(gemData);
          const t = document.createElement('div');
          t.className = 'streaktopia-toast';
          t.textContent = 'ðŸ° Tower landmark! +6 gems!';
          document.body.appendChild(t);
          setTimeout(() => t.remove(), 1500);
        }
        try { localStorage.setItem(STREAKTOPIA_QUESTS_KEY, JSON.stringify(qData)); } catch {}
        if (gemsEl) gemsEl.textContent = gemData.gems;
        questsEl.innerHTML = `
          <div class="streaktopia-quest-item ${buildQuest >= 3 ? 'done' : ''}">Build 3 houses: ${buildQuest}/3 ${buildQuest >= 3 ? 'âœ“' : ''} (+5 gems)</div>
          <div class="streaktopia-quest-item ${buildAnyQuest >= 5 ? 'done' : ''}">Build 5 buildings: ${buildAnyQuest}/5 ${buildAnyQuest >= 5 ? 'âœ“' : ''} (+3 gems)</div>
          <div class="streaktopia-quest-item ${parkDone ? 'done' : ''}">Build a park: ${parkDone ? 'âœ“' : 'â€”'} (+4 gems)</div>
          <div class="streaktopia-quest-item ${towerDone ? 'done' : ''}">Build a tower: ${towerDone ? 'âœ“' : 'â€”'} (+6 gems)</div>
        `;
      }

      const shopEl = document.getElementById('streaktopiaShop');
      shopEl.innerHTML = '<div class="streaktopia-shop-grid">' + STREAKTOPIA_BUILDINGS.map(def => {
        const canAfford = gemData.gems >= def.cost;
        const need = def.cost - gemData.gems;
        return `
          <div class="streaktopia-shop-item ${canAfford ? '' : 'locked'}">
            <span class="shop-emoji">${def.emoji}</span>
            <span class="shop-name">${escapeHtml(def.name)}</span>
            <span class="cost">${def.cost} ðŸ’Ž</span>
            ${!canAfford && need > 0 ? `<span class="need-more" style="font-size:0.75rem;color:var(--text-dim);">${need} more</span>` : ''}
            <button type="button" data-id="${def.id}" data-emoji="${def.emoji}" data-name="${escapeHtml(def.name)}" data-cost="${def.cost}" ${canAfford ? '' : 'disabled'}>Build</button>
          </div>
        `;
      }).join('') + '</div>';

      shopEl.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          const def = STREAKTOPIA_BUILDINGS.find(b => b.id === btn.dataset.id);
          if (!def || gemData.gems < def.cost) return;
          const gData = loadGemData();
          if (gData.gems < def.cost) return;
          gData.gems -= def.cost;
          saveGemData(gData);
          const bList = loadStreaktopia();
          bList.push({ id: def.id, emoji: def.emoji, name: def.name });
          saveStreaktopia(bList);
          document.getElementById('gemsCount').textContent = gData.gems;
          const toast = document.createElement('div');
          toast.className = 'streaktopia-toast';
          toast.textContent = def.emoji + ' ' + def.name + ' built!';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 900);
          const builtCount = bList.length;
          if ([5, 10, 15].includes(builtCount)) {
            setTimeout(() => {
              const m = document.createElement('div');
              m.className = 'streaktopia-toast';
              m.style.background = 'linear-gradient(135deg, #ff9800, #ffd54f)';
              m.style.color = '#1a1a1a';
              m.style.fontWeight = '700';
              m.textContent = 'ðŸ™ï¸ ' + builtCount + ' buildings! City growing!';
              document.body.appendChild(m);
              setTimeout(() => m.remove(), 2500);
            }, 500);
          }
          renderStreaktopia(bList.length - 1);
        });
      });
    }

    function showBuildingModal(building, index) {
      const def = STREAKTOPIA_BUILDINGS.find(b => b.id === building.id) || building;
      const refund = Math.floor((def.cost || 10) * 0.5);
      const overlay = document.createElement('div');
      overlay.className = 'streaktopia-modal-overlay';
      overlay.innerHTML = `
        <div class="streaktopia-modal">
          <div class="streaktopia-modal-title">${def.emoji} ${escapeHtml(building.name)}</div>
          <div class="streaktopia-modal-desc">${def.desc || 'A building in your city.'}</div>
          <div class="streaktopia-modal-actions">
            <button type="button" class="streaktopia-modal-sell">Sell for ${refund} ðŸ’Ž</button>
            <button type="button" class="streaktopia-modal-close">Close</button>
          </div>
        </div>
      `;
      const close = () => { overlay.remove(); };
      overlay.querySelector('.streaktopia-modal-close').onclick = close;
      overlay.onclick = (e) => { if (e.target === overlay) close(); };
      overlay.querySelector('.streaktopia-modal-sell').onclick = () => {
        const bList = loadStreaktopia();
        bList.splice(index, 1);
        saveStreaktopia(bList);
        const gData = loadGemData();
        gData.gems += refund;
        saveGemData(gData);
        document.getElementById('gemsCount').textContent = gData.gems;
        close();
        const toast = document.createElement('div');
        toast.className = 'streaktopia-toast';
        toast.textContent = 'Sold for ' + refund + ' ðŸ’Ž';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 900);
        renderStreaktopia();
      };
      document.body.appendChild(overlay);
    }

    function getGreeting() {
      const h = new Date().getHours();
      const arr = h < 12 ? GREETINGS.morning : h < 17 ? GREETINGS.afternoon : GREETINGS.evening;
      return arr[Math.floor(Math.random() * arr.length)];
    }
    function getTotalTodayQuests() {
      const streaks = loadStreaks();
      const todayKey = dateToKey(new Date());
      const todayActivities = getActivitiesForDate(todayKey);
      return streaks.length + todayActivities.length;
    }
    function getDoneTodayCount() {
      const streaks = loadStreaks();
      const today = todayStr();
      const todayKey = dateToKey(new Date());
      const todayActivities = getActivitiesForDate(todayKey);
      let done = streaks.filter(s => s.lastDone === today).length;
      done += todayActivities.filter(a => a.completed).length;
      return done;
    }

    function render() {
      const streaks = loadStreaks();
      const list = document.getElementById('streakList');
      const today = todayStr();
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.toDateString();
      const gemData = loadGemData();

      document.getElementById('gemsCount').textContent = gemData.gems;
      document.getElementById('saversCount').textContent = gemData.streakSavers;
      document.getElementById('saverCost').textContent = STREAK_SAVER_COST;
      const luckyBadge = document.getElementById('luckyDayBadge');
      if (luckyBadge) luckyBadge.style.display = isLuckyDay() ? 'inline-block' : 'none';
      const dueBadge = document.getElementById('dueNowBadge');
      const dueCount = getDueNowCount();
      if (dueBadge) {
        if (dueCount > 0) { dueBadge.textContent = dueCount + ' due'; dueBadge.style.display = 'inline'; }
        else dueBadge.style.display = 'none';
      }
      const buyBtn = document.getElementById('buySaverBtn');
      buyBtn.disabled = gemData.gems < STREAK_SAVER_COST;

      const totalToday = getTotalTodayQuests();
      const doneToday = getDoneTodayCount();
      const allDone = totalToday > 0 && doneToday >= totalToday;
      const dailyBanner = document.getElementById('dailyProgressBanner');
      const allDoneBanner = document.getElementById('allDoneBanner');
      const quickAddContainer = document.getElementById('quickAddSuggestions');
      if (dailyBanner && allDoneBanner) {
        if (allDone) {
          dailyBanner.style.display = 'none';
          allDoneBanner.style.display = 'block';
        } else if (totalToday > 0) {
          dailyBanner.style.display = 'block';
          allDoneBanner.style.display = 'none';
          const greetingEl = document.getElementById('dailyGreeting');
          const progressEl = document.getElementById('dailyProgressText');
          const fillEl = document.getElementById('dailyProgressFill');
          const weeklyEl = document.getElementById('weeklyGoalBanner');
          if (greetingEl) greetingEl.textContent = getGreeting();
          if (progressEl) progressEl.textContent = `${doneToday} of ${totalToday} quests done today`;
          if (fillEl) fillEl.style.width = totalToday ? (100 * doneToday / totalToday) + '%' : '0%';
          const completions = getCompletionsThisWeek();
          const weeklyTarget = getWeeklyGoalTarget();
          if (weeklyEl) {
            weeklyEl.style.display = 'block';
            weeklyEl.textContent = `ðŸ“… This week: ${completions}/${weeklyTarget} quests`;
          }
          const tipEl = document.getElementById('dailyTip');
          if (tipEl) {
            const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            tipEl.textContent = 'ðŸ’¡ ' + DAILY_TIPS[dayOfYear % DAILY_TIPS.length];
            tipEl.style.display = 'block';
          }
        } else {
          dailyBanner.style.display = 'none';
          allDoneBanner.style.display = 'none';
        }
      }
      if (quickAddContainer) {
        const existing = streaks.map(s => s.name.toLowerCase());
        const chips = QUICK_ADD_ACTIVITIES.filter(s => !existing.includes(s.name.toLowerCase())).slice(0, 6);
        quickAddContainer.innerHTML = chips.length ? '<span style="font-size:0.8rem;color:var(--text-dim);align-self:center;margin-right:0.25rem;">Quick add:</span>' + chips.map(c => `<button type="button" class="quick-add-chip" data-name="${escapeHtml(c.name)}" data-time="${c.time}">${escapeHtml(c.name)}</button>`).join('') : '';
        quickAddContainer.querySelectorAll('.quick-add-chip').forEach(btn => {
          btn.onclick = () => {
            const name = btn.dataset.name;
            const time = btn.dataset.time;
            const streaks = loadStreaks();
            if (streaks.some(s => s.name.toLowerCase() === name.toLowerCase())) return;
            streaks.push({ id: Date.now().toString(), name, streak: 0, lastDone: null, preferredTime: time });
            saveStreaks(streaks);
            if (navigator.vibrate) navigator.vibrate(50);
            render();
            const toast = document.createElement('div');
            toast.className = 'streaktopia-toast';
            toast.style.cssText = 'bottom:auto;top:4rem;left:50%;transform:translateX(-50%);';
            toast.textContent = 'Added: ' + name + ' âœ“';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 1500);
          };
        });
      }

      let displayStreaks = streaks;
      const searchInput = document.getElementById('searchQuests');
      if (loadSettings().hideCompleted) {
        displayStreaks = displayStreaks.filter(s => s.lastDone !== today);
      }
      if (searchInput) {
        searchInput.style.display = streaks.length >= 5 ? 'block' : 'none';
        const q = (searchInput.value || '').toLowerCase().trim();
        if (q) displayStreaks = displayStreaks.filter(s => s.name.toLowerCase().includes(q));
      }
      if (displayStreaks.length === 0) {
        list.innerHTML = '<li class="empty">No quests yet. Add something you want to do every day! Or tap a quick-add above.</li>';
        return;
      }

      list.innerHTML = displayStreaks.map(s => {
        const alreadyDoneToday = s.lastDone === today;
        const missedDay = s.lastDone !== today && s.lastDone !== yesterdayStr;
        const canUseSaver = !alreadyDoneToday && missedDay && s.streak > 0 && gemData.streakSavers > 0;
        const atRisk = isStreakAtRisk(s);
        const flameSize = s.streak >= 30 ? '1.4em' : s.streak >= 7 ? '1.2em' : '1em';
        const emoji = s.emoji || 'ðŸ”¥';

        const actionsHtml = canUseSaver
          ? `<div class="streak-actions">
               <button type="button" class="btn-done" data-id="${s.id}" data-name="${escapeHtml(s.name)}">Quest complete!</button>
               <button type="button" class="btn-use-saver" data-id="${s.id}">Use streak saver</button>
             </div>`
          : `<button type="button" class="btn-done" ${alreadyDoneToday ? 'disabled' : ''} data-id="${s.id}" data-name="${escapeHtml(s.name)}">
               ${alreadyDoneToday ? 'Quest done!' : 'Quest complete!'}
             </button>`;

        const timeStr = s.preferredTime ? (() => {
          const [h, m] = s.preferredTime.split(':').map(Number);
          const d = new Date(); d.setHours(h, m, 0, 0);
          return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        })() : '';
        return `
          <li class="streak-item ${atRisk ? 'at-risk' : ''}" data-id="${s.id}">
            <span class="streak-flame streak-emoji-pick" style="font-size:${flameSize};cursor:pointer;" data-id="${s.id}" data-emoji="${emoji}" title="Tap to change emoji">${emoji}</span>
            <div class="streak-info">
              <div class="streak-name" data-id="${s.id}" data-name="${escapeHtml(s.name)}" style="cursor:pointer;" title="Tap to edit">${escapeHtml(s.name)}${timeStr ? ' <span class="streak-time">at ' + timeStr + '</span>' : ''}${atRisk ? ' <span style="color:#ff9800;font-size:0.8em;">â° Due soon!</span>' : ''}</div>
              <div class="streak-count"><strong>${s.streak}</strong> day${s.streak !== 1 ? 's' : ''}</div>
            </div>
            ${actionsHtml}
            <div style="display:flex;gap:0.25rem;">
              <button type="button" class="btn-edit" data-id="${s.id}" aria-label="Edit">âœï¸</button>
              <button type="button" class="btn-duplicate" data-id="${s.id}" aria-label="Duplicate">ðŸ“‹</button>
              <button type="button" class="btn-delete" data-id="${s.id}" aria-label="Delete">Ã—</button>
            </div>
          </li>
        `;
      }).join('');

      list.querySelectorAll('.btn-done').forEach(btn => {
        if (btn.disabled) return;
        const id = btn.dataset.id;
        const name = btn.dataset.name || 'This';
        btn.addEventListener('click', () => {
          showConfirmCompletion(name, (userTime) => markDone(id, userTime, false));
        });
      });
      list.querySelectorAll('.btn-use-saver').forEach(btn => {
        btn.addEventListener('click', () => useStreakSaver(btn.dataset.id));
      });
      list.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); editStreak(btn.dataset.id); });
      });
      list.querySelectorAll('.btn-duplicate').forEach(btn => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); duplicateStreak(btn.dataset.id); });
      });
      list.querySelectorAll('.streak-name[data-id]').forEach(el => {
        el.addEventListener('click', (e) => { if (!e.target.closest('button')) editStreak(el.dataset.id); });
      });
      list.querySelectorAll('.streak-emoji-pick').forEach(el => {
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          const streaks = loadStreaks();
          const s = streaks.find(x => x.id === el.dataset.id);
          if (!s) return;
          const idx = QUEST_EMOJIS.indexOf(s.emoji || 'ðŸ”¥');
          s.emoji = QUEST_EMOJIS[(idx + 1) % QUEST_EMOJIS.length];
          saveStreaks(streaks);
          render();
        });
      });
      list.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (confirm('Delete this quest? Your streak will be lost.')) deleteStreak(btn.dataset.id);
        });
      });
      if (searchInput) searchInput.oninput = () => render();

      const todayKey = dateToKey(new Date());
      let todayActivities = getActivitiesForDate(todayKey);
      if (loadSettings().hideCompleted) todayActivities = todayActivities.filter(a => !a.completed);
      const sectionTitle = document.getElementById('todaySectionTitle');
      const todayList = document.getElementById('todayActivitiesList');
      if (todayActivities.length > 0) {
        sectionTitle.style.display = 'block';
        todayList.innerHTML = todayActivities.map(a => `
          <li class="streak-item ${a.completed ? 'done' : ''}" data-id="${a.id}">
            <div class="streak-info">
              <div class="streak-name">${escapeHtml(a.name)} <span class="activity-badge">${a.type === 'regular' ? (a.freqLabel || 'Regular') : 'Once'}</span></div>
              <div class="streak-count">${a.completed ? 'Done' : 'Not done yet'}</div>
            </div>
            ${a.completed
              ? '<span class="btn-done" style="cursor:default;opacity:0.8;">âœ“ Mission done!</span>'
              : `<button type="button" class="btn-done" data-id="${a.id}" data-date="${a.dateKey}" data-name="${escapeHtml(a.name)}">Mission complete!</button>`
            }
            <button type="button" class="btn-delete" data-id="${a.id}" aria-label="Delete">Ã—</button>
          </li>
        `).join('');
        todayList.querySelectorAll('.btn-done[data-id]').forEach(btn => {
          const id = btn.dataset.id;
          const dateKey = btn.dataset.date;
          const name = btn.dataset.name || 'This';
          btn.addEventListener('click', () => {
            showConfirmCompletion(name, (userTime) => markCalendarDone(id, dateKey, userTime));
          });
        });
        todayList.querySelectorAll('.btn-delete').forEach(btn => {
          btn.addEventListener('click', () => deleteCalendarActivity(btn.dataset.id));
        });
      } else {
        sectionTitle.style.display = 'none';
        todayList.innerHTML = '';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Block junk/slang; validate words against full English dictionary via API
    const JUNK_NAMES = new Set(['test', 'testing', 'asdf', 'qwerty', 'abc', 'xyz', 'foo', 'bar', 'baz']);
    const SLANG_OR_NONSENSE = new Set([
      'skibidi', 'gyatt', 'gyat', 'rizz', 'rizzler', 'sigma', 'sigmas', 'bussin', 'bussing', 'slay', 'mid', 'based', 'cringe',
      'yeet', 'vibes', 'vibe', 'sus', 'bet', 'lowkey', 'highkey', 'stan', 'simp', 'ratio', 'nocap', 'cap', 'fr', 'ong', 'ngl', 'tbh', 'imo', 'smh',
      'lol', 'lmao', 'rofl', 'bruh', 'fam', 'lit', 'goat', 'fanum', 'ohio', 'mog', 'mogging', 'chungus', 'sussy', 'baka', 'copium',
      'kek', 'pog', 'poggers', 'pogchamp', 'monkas', 'wtf', 'tf'
    ]);
    const DICT_API = 'https://api.dictionaryapi.dev/api/v2/entries/en/';
    const wordCheckCache = {};
    async function isWordInDictionary(word) {
      const lower = word.toLowerCase();
      if (wordCheckCache[lower] !== undefined) return wordCheckCache[lower];
      try {
        const r = await fetch(DICT_API + encodeURIComponent(lower), { method: 'GET' });
        wordCheckCache[lower] = r.ok;
        if (r.ok) return true;
        if (lower.length >= 3 && lower.endsWith('s')) {
          const base = lower.slice(0, -1);
          const r2 = await fetch(DICT_API + encodeURIComponent(base), { method: 'GET' });
          const ok = r2.ok;
          wordCheckCache[lower] = ok;
          wordCheckCache[base] = ok;
          return ok;
        }
        if (lower.length >= 4 && lower.endsWith('ing')) {
          const base = lower.slice(0, -3);
          const r2 = await fetch(DICT_API + encodeURIComponent(base), { method: 'GET' });
          const ok = r2.ok;
          wordCheckCache[lower] = ok;
          wordCheckCache[base] = ok;
          return ok;
        }
        if (lower.length >= 3 && lower.endsWith('ed')) {
          const base = lower.slice(0, -2);
          const r2 = await fetch(DICT_API + encodeURIComponent(base), { method: 'GET' });
          const ok = r2.ok;
          wordCheckCache[lower] = ok;
          wordCheckCache[base] = ok;
          return ok;
        }
        return false;
      } catch (e) {
        delete wordCheckCache[lower];
        throw e;
      }
    }
    async function isRealActivity(name) {
      const trimmed = name.trim();
      if (trimmed.length < 2) return { ok: false, msg: 'Enter at least 2 characters.' };
      if (!/\p{L}/u.test(trimmed)) return { ok: false, msg: 'Add a real activity (with letters).' };
      if (/^[0-9\s\.\-]+$/.test(trimmed)) return { ok: false, msg: 'That doesn\'t look like an activity name.' };
      const lower = trimmed.toLowerCase();
      if (JUNK_NAMES.has(lower)) return { ok: false, msg: 'That doesn\'t look like a real activity.' };
      if (/^[a-z]\s*$/i.test(trimmed)) return { ok: false, msg: 'Use a real activity name.' };
      const words = [...new Set(lower.split(/\s+/).map(w => w.replace(/[^\p{L}0-9]/gu, '')).filter(Boolean))];
      const hasSlang = words.some(w => w.length > 0 && SLANG_OR_NONSENSE.has(w));
      if (hasSlang) return { ok: false, msg: 'Use a real activity (e.g. "Take vitamins", "Read", "Exercise").' };
      for (const w of words) {
        if (w.length < 2 || /^\d+$/.test(w)) continue;
        let valid = false;
        try {
          valid = await isWordInDictionary(w);
        } catch (err) {
          return { ok: false, msg: 'Couldn\'t check words (offline?). Try again.' };
        }
        if (!valid) return { ok: false, msg: '"' + w + '" isn\'t in the English dictionary. Use real words only.' };
      }
      return { ok: true };
    }
    function showStreakNameError(inputEl, errorEl, message) {
      if (errorEl) { errorEl.textContent = message; errorEl.classList.add('visible'); }
      if (inputEl) inputEl.classList.add('invalid');
    }
    function clearStreakNameError(inputEl, errorEl) {
      if (errorEl) { errorEl.textContent = ''; errorEl.classList.remove('visible'); }
      if (inputEl) inputEl.classList.remove('invalid');
    }

    let confirmPendingCallback = null;
    let confirmPendingOptions = null;

    function showConfirmCompletion(taskName, onConfirm, options) {
      document.getElementById('confirmTaskName').textContent = taskName;
      const now = new Date();
      const timeStr = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
      document.getElementById('confirmTimeInput').value = timeStr;
      document.getElementById('confirmOverlay').classList.add('open');
      document.getElementById('confirmOverlay').setAttribute('aria-hidden', 'false');
      confirmPendingCallback = onConfirm;
      confirmPendingOptions = options;
    }
    function closeConfirm() {
      document.getElementById('confirmOverlay').classList.remove('open');
      document.getElementById('confirmOverlay').setAttribute('aria-hidden', 'true');
      confirmPendingCallback = null;
      confirmPendingOptions = null;
    }
    const CELEBRATION_MESSAGES = ['You\'re on fire! ðŸ”¥', 'Quest champion! â­', 'Amazing! Keep it up! ðŸŒŸ', 'You did it! ðŸŽ‰', 'Streak superstar! âœ¨', 'Another one done! ðŸ’ª', 'So proud of you! ðŸ†', 'You\'re crushing it! ðŸš€'];
    function showCelebration(customMsg) {
      const msg = customMsg || CELEBRATION_MESSAGES[Math.floor(Math.random() * CELEBRATION_MESSAGES.length)];
      const toast = document.createElement('div');
      toast.className = 'celebration-toast';
      toast.textContent = msg;
      document.body.appendChild(toast);
      const colors = ['#ef6c00','#ff9800','#f9a825','#43a047','#e53935','#7e57c2'];
      for (let i = 0; i < 24; i++) {
        const p = document.createElement('div');
        p.className = 'confetti-piece';
        p.style.left = (30 + Math.random() * 40) + '%';
        p.style.top = '40%';
        p.style.background = colors[i % colors.length];
        p.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        const tx = (Math.random() - 0.5) * 150;
        const ty = 80 + Math.random() * 80;
        p.style.animation = `confettiFall ${0.8 + Math.random() * 0.4}s ease-out forwards`;
        p.style.setProperty('--tx', tx + 'px');
        p.style.setProperty('--ty', ty + 'px');
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 1200);
      }
      setTimeout(() => { toast.remove(); }, 1200);
    }
    document.getElementById('confirmYes').addEventListener('click', () => {
      if (confirmPendingCallback) {
        const timeInput = document.getElementById('confirmTimeInput');
        const userTime = timeInput && timeInput.value ? timeInput.value : null;
        const totalBefore = getTotalTodayQuests();
        confirmPendingCallback(userTime, false);
        closeConfirm();
        playSuccessSound();
        if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
        const doneAfter = getDoneTodayCount();
        const allDoneNow = totalBefore > 0 && doneAfter >= totalBefore;
        showCelebration(allDoneNow ? 'ðŸŽ‰ All quests done today! You\'re a star! âœ¨' : null);
      }
    });
    document.getElementById('confirmCancel').addEventListener('click', closeConfirm);
    document.getElementById('confirmOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'confirmOverlay') closeConfirm();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (document.getElementById('parentGateOverlay').classList.contains('open')) { hideParentGate(); pendingParentPanel = false; }
        else if (document.getElementById('confirmOverlay').classList.contains('open')) closeConfirm();
        else if (document.getElementById('menuCheck') && document.getElementById('menuCheck').checked) closeMenu();
      }
    });

    document.getElementById('buySaverBtn').addEventListener('click', buyStreakSaver);

    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById('taskInput');
      const name = input.value.trim();
      const errorEl = document.getElementById('streakNameError');
      const submitBtn = document.querySelector('#addForm button[type="submit"]');
      clearStreakNameError(input, errorEl);
      if (!name) return;
      if (submitBtn) { submitBtn.textContent = 'Checkingâ€¦'; submitBtn.disabled = true; }
      const check = await isRealActivity(name);
      if (submitBtn) { submitBtn.textContent = 'Add'; submitBtn.disabled = false; }
      if (!check.ok) {
        showStreakNameError(input, errorEl, check.msg);
        return;
      }

      const timeInput = document.getElementById('streakTimeInput');
      const preferredTime = timeInput ? timeInput.value : '';
      if (!preferredTime) {
        showStreakNameError(timeInput, errorEl, 'Please pick a time.');
        return;
      }

      const streaks = loadStreaks();
      streaks.push({
        id: Date.now().toString(),
        name,
        streak: 0,
        lastDone: null,
        preferredTime
      });
      saveStreaks(streaks);
      input.value = '';
      if (timeInput) timeInput.value = '';
      clearStreakNameError(input, errorEl);
      render();
    });
    document.getElementById('taskInput').addEventListener('input', () => {
      clearStreakNameError(document.getElementById('taskInput'), document.getElementById('streakNameError'));
    });
    const timeInputEl = document.getElementById('streakTimeInput');
    if (timeInputEl) timeInputEl.addEventListener('input', () => {
      clearStreakNameError(timeInputEl, document.getElementById('streakNameError'));
    });

    document.getElementById('reminderForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const emailEl = document.getElementById('reminderEmail');
      const timeEl = document.getElementById('reminderTime');
      const inAppEl = document.getElementById('reminderInApp');
      const msgEl = document.getElementById('reminderSavedMsg');
      const email = (emailEl && emailEl.value) ? emailEl.value.trim() : '';
      const time = (timeEl && timeEl.value) ? timeEl.value : '09:00';
      const inApp = inAppEl ? inAppEl.checked : true;
      if (!email) {
        if (emailEl) emailEl.focus();
        return;
      }
      const simpleEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!simpleEmail.test(email)) {
        if (msgEl) { msgEl.textContent = 'Please enter a valid email address.'; msgEl.style.display = 'block'; msgEl.style.color = 'var(--accent)'; }
        return;
      }
      saveReminderSettings({ email, time, inApp });
      if (msgEl) {
        msgEl.textContent = 'Saved. You\'ll get a reminder at ' + time + (inApp ? ' (and in the app).' : '.');
        msgEl.style.display = 'block';
        msgEl.style.color = '';
      }
    });

    const reminderBanner = document.getElementById('inAppReminderBanner');
    if (reminderBanner) reminderBanner.querySelector('.in-app-reminder-dismiss').addEventListener('click', dismissInAppReminder);

    function showInstallPromptInActivePanel() {
      if (sessionStorage.getItem('streaks-install-dismissed-session') === '1') return;
      if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) return;
      const activePanel = document.querySelector('.panel.active');
      if (!activePanel) return;
      const banner = activePanel.querySelector('[data-install-prompt]');
      if (banner) banner.style.display = 'flex';
    }
    function hideAllInstallPrompts() {
      sessionStorage.setItem('streaks-install-dismissed-session', '1');
      document.querySelectorAll('[data-install-prompt]').forEach(b => b.style.display = 'none');
    }
    function switchPanel(panel) {
      document.querySelectorAll('.menu-item').forEach(b => {
        b.classList.toggle('active', b.dataset.panel === panel);
      });
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      const panelId = 'panel' + panel.charAt(0).toUpperCase() + panel.slice(1);
      const el = document.getElementById(panelId);
      if (el) el.classList.add('active');
      showInstallPromptInActivePanel();
      if (panel === 'calendar') {
        renderCalendar();
        renderDayView();
      } else if (panel === 'streaktopia') {
        renderStreaktopia();
      } else if (panel === 'reminders') {
        renderReminders();
      } else if (panel === 'gamehub') {
        renderGamehub();
      } else if (panel === 'achievements') {
        renderAchievements();
      } else if (panel === 'settings') {
        renderSettings();
      } else if (panel === 'stats') {
        renderStats();
      } else if (panel === 'forParents') {
        renderForParents();
      } else {
        render();
      }
    }

    function renderSettings() {
      const s = loadSettings();
      const soundsCheck = document.getElementById('soundsCheck');
      if (soundsCheck) { soundsCheck.checked = s.sounds; soundsCheck.onchange = () => { saveSettings({ ...loadSettings(), sounds: soundsCheck.checked }); }; }
      const hideCompletedCheck = document.getElementById('hideCompletedCheck');
      if (hideCompletedCheck) { hideCompletedCheck.checked = s.hideCompleted; hideCompletedCheck.onchange = () => { saveSettings({ ...loadSettings(), hideCompleted: hideCompletedCheck.checked }); render(); }; }
      const notifBtn = document.getElementById('requestNotificationBtn');
      if (notifBtn) {
        if ('Notification' in window && Notification.permission === 'granted') notifBtn.textContent = 'âœ“ Notifications enabled';
        notifBtn.onclick = () => {
          if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(p => { notifBtn.textContent = p === 'granted' ? 'âœ“ Notifications enabled' : 'ðŸ”” Enable notifications'; });
          } else if (Notification.permission === 'granted') notifBtn.textContent = 'âœ“ Notifications enabled';
        };
      }
      const darkCheck = document.getElementById('darkModeCheck');
      if (darkCheck) {
        darkCheck.checked = s.darkMode;
        darkCheck.onchange = () => {
          saveSettings({ ...loadSettings(), darkMode: darkCheck.checked });
          document.body.classList.toggle('dark-mode', darkCheck.checked);
        };
      }
      const theme = (loadSettings().theme || 'default');
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
        btn.onclick = () => {
          const t = btn.dataset.theme;
          saveSettings({ ...loadSettings(), theme: t });
          document.body.className = 'theme-' + t;
          if (loadSettings().darkMode) document.body.classList.add('dark-mode');
          renderSettings();
        };
      });
      document.body.className = 'theme-' + theme;
      if (s.darkMode) document.body.classList.add('dark-mode');
    }
    function getCompletionHistory() {
      const history = [];
      const activities = loadCalendarActivities();
      const streaks = loadStreaks();
      for (let i = 27; i >= 0; i--) {
        const d = new Date(); d.setDate(d.getDate() - i);
        const key = dateToKey(d);
        let count = 0;
        streaks.forEach(s => { if (s.lastDone === d.toDateString()) count++; });
        activities.forEach(a => {
          if (a.type === 'once' && (a.date || a.startDate) === key && a.completed) count++;
          if (a.type !== 'once' && Array.isArray(a.completedDates) && a.completedDates.includes(key)) count++;
        });
        history.push({ date: key, count });
      }
      return history;
    }
    function getConsecutiveDaysWithActivity() {
      const activities = loadCalendarActivities();
      const streaks = loadStreaks();
      let count = 0;
      for (let i = 0; i < 365; i++) {
        const d = new Date(); d.setDate(d.getDate() - i);
        const key = dateToKey(d);
        const dateStr = d.toDateString();
        let dayCount = 0;
        streaks.forEach(s => { if (s.lastDone === dateStr) dayCount++; });
        activities.forEach(a => {
          if (a.type === 'once' && (a.date || a.startDate) === key && a.completed) dayCount++;
          if (a.type !== 'once' && Array.isArray(a.completedDates) && a.completedDates.includes(key)) dayCount++;
        });
        if (dayCount > 0) count++; else break;
      }
      return count;
    }
    function renderStats() {
      const gemData = loadGemData();
      const maxStreak = getMaxStreak();
      const consecutiveDays = getConsecutiveDaysWithActivity();
      const history = getCompletionHistory();
      const mostProductiveDay = getMostProductiveDay();
      const grid = document.getElementById('statsGrid');
      if (grid) {
        grid.innerHTML = `
          <div class="stat-card"><div class="value">${gemData.totalQuestsCompleted || 0}</div><div class="label">Total quests done</div></div>
          <div class="stat-card"><div class="value">${maxStreak}</div><div class="label">Best streak</div></div>
          <div class="stat-card"><div class="value">${consecutiveDays}</div><div class="label">Days active in a row</div></div>
          <div class="stat-card"><div class="value">${gemData.gems}</div><div class="label">Gems</div></div>
          <div class="stat-card"><div class="value">${gemData.streakSavers || 0}</div><div class="label">Savers</div></div>
          ${mostProductiveDay ? `<div class="stat-card"><div class="value">${mostProductiveDay}</div><div class="label">Most productive day</div></div>` : ''}
        `;
      }
      const heatmap = document.getElementById('streakHeatmap');
      if (heatmap) {
        heatmap.innerHTML = history.map(h => {
          const hasActivity = h.count > 0;
          const intensity = hasActivity ? (h.count >= 5 ? 'heavy' : h.count >= 2 ? 'medium' : 'light') : '';
          return `<div class="heatmap-day ${hasActivity ? 'done ' + intensity : ''}" title="${h.date}: ${h.count} quest${h.count !== 1 ? 's' : ''} done"></div>`;
        }).join('');
      }
      const shareBtn = document.getElementById('shareAchievementBtn');
      if (shareBtn) shareBtn.onclick = () => shareProgress();
    }
    function shareProgress() {
      const gemData = loadGemData();
      const maxStreak = getMaxStreak();
      const consecutiveDays = getConsecutiveDaysWithActivity();
      const lines = [];
      if (maxStreak > 0) lines.push(`ðŸ”¥ My best streak: ${maxStreak} days`);
      if ((gemData.totalQuestsCompleted || 0) > 0) lines.push(`âœ… ${gemData.totalQuestsCompleted} quests completed`);
      if (consecutiveDays > 0) lines.push(`ðŸ“… ${consecutiveDays} days in a row`);
      const stats = lines.length ? lines.join(' Â· ') + '\n\n' : '';
      const text = stats + `I'm building habits with Streakify â€” turn daily tasks into quests, earn gems, and grow your city! Try it free ðŸ‘‰`;
      const url = window.location.href;
      if (navigator.share) {
        navigator.share({ title: 'My Streakify Progress ðŸ”¥', text, url }).catch(() => { navigator.clipboard.writeText(text + ' ' + url); showShareToast('Copied! Share it anywhere.'); });
      } else {
        navigator.clipboard.writeText(text + ' ' + url).then(() => showShareToast('Copied! Paste to share.'));
      }
    }
    function showShareToast(msg) {
      const toast = document.createElement('div');
      toast.className = 'streaktopia-toast';
      toast.style.cssText = 'bottom:auto;top:4rem;left:50%;transform:translateX(-50%);';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }
    function renderForParents() {
      const weeklyGoalInput = document.getElementById('weeklyGoalTargetInput');
      const weeklyGoalSave = document.getElementById('weeklyGoalTargetSave');
      if (weeklyGoalInput) weeklyGoalInput.value = getWeeklyGoalTarget();
      if (weeklyGoalSave && weeklyGoalInput) {
        weeklyGoalSave.onclick = () => {
          const v = parseInt(weeklyGoalInput.value, 10);
          if (!isNaN(v) && v >= 1 && v <= 20) {
            saveWeeklyGoalTarget(v);
            alert('Weekly goal saved!');
          }
        };
      }
      const rewardInput = document.getElementById('parentRewardInputForParents');
      const rewardSave = document.getElementById('parentRewardSaveForParents');
      if (rewardInput) rewardInput.value = loadParentReward();
      if (rewardSave && rewardInput) {
        rewardSave.onclick = () => {
          const val = rewardInput.value.trim();
          try {
            localStorage.setItem(PARENT_REWARD_KEY, val);
            rewardInput.value = val;
            const toast = document.createElement('div');
            toast.className = 'streaktopia-toast';
            toast.style.cssText = 'bottom:auto;top:4rem;left:50%;transform:translateX(-50%);';
            toast.textContent = 'Reward saved! âœ“';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
          } catch (e) {
            alert('Could not save. Try again.');
          }
        };
      }
      const customInput = document.getElementById('customBadgeInput');
      const customSave = document.getElementById('customBadgeSave');
      if (customSave && customInput) {
        customSave.onclick = () => {
          const name = customInput.value.trim();
          if (!name) return;
          try {
            const raw = localStorage.getItem(CUSTOM_BADGES_KEY);
            const badges = raw ? JSON.parse(raw) : [];
            badges.push({ id: 'custom-' + Date.now(), name, emoji: 'ðŸ…' });
            localStorage.setItem(CUSTOM_BADGES_KEY, JSON.stringify(badges));
            customInput.value = '';
            alert('Custom badge added! It will appear in Achievements.');
          } catch (e) {}
        };
      }
    }

    function isStreakAvailableNow(streak) {
      if (!streak.preferredTime || !/^\d{1,2}:\d{2}$/.test(streak.preferredTime)) return true;
      const now = new Date();
      const [h, m] = streak.preferredTime.split(':').map(Number);
      const preferredMins = h * 60 + m;
      const nowMins = now.getHours() * 60 + now.getMinutes();
      return nowMins >= preferredMins;
    }
    function getStreakFreezesUsedThisWeek() {
      try {
        const raw = localStorage.getItem(STREAK_FREEZE_KEY);
        const data = raw ? JSON.parse(raw) : {};
        const weekStart = getWeekStart().toDateString();
        return (data[weekStart] || 0);
      } catch { return 0; }
    }
    function useFreeStreakFreeze(id) {
      const used = getStreakFreezesUsedThisWeek();
      if (used >= 1) return false;
      const weekStart = getWeekStart().toDateString();
      const data = (() => { try { const r = localStorage.getItem(STREAK_FREEZE_KEY); return r ? JSON.parse(r) : {}; } catch { return {}; } })();
      data[weekStart] = (data[weekStart] || 0) + 1;
      localStorage.setItem(STREAK_FREEZE_KEY, JSON.stringify(data));
      const streaks = loadStreaks();
      const item = streaks.find(s => s.id === id);
      if (!item) return false;
      const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
      if (item.lastDone !== yesterday.toDateString()) return false;
      item.lastDone = todayStr();
      item.streak += 1;
      saveStreaks(streaks);
      return true;
    }
    function checkDailyLoginBonus() {
      const today = todayStr();
      const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); const yesterdayStr = yesterday.toDateString();
      try {
        const raw = localStorage.getItem(DAILY_BONUS_KEY);
        const data = raw ? JSON.parse(raw) : {};
        if (data.lastClaim === today) return;
        const streak = data.lastClaim === yesterdayStr ? (data.loginStreak || 0) + 1 : 1;
        data.lastClaim = today;
        data.loginStreak = streak;
        localStorage.setItem(DAILY_BONUS_KEY, JSON.stringify(data));
        const bonus = streak >= 7 ? 10 : streak >= 3 ? 5 : 2;
        const gemData = loadGemData();
        gemData.gems += bonus;
        saveGemData(gemData);
        const toast = document.createElement('div');
        toast.className = 'streaktopia-toast';
        toast.style.cssText = 'bottom:auto;top:4rem;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#43a047,#66bb6a);color:#fff;';
        toast.textContent = `ðŸŽ Daily login! +${bonus} gems (${streak} day streak)`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2500);
      } catch (e) {}
    }

    function isGamehubUnlocked() {
      const today = todayStr();
      const todayKey = dateToKey(new Date());
      const streaks = loadStreaks();
      const todayActivities = getActivitiesForDate(todayKey);
      const availableStreaks = streaks.filter(s => isStreakAvailableNow(s));
      const allAvailableStreaksDone = availableStreaks.length === 0 || availableStreaks.every(s => s.lastDone === today);
      const allActivitiesDone = todayActivities.length === 0 || todayActivities.every(a => a.completed);
      return allAvailableStreaksDone && allActivitiesDone;
    }

    function getGamehubProgress() {
      const today = todayStr();
      const todayKey = dateToKey(new Date());
      const streaks = loadStreaks();
      const todayActivities = getActivitiesForDate(todayKey);
      const availableStreaks = streaks.filter(s => isStreakAvailableNow(s));
      const streaksDone = availableStreaks.filter(s => s.lastDone === today).length;
      const activitiesDone = todayActivities.filter(a => a.completed).length;
      const total = availableStreaks.length + todayActivities.length;
      const done = streaksDone + activitiesDone;
      if (total === 0) return 'No streaks or activities due yet â€“ GameHub is unlocked!';
      const laterCount = streaks.length - availableStreaks.length;
      const laterStr = laterCount > 0 ? ` (${laterCount} later today)` : '';
      return `${done} of ${total} done${laterStr}`;
    }

    function renderGamehub() {
      const unlocked = isGamehubUnlocked();
      document.getElementById('gamehubLocked').style.display = unlocked ? 'none' : 'block';
      document.getElementById('gamehubUnlocked').style.display = unlocked ? 'block' : 'none';
      document.getElementById('gamehubPlayArea').style.display = 'none';
      document.getElementById('gamehubProgress').textContent = getGamehubProgress();
      const grid = document.getElementById('gamehubGamesGrid');
      grid.innerHTML = GAMEHUB_GAMES.map(g => `
        <button type="button" class="gamehub-game-card" data-game="${g.id}" style="background:${g.gradient}">
          <span class="gamehub-game-emoji">${g.emoji}</span>
          <span class="gamehub-game-name">${escapeHtml(g.name)}</span>
          <span class="gamehub-game-desc">${escapeHtml(g.desc)}</span>
        </button>
      `).join('');
      grid.querySelectorAll('.gamehub-game-card').forEach(btn => {
        btn.onclick = () => { if (unlocked) showGamehubGame(btn.dataset.game); };
      });
    }
    document.getElementById('gamehubBack').addEventListener('click', () => {
      if (gamehubReplayTimeout) { clearTimeout(gamehubReplayTimeout); gamehubReplayTimeout = null; }
      document.getElementById('gamehubPlayArea').style.display = 'none';
      document.getElementById('gamehubUnlocked').style.display = 'block';
    });

    const gameHubHelpers = {
      confetti(container, count = 40) {
        const colors = ['#ff6b6b','#4ecdc4','#ffe66d','#95e1d3','#f38181','#aa96da','#fcbad3','#a8d8ea'];
        const emojis = ['âœ¨','â­','ðŸŒŸ','ðŸ’«','ðŸŽ‰','ðŸ†','ðŸ’Ž','ðŸ”¥'];
        const rect = (container || document.body).getBoundingClientRect();
        const cx = rect.left + rect.width / 2, cy = rect.top + rect.height / 2;
        for (let i = 0; i < count; i++) {
          const el = document.createElement('div');
          el.className = 'confetti-piece';
          el.style.cssText = 'left:' + (cx + (Math.random() - 0.5) * 80) + 'px;top:' + cy + 'px;font-size:' + (12 + Math.random() * 12) + 'px;--tx:' + ((Math.random() - 0.5) * 200) + 'px;--ty:' + (80 + Math.random() * 120) + 'px;animation:confettiFall 1.2s ease-out forwards;';
          el.textContent = Math.random() > 0.5 ? emojis[Math.floor(Math.random() * emojis.length)] : '';
          el.style.background = el.textContent ? 'transparent' : colors[Math.floor(Math.random() * colors.length)];
          if (!el.textContent) el.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
          document.body.appendChild(el);
          setTimeout(() => el.remove(), 1200);
        }
      },
      winToast(msg, emoji = 'ðŸŽ‰') {
        const t = document.createElement('div');
        t.className = 'gamehub-win-box';
        t.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:300;';
        t.innerHTML = '<div class="gamehub-win-emoji">' + emoji + '</div><div style="font-weight:700;font-size:1.2rem;">' + msg + '</div>';
        document.body.appendChild(t);
        setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 800);
      },
      playTone(freq, duration) {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          gain.gain.setValueAtTime(0.15, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
          osc.start(ctx.currentTime);
          osc.stop(ctx.currentTime + duration);
        } catch (e) {}
      }
    };

    let gamehubReplayTimeout = null;
    function scheduleGamehubReplay(gameId, delay) {
      if (gamehubReplayTimeout) clearTimeout(gamehubReplayTimeout);
      gamehubReplayTimeout = setTimeout(() => {
        gamehubReplayTimeout = null;
        showGamehubGame(gameId);
      }, delay || 2000);
    }
    function gameWin(container, gameId, delay, msg, emoji) {
      const area = container || document.getElementById('gamehubGameContent');
      if (area) gameHubHelpers.confetti(area, 50);
      gameHubHelpers.playTone(523, 0.08);
      setTimeout(() => gameHubHelpers.playTone(659, 0.08), 80);
      setTimeout(() => gameHubHelpers.playTone(784, 0.12), 160);
      if (msg) gameHubHelpers.winToast(msg, emoji || 'ðŸŽ‰');
      scheduleGamehubReplay(gameId, delay || 2200);
    }
    function showGamehubGame(gameId) {
      if (gamehubReplayTimeout) { clearTimeout(gamehubReplayTimeout); gamehubReplayTimeout = null; }
      document.getElementById('gamehubUnlocked').style.display = 'none';
      document.getElementById('gamehubPlayArea').style.display = 'block';
      const content = document.getElementById('gamehubGameContent');
      content.innerHTML = '';
      const playArea = document.getElementById('gamehubPlayArea');
      playArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
      const runners = { reaction: runReactionGame, tap: runTapGame, memory: runMemoryGame, snake: runSnakeGame, whack: runWhackGame, typing: runTypingGame, color: runColorGame, number: runNumberGame, simon: runSimonGame, breakout: runBreakoutGame, trivia: runTriviaGame, dice: runDiceGame, rps: runRpsGame, higher: runHigherGame, tictactoe: runTictactoeGame, hangman: runHangmanGame, mathquiz: runMathQuizGame, catch: runCatchGame, flappy: runFlappyGame, wordscramble: runWordScrambleGame, pong: runPongGame, target: runTargetGame, minesweeper: runMinesweeperGame, puzzle: runPuzzleGame, tetris: runTetrisGame, coinflip: runCoinflipGame, blackjack: runBlackjackGame, oddone: runOddoneGame, lightsout: runLightsoutGame, dodge: runDodgeGame, spaceshooter: runSpaceshooterGame, catchletters: runCatchlettersGame, bounce: runBounceGame, maze: runMazeGame, guess: runGuessGame, game2048: runGame2048Game, sumten: runSumtenGame, connect4: runConnect4Game, anagrams: runAnagramsGame, truefalse: runTruefalseGame, splat: runSplatGame, spinner: runSpinnerGame, treasure: runTreasureGame, wordchain: runWordchainGame, fruitninja: runFruitninjaGame };
      if (runners[gameId]) runners[gameId](content);
    }

    function runReactionGame(container) {
      const inst = document.createElement('p');
      inst.textContent = 'Wait for the button to turn green, then click as fast as you can!';
      inst.className = 'gamehub-instruction';
      container.appendChild(inst);
      const wrap = document.createElement('div');
      wrap.style.cssText = 'display:flex;justify-content:center;padding:1rem 0;';
      const btn = document.createElement('button');
      btn.className = 'gamehub-reaction-btn waiting';
      btn.textContent = 'Wait...';
      btn.disabled = true;
      wrap.appendChild(btn);
      container.appendChild(wrap);
      const delay = 1500 + Math.random() * 2500;
      let greenTime = 0;
      setTimeout(() => {
        greenTime = Date.now();
        btn.className = 'gamehub-reaction-btn ready';
        btn.textContent = 'CLICK!';
        btn.disabled = false;
        btn.onclick = () => {
          const ms = Math.round(Date.now() - greenTime);
          btn.textContent = ms + ' ms';
          btn.onclick = null;
          gameHubHelpers.playTone(784, 0.15);
          gameWin(wrap, 'reaction', 2000, ms + ' ms â€” Great reflexes!', 'âš¡');
        };
      }, delay);
    }

    function runTapGame(container) {
      let count = 0;
      const target = 10;
      const startTime = Date.now();
      const p = document.createElement('p');
      p.style.marginBottom = '0.5rem';
      p.textContent = `Tap ${target} times as fast as you can!`;
      const progress = document.createElement('p');
      progress.style.cssText = 'font-size:0.9rem;color:var(--text-muted);margin-bottom:1rem;';
      progress.textContent = count + '/' + target;
      const btn = document.createElement('button');
      btn.className = 'gamehub-tap-btn';
      btn.textContent = '0';
      container.appendChild(p);
      container.appendChild(progress);
      container.appendChild(btn);
      btn.onclick = () => {
        count++;
        btn.textContent = count;
        progress.textContent = count + '/' + target;
        if (count >= target) {
          const ms = Date.now() - startTime;
          p.textContent = (ms / 1000).toFixed(2) + ' seconds!';
          progress.textContent = '';
          btn.textContent = 'Done!';
          btn.disabled = true;
          gameWin(container, 'tap', 2000, (ms / 1000).toFixed(2) + 's â€” Lightning fast!', 'ðŸ‘†');
        }
      };
    }

    function runMemoryGame(container) {
      const inst = document.createElement('p');
      inst.textContent = 'Find all matching pairs!';
      inst.className = 'gamehub-instruction';
      container.appendChild(inst);
      const emojis = ['ðŸ”¥','â­','ðŸ’Ž','ðŸ†','ðŸŽ¯','ðŸŒŸ','ðŸ’«','âœ¨'];
      const pairs = [...emojis.slice(0,4), ...emojis.slice(0,4)].sort(() => Math.random() - 0.5);
      const grid = document.createElement('div');
      grid.className = 'gamehub-memory-grid';
      const cards = pairs.map((emoji, i) => {
        const card = document.createElement('button');
        card.className = 'gamehub-memory-card';
        card.dataset.emoji = emoji;
        card.dataset.index = i;
        card.textContent = '?';
        card.type = 'button';
        return card;
      });
      cards.forEach(c => grid.appendChild(c));
      container.appendChild(grid);
      let flipped = [];
      cards.forEach(card => {
        card.onclick = () => {
          if (card.classList.contains('flipped') || card.classList.contains('matched')) return;
          card.classList.add('flipped');
          card.textContent = card.dataset.emoji;
          flipped.push(card);
          if (flipped.length === 2) {
            if (flipped[0].dataset.emoji === flipped[1].dataset.emoji) {
              flipped.forEach(c => { c.classList.add('matched'); c.onclick = null; });
              gameHubHelpers.playTone(523, 0.1);
              if (document.querySelectorAll('.gamehub-memory-card:not(.matched)').length === 0) {
                gameWin(container, 'memory', 1200, 'All pairs matched!', 'ðŸ§ ');
              }
            } else {
              flipped.forEach(c => c.classList.add('wrong'));
              gameHubHelpers.playTone(200, 0.15);
              setTimeout(() => {
                flipped.forEach(c => { c.classList.remove('flipped', 'wrong'); c.textContent = '?'; });
              }, 500);
            }
            flipped = [];
          }
        };
      });
    }

    function runSnakeGame(container) {
      const size = 12;
      const cellSize = 28;
      let snake = [{x: 5, y: 5}];
      let dir = {x: 1, y: 0};
      let food = {x: 8, y: 8};
      let score = 0;
      let gameLoop;
      const canvas = document.createElement('div');
      canvas.style.cssText = `display:grid;grid-template-columns:repeat(${size},${cellSize}px);gap:1px;width:fit-content;background:#1a1a2e;padding:4px;border-radius:12px;`;
      const cells = [];
      for (let y = 0; y < size; y++) for (let x = 0; x < size; x++) {
        const c = document.createElement('div');
        c.style.cssText = `width:${cellSize-2}px;height:${cellSize-2}px;background:#16213e;border-radius:4px;`;
        c.dataset.x = x; c.dataset.y = y;
        cells.push(c); canvas.appendChild(c);
      }
      const scoreEl = document.createElement('p');
      scoreEl.style.cssText = 'margin:0 0 0.5rem 0;font-weight:700;';
      const render = () => {
        cells.forEach(c => { c.style.background = '#16213e'; c.textContent = ''; });
        snake.forEach((p, i) => {
          const el = cells.find(c => +c.dataset.x === p.x && +c.dataset.y === p.y);
          if (el) el.style.background = i === 0 ? '#43a047' : '#66bb6a';
        });
        const f = cells.find(c => +c.dataset.x === food.x && +c.dataset.y === food.y);
        if (f) { f.style.background = '#e53935'; f.textContent = 'ðŸŽ'; }
        scoreEl.textContent = 'Score: ' + score;
      };
      const tick = () => {
        const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };
        if (head.x < 0 || head.x >= size || head.y < 0 || head.y >= size || snake.some(s => s.x === head.x && s.y === head.y)) {
          clearInterval(gameLoop);
          scoreEl.textContent = 'Game Over! Score: ' + score;
          scheduleGamehubReplay('snake', 2500);
          return;
        }
        snake.unshift(head);
        if (head.x === food.x && head.y === food.y) {
          score++;
          food = { x: Math.floor(Math.random() * size), y: Math.floor(Math.random() * size) };
          while (snake.some(s => s.x === food.x && s.y === food.y)) food = { x: Math.floor(Math.random() * size), y: Math.floor(Math.random() * size) };
        } else snake.pop();
        render();
      };
      document.addEventListener('keydown', keyHandler);
      function keyHandler(e) {
        if (e.key === 'ArrowUp' && dir.y === 0) dir = {x: 0, y: -1};
        else if (e.key === 'ArrowDown' && dir.y === 0) dir = {x: 0, y: 1};
        else if (e.key === 'ArrowLeft' && dir.x === 0) dir = {x: -1, y: 0};
        else if (e.key === 'ArrowRight' && dir.x === 0) dir = {x: 1, y: 0};
      }
      container.appendChild(scoreEl);
      container.appendChild(canvas);
      render();
      gameLoop = setInterval(tick, 150);
    }

    function runWhackGame(container) {
      const inst = document.createElement('p');
      inst.textContent = 'Whack the moles before they hide!';
      inst.className = 'gamehub-instruction';
      container.appendChild(inst);
      const holes = 9;
      let score = 0;
      let timeLeft = 15;
      let moleTimer;
      const grid = document.createElement('div');
      grid.className = 'gamehub-memory-grid';
      grid.style.gridTemplateColumns = 'repeat(3, 1fr)';
      const scoreEl = document.createElement('p');
      scoreEl.style.cssText = 'margin:0 0 0.5rem 0;font-weight:700;';
      const timeEl = document.createElement('p');
      timeEl.style.marginBottom = '0.5rem';
      for (let i = 0; i < holes; i++) {
        const btn = document.createElement('button');
        btn.style.cssText = 'aspect-ratio:1;font-size:2rem;background:#5d4037;border:3px solid #3e2723;border-radius:12px;cursor:pointer;';
        btn.onclick = () => { if (btn.textContent === 'ðŸ¹') { score++; btn.textContent = ''; scoreEl.textContent = 'Score: ' + score; } };
        grid.appendChild(btn);
      }
      const showMole = () => {
        const idx = Math.floor(Math.random() * holes);
        grid.children[idx].textContent = 'ðŸ¹';
        setTimeout(() => { if (grid.children[idx].textContent === 'ðŸ¹') grid.children[idx].textContent = ''; }, 800);
      };
      container.appendChild(scoreEl);
      container.appendChild(timeEl);
      container.appendChild(grid);
      moleTimer = setInterval(showMole, 600);
      const countdown = setInterval(() => {
        timeLeft--;
        timeEl.textContent = 'Time: ' + timeLeft + 's';
        if (timeLeft <= 0) { clearInterval(moleTimer); clearInterval(countdown); scoreEl.textContent = 'Final: ' + score; scheduleGamehubReplay('whack', 2000); }
      }, 1000);
      timeEl.textContent = 'Time: ' + timeLeft + 's';
      scoreEl.textContent = 'Score: 0';
    }

    function runTypingGame(container) {
      const words = ['streak','habit','focus','daily','goals','flame','build','grow','quest','track','win','plan','task','done','best'];
      const word = words[Math.floor(Math.random() * words.length)];
      const p = document.createElement('p');
      p.style.cssText = 'font-size:1.5rem;margin-bottom:0.5rem;font-weight:700;';
      p.textContent = 'Type this word:';
      const wordEl = document.createElement('p');
      wordEl.style.cssText = 'font-size:1.8rem;letter-spacing:0.1em;margin-bottom:1rem;color:var(--primary);';
      wordEl.textContent = word;
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.style.cssText = 'width:100%;padding:0.75rem;font-size:1.2rem;border:2px solid var(--border);border-radius:8px;';
      inp.autofocus = true;
      inp.oninput = () => {
        if (inp.value.toLowerCase() === word) {
          wordEl.textContent = 'Correct!';
          wordEl.style.color = '#2e7d32';
          inp.disabled = true;
          gameHubHelpers.playTone(523, 0.15);
          gameWin(container, 'typing', 1200, 'Perfect typing!', 'âŒ¨ï¸');
        }
      };
      container.appendChild(p);
      container.appendChild(wordEl);
      container.appendChild(inp);
    }

    function runColorGame(container) {
      const colors = ['#e53935','#43a047','#1e88e5','#fdd835'];
      const target = colors[Math.floor(Math.random() * colors.length)];
      const p = document.createElement('p');
      p.style.cssText = 'font-size:1.2rem;margin-bottom:1rem;';
      p.textContent = 'Click when the circle matches the color below!';
      const targetEl = document.createElement('div');
      targetEl.style.cssText = `width:60px;height:60px;border-radius:50%;background:${target};margin:0 auto 1rem;`;
      const btn = document.createElement('button');
      btn.style.cssText = 'width:120px;height:120px;border-radius:50%;border:none;cursor:pointer;font-size:1rem;';
      let current = colors[0];
      let colorIdx = 0;
      const cycle = () => { colorIdx = (colorIdx + 1) % colors.length; current = colors[colorIdx]; btn.style.background = current; };
      btn.style.background = current;
      const interval = setInterval(cycle, 400 + Math.random() * 300);
      btn.onclick = () => {
        clearInterval(interval);
        if (current === target) { btn.textContent = 'Win!'; gameHubHelpers.playTone(523, 0.15); gameWin(container, 'color', 1200, 'Color match!', 'ðŸŽ¨'); }
        else { btn.textContent = 'Miss!'; gameHubHelpers.playTone(200, 0.1); scheduleGamehubReplay('color', 1200); }
      };
      container.appendChild(p);
      container.appendChild(targetEl);
      container.appendChild(btn);
    }

    function runNumberGame(container) {
      let next = 1;
      const p = document.createElement('p');
      p.style.marginBottom = '1rem';
      p.textContent = 'Tap numbers 1 to 10 in order!';
      const grid = document.createElement('div');
      grid.style.cssText = 'display:grid;grid-template-columns:repeat(5,1fr);gap:0.5rem;';
      for (let i = 1; i <= 10; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.style.cssText = 'padding:1rem;font-size:1.2rem;font-weight:700;border-radius:8px;border:2px solid var(--border);background:var(--bg-elevated);cursor:pointer;';
        btn.onclick = () => {
          if (+btn.textContent === next) {
            next++;
            btn.style.background = '#43a047';
            btn.style.color = '#fff';
            btn.disabled = true;
            if (next > 10) { p.textContent = 'Done!'; gameWin(container, 'number', 1200, 'Number chain complete!', 'ðŸ”¢'); }
          }
        };
        grid.appendChild(btn);
      }
      container.appendChild(p);
      container.appendChild(grid);
    }

    function runSimonGame(container) {
      const colors = ['#e53935','#1e88e5','#fdd835','#43a047'];
      let sequence = [];
      let playerIdx = 0;
      const p = document.createElement('p');
      p.style.marginBottom = '1rem';
      const grid = document.createElement('div');
      grid.style.cssText = 'display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;max-width:200px;margin:0 auto;';
      colors.forEach((col, i) => {
        const btn = document.createElement('button');
        btn.style.cssText = `aspect-ratio:1;background:${col};border:none;border-radius:12px;cursor:pointer;opacity:1;`;
        btn.dataset.idx = i;
        btn.onclick = () => {
          if (playerIdx >= sequence.length) return;
          btn.style.opacity = '0.5';
          setTimeout(() => btn.style.opacity = '1', 200);
          if (+btn.dataset.idx !== sequence[playerIdx]) { p.textContent = 'Wrong! Score: ' + sequence.length; scheduleGamehubReplay('simon', 1500); return; }
          playerIdx++;
          if (playerIdx >= sequence.length) {
            sequence.push(Math.floor(Math.random() * 4));
            playerIdx = 0;
            p.textContent = 'Level ' + sequence.length + ' - Watch!';
            sequence.forEach((idx, i) => setTimeout(() => { grid.children[idx].style.opacity = '0.5'; setTimeout(() => grid.children[idx].style.opacity = '1', 300); }, 600 + i * 600));
            setTimeout(() => { p.textContent = 'Your turn!'; }, 600 + sequence.length * 600);
          }
        };
        grid.appendChild(btn);
      });
      container.appendChild(p);
      container.appendChild(grid);
      p.textContent = 'Level 1 - Watch!';
      sequence = [Math.floor(Math.random() * 4)];
      sequence.forEach((idx, i) => setTimeout(() => { grid.children[idx].style.opacity = '0.5'; setTimeout(() => grid.children[idx].style.opacity = '1', 300); }, 600 + i * 600));
      setTimeout(() => { p.textContent = 'Your turn!'; }, 1200);
    }

    function runBreakoutGame(container) {
      const cols = 6, rows = 4;
      const brickW = 50, brickH = 20;
      const paddleW = 80, paddleH = 12;
      const canvas = document.createElement('div');
      canvas.style.cssText = 'position:relative;width:300px;height:320px;background:#1a1a2e;border-radius:12px;overflow:hidden;';
      let bricks = [];
      for (let r = 0; r < rows; r++) for (let c = 0; c < cols; c++) bricks.push({x: c * (brickW + 4) + 4, y: r * (brickH + 4) + 4, w: brickW, h: brickH});
      let ball = { x: 150, y: 250, vx: 3, vy: -3, r: 8 };
      let paddle = { x: 110, y: 300, w: paddleW, h: paddleH };
      const render = () => {
        canvas.innerHTML = '';
        bricks.forEach(b => {
          const div = document.createElement('div');
          div.style.cssText = `position:absolute;left:${b.x}px;top:${b.y}px;width:${b.w}px;height:${b.h}px;background:#9c27b0;border-radius:4px;`;
          canvas.appendChild(div);
        });
        const ballEl = document.createElement('div');
        ballEl.style.cssText = `position:absolute;left:${ball.x-ball.r}px;top:${ball.y-ball.r}px;width:${ball.r*2}px;height:${ball.r*2}px;background:#fff;border-radius:50%;`;
        canvas.appendChild(ballEl);
        const padEl = document.createElement('div');
        padEl.style.cssText = `position:absolute;left:${paddle.x}px;top:${paddle.y}px;width:${paddle.w}px;height:${paddle.h}px;background:#43a047;border-radius:6px;`;
        canvas.appendChild(padEl);
      };
      canvas.onmousemove = (e) => { const r = canvas.getBoundingClientRect(); paddle.x = Math.max(0, Math.min(300 - paddle.w, e.clientX - r.left - paddle.w/2)); };
      let anim;
      const gameLoop = () => {
        ball.x += ball.vx; ball.y += ball.vy;
        if (ball.x - ball.r <= 0 || ball.x + ball.r >= 300) ball.vx *= -1;
        if (ball.y - ball.r <= 0) ball.vy *= -1;
        if (ball.y + ball.r >= paddle.y && ball.x >= paddle.x && ball.x <= paddle.x + paddle.w) ball.vy *= -1;
        if (ball.y > 320) { cancelAnimationFrame(anim); const msg = document.createElement('p'); msg.style.cssText = 'color:#e53935;font-weight:700;'; msg.textContent = 'Game Over!'; container.appendChild(msg); scheduleGamehubReplay('breakout', 2000); return; }
        bricks = bricks.filter(b => {
          const hit = ball.x >= b.x && ball.x <= b.x + b.w && ball.y >= b.y && ball.y <= b.y + b.h;
          if (hit) ball.vy *= -1;
          return !hit;
        });
        if (bricks.length === 0) { cancelAnimationFrame(anim); gameWin(container, 'breakout', 2000, 'All bricks broken!', 'ðŸ§±'); return; }
        render();
        anim = requestAnimationFrame(gameLoop);
      };
      container.appendChild(canvas);
      render();
      anim = requestAnimationFrame(gameLoop);
    }

    function runTriviaGame(container) {
      const qs = [
        { q: 'What is 7 + 8?', a: '15', opts: ['14', '15', '16', '17'] },
        { q: 'Capital of France?', a: 'Paris', opts: ['London', 'Paris', 'Berlin', 'Rome'] },
        { q: 'How many days in a week?', a: '7', opts: ['5', '6', '7', '8'] },
        { q: 'Largest planet?', a: 'Jupiter', opts: ['Saturn', 'Jupiter', 'Neptune', 'Earth'] },
        { q: '2 Ã— 9 = ?', a: '18', opts: ['16', '17', '18', '19'] },
        { q: 'Primary colors?', a: 'Red, Blue, Yellow', opts: ['Red, Blue, Yellow', 'Red, Green, Blue', 'Orange, Purple, Green'] },
        { q: 'How many continents?', a: '7', opts: ['5', '6', '7', '8'] },
        { q: 'Fastest land animal?', a: 'Cheetah', opts: ['Lion', 'Cheetah', 'Horse'] }
      ].sort(() => Math.random() - 0.5).slice(0, 5);
      let score = 0, idx = 0;
      function ask() {
        if (idx >= 5) { const p = document.createElement('p'); p.className = 'gamehub-score'; p.textContent = 'Score: ' + score + '/5'; container.appendChild(p); gameWin(container, 'trivia', 2000, score + '/5 correct!', 'â“'); return; }
        container.innerHTML = '';
        const q = qs[idx];
        const shuffled = [...q.opts].sort(() => Math.random() - 0.5);
        const p = document.createElement('p'); p.textContent = q.q; p.style.marginBottom = '1rem'; container.appendChild(p);
        shuffled.forEach(opt => {
          const btn = document.createElement('button'); btn.textContent = opt; btn.className = 'gamehub-btn'; btn.style.margin = '0.25rem';
          btn.onclick = () => { score += opt === q.a ? 1 : 0; idx++; ask(); };
          container.appendChild(btn);
        });
      }
      ask();
    }

    function runDiceGame(container) {
      container.innerHTML = '';
      const p = document.createElement('p'); p.textContent = 'Roll the dice! Need 5 or 6 to win.'; p.style.marginBottom = '1rem'; container.appendChild(p);
      const btn = document.createElement('button'); btn.textContent = 'ðŸŽ² Roll'; btn.className = 'gamehub-btn';
      btn.onclick = () => {
        const roll = 1 + Math.floor(Math.random() * 6);
        p.textContent = 'You rolled ' + roll + (roll >= 5 ? ' â€” You win!' : ' â€” Try again!');
        if (roll >= 5) gameWin(container, 'dice', 1500, 'Lucky roll!', 'ðŸŽ²');
        else scheduleGamehubReplay('dice', 2000);
      };
      container.appendChild(btn);
    }

    function runRpsGame(container) {
      const choices = ['Rock', 'Paper', 'Scissors'];
      const beats = { Rock: 'Scissors', Paper: 'Rock', Scissors: 'Paper' };
      container.innerHTML = '';
      const p = document.createElement('p'); p.textContent = 'Choose:'; p.style.marginBottom = '1rem'; container.appendChild(p);
      choices.forEach(c => {
        const btn = document.createElement('button'); btn.textContent = c; btn.className = 'gamehub-btn'; btn.style.margin = '0.25rem';
        btn.onclick = () => {
          const cpu = choices[Math.floor(Math.random() * 3)];
          let res = 'Tie!';
          if (beats[c] === cpu) res = 'You win!';
          else if (beats[cpu] === c) res = 'You lose!';
          p.textContent = 'You: ' + c + ' vs CPU: ' + cpu + ' â€” ' + res;
          if (res === 'You win!') gameWin(container, 'rps', 1800, 'You win!', 'âœŠ');
          else scheduleGamehubReplay('rps', 1800);
        };
        container.appendChild(btn);
      });
    }

    function runHigherGame(container) {
      let prev = Math.floor(Math.random() * 100) + 1;
      let score = 0;
      function next() {
        const nextVal = Math.floor(Math.random() * 100) + 1;
        container.innerHTML = '';
        const p = document.createElement('p'); p.textContent = 'Current: ' + prev + '. Higher or Lower?'; p.style.marginBottom = '1rem'; container.appendChild(p);
        const higher = document.createElement('button'); higher.textContent = 'Higher'; higher.className = 'gamehub-btn'; higher.style.margin = '0.25rem';
        const lower = document.createElement('button'); lower.textContent = 'Lower'; lower.className = 'gamehub-btn'; lower.style.margin = '0.25rem';
        const check = (guess) => {
          const correct = (guess === 'higher' && nextVal > prev) || (guess === 'lower' && nextVal < prev) || (nextVal === prev);
          if (correct) { score++; prev = nextVal; next(); }
          else { p.textContent = 'Wrong! Next was ' + nextVal + '. Score: ' + score; scheduleGamehubReplay('higher', 2000); }
        };
        higher.onclick = () => check('higher');
        lower.onclick = () => check('lower');
        container.appendChild(higher);
        container.appendChild(lower);
      }
      next();
    }

    function runTictactoeGame(container) {
      let board = [0,0,0,0,0,0,0,0,0], turn = 1;
      const win = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
      const checkEnd = (sym) => {
        if (win.some(w => w.every(j => board[j] === sym))) return sym;
        if (board.every(b => b !== 0)) return 0;
        return null;
      };
      container.innerHTML = '';
      const grid = document.createElement('div'); grid.style.cssText = 'display:grid;grid-template-columns:repeat(3,60px);gap:4px;';
      for (let i = 0; i < 9; i++) {
        const btn = document.createElement('button'); btn.dataset.i = i; btn.style.cssText = 'width:60px;height:60px;font-size:1.5rem;';
        btn.onclick = () => {
          if (board[i] !== 0) return;
          board[i] = turn;
          btn.textContent = 'X';
          let res = checkEnd(1);
          if (res !== null) { if (res === 1) gameWin(container, 'tictactoe', 2000, 'X wins!', 'â­•'); else scheduleGamehubReplay('tictactoe', 2000); return; }
          turn = -1;
          const empty = board.map((b,j) => b === 0 ? j : -1).filter(j => j >= 0);
          const move = empty[Math.floor(Math.random() * empty.length)];
          setTimeout(() => {
            board[move] = -1;
            grid.querySelector('[data-i="'+move+'"]').textContent = 'O';
            res = checkEnd(-1);
            if (res !== null) { if (res === -1) gameWin(container, 'tictactoe', 2000, 'O wins!', 'â­•'); else scheduleGamehubReplay('tictactoe', 2000); return; }
            turn = 1;
          }, 300);
        };
        grid.appendChild(btn);
      }
      container.appendChild(grid);
    }

    function runHangmanGame(container) {
      const words = ['STREAK', 'GOALS', 'HABIT', 'FOCUS', 'DAILY', 'WIN'];
      const word = words[Math.floor(Math.random() * words.length)];
      const maxWrong = 6;
      let wrong = 0, guessed = new Set();
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
      const display = () => word.split('').map(c => guessed.has(c) ? c : '_').join(' ');
      const p = document.createElement('p');
      p.style.cssText = 'font-size:1.5rem;letter-spacing:0.2em;margin-bottom:1rem;font-family:monospace;';
      const wrongEl = document.createElement('p');
      wrongEl.style.cssText = 'color:var(--text-muted);margin-bottom:1rem;';
      const grid = document.createElement('div');
      grid.style.cssText = 'display:flex;flex-wrap:wrap;gap:0.35rem;justify-content:center;';
      const update = () => {
        p.textContent = display();
        wrongEl.textContent = 'Wrong: ' + wrong + '/' + maxWrong + (wrong >= maxWrong ? ' â€” Game Over!' : '');
        if (display().indexOf('_') === -1) { p.textContent = display() + ' â€” You win!'; gameWin(container, 'hangman', 1500, 'Word guessed!', 'ðŸª¢'); }
        else if (wrong >= maxWrong) { p.textContent = 'Word was: ' + word; scheduleGamehubReplay('hangman', 2000); }
      };
      letters.forEach(l => {
        const btn = document.createElement('button');
        btn.textContent = l;
        btn.style.cssText = 'width:36px;height:36px;font-size:1rem;border-radius:8px;border:1px solid var(--border);background:var(--bg-elevated);cursor:pointer;';
        btn.onclick = () => {
          if (guessed.has(l) || wrong >= maxWrong) return;
          guessed.add(l);
          btn.disabled = true;
          btn.style.opacity = '0.5';
          if (!word.includes(l)) wrong++;
          update();
        };
        grid.appendChild(btn);
      });
      container.appendChild(p);
      container.appendChild(wrongEl);
      container.appendChild(grid);
      update();
    }

    function runMathQuizGame(container) {
      const ops = [
        (a, b) => ({ q: a + ' + ' + b, a: a + b }),
        (a, b) => (a >= b ? { q: a + ' âˆ’ ' + b, a: a - b } : { q: b + ' âˆ’ ' + a, a: b - a }),
        (a, b) => ({ q: a + ' Ã— ' + b, a: a * b }),
        (a, b) => (b !== 0 ? { q: (a * b) + ' Ã· ' + b, a: a } : { q: a + ' + ' + b, a: a + b })
      ];
      let score = 0, idx = 0;
      function ask() {
        if (idx >= 5) { const p = document.createElement('p'); p.className = 'gamehub-score'; p.textContent = 'Score: ' + score + '/5'; container.appendChild(p); gameWin(container, 'mathquiz', 2000, score + '/5 correct!', 'âž•'); return; }
        container.innerHTML = '';
        const a = 1 + Math.floor(Math.random() * 12), b = 1 + Math.floor(Math.random() * 12);
        const fn = ops[Math.floor(Math.random() * ops.length)];
        const { q, a: ans } = fn(a, b);
        const p = document.createElement('p'); p.textContent = q + ' = ?'; p.style.cssText = 'font-size:1.5rem;margin-bottom:1rem;';
        const inp = document.createElement('input');
        inp.type = 'number';
        inp.style.cssText = 'width:80px;padding:0.5rem;font-size:1.2rem;margin-right:0.5rem;';
        const btn = document.createElement('button');
        btn.textContent = 'Check';
        btn.style.cssText = 'padding:0.5rem 1rem;background:var(--primary);color:#fff;border:none;border-radius:8px;cursor:pointer;';
        btn.onclick = () => {
          if (+inp.value === ans) score++;
          idx++;
          ask();
        };
        container.appendChild(p);
        container.appendChild(inp);
        container.appendChild(btn);
      }
      ask();
    }

    function runCatchGame(container) {
      const fruits = ['ðŸŽ', 'ðŸŠ', 'ðŸ‹', 'ðŸ‡', 'ðŸ“', 'ðŸ‘'];
      let score = 0, lives = 3, gameOver = false;
      const scoreEl = document.createElement('p');
      scoreEl.style.cssText = 'font-weight:700;margin-bottom:0.5rem;';
      const area = document.createElement('div');
      area.style.cssText = 'position:relative;width:100%;height:280px;background:linear-gradient(180deg,#87ceeb 0%,#e0f7fa 100%);border-radius:12px;overflow:hidden;';
      const basket = document.createElement('div');
      basket.textContent = 'ðŸ§º';
      basket.style.cssText = 'position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:2.5rem;cursor:pointer;user-select:none;transition:left 0.1s;';
      area.appendChild(basket);
      container.appendChild(scoreEl);
      container.appendChild(area);
      let basketX = 50;
      const updateBasket = () => { basket.style.left = basketX + '%'; basket.style.transform = 'translateX(-50%)'; };
      area.onmousemove = area.ontouchmove = (e) => { if (gameOver) return; const rect = area.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left; basketX = Math.max(10, Math.min(90, (x / rect.width) * 100)); updateBasket(); };
      const spawn = () => {
        if (gameOver) return;
        const f = document.createElement('div');
        f.textContent = fruits[Math.floor(Math.random() * fruits.length)];
        f.style.cssText = 'position:absolute;font-size:2rem;left:' + (10 + Math.random() * 80) + '%;top:-40px;transition:none;';
        area.appendChild(f);
        let y = 0;
        const fall = setInterval(() => {
          if (gameOver) { clearInterval(fall); return; }
          y += 4;
          f.style.top = y + 'px';
          const fRect = f.getBoundingClientRect(), bRect = basket.getBoundingClientRect();
          if (fRect.bottom >= bRect.top && fRect.top <= bRect.bottom && Math.abs(fRect.left + fRect.width/2 - (bRect.left + bRect.width/2)) < 50) {
            score++;
            scoreEl.textContent = 'Score: ' + score + ' | Lives: ' + lives;
            f.remove();
            clearInterval(fall);
          } else if (y > 280) {
            lives--;
            scoreEl.textContent = 'Score: ' + score + ' | Lives: ' + lives;
            f.remove();
            clearInterval(fall);
            if (lives <= 0) { gameOver = true; scoreEl.textContent = 'Game Over! Score: ' + score; scheduleGamehubReplay('catch', 2000); }
          }
        }, 50);
      };
      scoreEl.textContent = 'Score: 0 | Lives: 3';
      spawn();
      const spawner = setInterval(() => { if (!gameOver) spawn(); }, 1200);
      setTimeout(() => { if (!gameOver) { clearInterval(spawner); gameOver = true; scoreEl.textContent = 'Time\'s up! Score: ' + score; scheduleGamehubReplay('catch', 2000); } }, 15000);
    }

    function runFlappyGame(container) {
      const area = document.createElement('div');
      area.style.cssText = 'position:relative;width:100%;height:240px;background:linear-gradient(180deg,#87ceeb 0%,#98d8aa 100%);border-radius:12px;overflow:hidden;';
      const bird = document.createElement('div');
      bird.textContent = 'ðŸ¦';
      bird.style.cssText = 'position:absolute;left:40px;top:100px;font-size:2rem;transition:top 0.05s;';
      const scoreEl = document.createElement('p');
      scoreEl.style.cssText = 'font-weight:700;margin-bottom:0.5rem;';
      container.appendChild(scoreEl);
      container.appendChild(area);
      area.appendChild(bird);
      let birdY = 100, vel = 0, score = 0, gameOver = false, pipes = [];
      const g = 1.2, jump = -12;
      let touchStartY = 0, didScroll = false;
      area.addEventListener('touchstart', (e) => { touchStartY = e.touches[0].clientY; didScroll = false; }, { passive: true });
      area.addEventListener('touchmove', (e) => { if (Math.abs(e.touches[0].clientY - touchStartY) > 10) didScroll = true; }, { passive: true });
      area.onclick = () => {
        if (gameOver) return;
        if (didScroll) return;
        vel = jump;
      };
      const tick = () => {
        if (gameOver) return;
        vel += g;
        birdY = Math.max(0, Math.min(220, birdY + vel));
        bird.style.top = birdY + 'px';
        pipes = pipes.filter((p) => {
          p.x -= 4;
          p.el.style.left = p.x + 'px';
          if (p.x === 36 && birdY + 24 > p.gapTop && birdY + 24 < p.gapTop + 60) score++;
          if (p.x > 20 && p.x < 60 && (birdY + 32 < p.gapTop || birdY > p.gapTop + 60)) gameOver = true;
          if (p.x < -40) { p.el.remove(); return false; }
          return true;
        });
        if (Math.random() < 0.02) {
          const gapTop = 40 + Math.random() * 120;
          const pipe = document.createElement('div');
          pipe.style.cssText = 'position:absolute;left:100%;top:0;width:40px;height:100%;';
          pipe.innerHTML = '<div style="position:absolute;top:0;left:0;right:0;height:' + gapTop + 'px;background:#2e7d32;border-radius:4px;"></div><div style="position:absolute;top:' + (gapTop + 60) + 'px;left:0;right:0;bottom:0;background:#2e7d32;border-radius:4px;"></div>';
          area.appendChild(pipe);
          pipes.push({ el: pipe, x: 300, gapTop });
        }
        scoreEl.textContent = 'Score: ' + score;
        if (gameOver) { scoreEl.textContent = 'Game Over! Score: ' + score; scheduleGamehubReplay('flappy', 2000); return; }
        requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
    }

    function runWordScrambleGame(container) {
      const words = ['STREAK', 'HABIT', 'FOCUS', 'DAILY', 'GOALS', 'WIN', 'TASK', 'PLAN'];
      const word = words[Math.floor(Math.random() * words.length)];
      const scramble = (w) => w.split('').sort(() => Math.random() - 0.5).join('');
      let scrambled = scramble(word);
      const p = document.createElement('p');
      p.textContent = 'Unscramble: ' + scrambled;
      p.style.cssText = 'font-size:1.3rem;letter-spacing:0.15em;margin-bottom:1rem;font-family:monospace;';
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.placeholder = 'Type your answer';
      inp.style.cssText = 'width:100%;padding:0.75rem;font-size:1.1rem;margin-bottom:0.5rem;text-transform:uppercase;';
      const btn = document.createElement('button');
      btn.textContent = 'Check';
      btn.style.cssText = 'padding:0.6rem 1.2rem;background:var(--primary);color:#fff;border:none;border-radius:8px;cursor:pointer;';
      btn.onclick = () => {
        if (inp.value.toUpperCase().trim() === word) {
          p.textContent = 'Correct!';
          p.style.color = '#2e7d32';
          gameWin(container, 'wordscramble', 1200, 'Word unscrambled!', 'ðŸ”¤');
        } else {
          p.textContent = 'Wrong! Try again: ' + scrambled;
          p.style.color = '';
        }
      };
      container.appendChild(p);
      container.appendChild(inp);
      container.appendChild(btn);
    }

    function runPongGame(container) {
      const w = 280, h = 200;
      const area = document.createElement('div');
      area.style.cssText = `position:relative;width:${w}px;height:${h}px;background:#1a1a2e;border-radius:12px;overflow:hidden;margin:0 auto;`;
      const paddle = document.createElement('div');
      paddle.style.cssText = 'position:absolute;bottom:8px;left:50%;width:60px;height:12px;background:#43a047;border-radius:6px;transform:translateX(-50%);';
      const ball = document.createElement('div');
      ball.style.cssText = 'position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;';
      area.appendChild(paddle);
      area.appendChild(ball);
      const scoreEl = document.createElement('p');
      scoreEl.style.cssText = 'font-weight:700;margin-bottom:0.5rem;';
      container.appendChild(scoreEl);
      container.appendChild(area);
      let paddleX = w/2 - 30, ballX = w/2 - 7, ballY = 50, dx = 3, dy = 3, score = 0, lives = 3, gameOver = false;
      area.onmousemove = area.ontouchmove = (e) => {
        if (gameOver) return;
        const rect = area.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        paddleX = Math.max(0, Math.min(w - 60, x - 30));
        paddle.style.left = paddleX + 'px';
        paddle.style.transform = 'none';
      };
      const tick = () => {
        if (gameOver) return;
        ballX += dx; ballY += dy;
        if (ballX <= 0 || ballX >= w - 14) dx = -dx;
        if (ballY <= 0) dy = -dy;
        if (ballY >= h - 26 && ballX + 14 >= paddleX && ballX <= paddleX + 60) { dy = -dy; score++; }
        if (ballY > h) { lives--; ballX = w/2 - 7; ballY = 50; dy = 3; }
        if (lives <= 0) { gameOver = true; scoreEl.textContent = 'Game Over! Score: ' + score; scheduleGamehubReplay('pong', 2000); return; }
        ball.style.left = ballX + 'px';
        ball.style.top = ballY + 'px';
        paddle.style.left = paddleX + 'px';
        scoreEl.textContent = 'Score: ' + score + ' | Lives: ' + lives;
        requestAnimationFrame(tick);
      };
      ball.style.left = ballX + 'px'; ball.style.top = ballY + 'px';
      paddle.style.left = paddleX + 'px';
      paddle.style.transform = 'none';
      scoreEl.textContent = 'Score: 0 | Lives: 3';
      requestAnimationFrame(tick);
    }

    function runTargetGame(container) {
      const area = document.createElement('div');
      area.style.cssText = 'position:relative;width:100%;height:220px;background:linear-gradient(180deg,#1a1a2e 0%,#16213e 100%);border-radius:12px;overflow:hidden;';
      const scoreEl = document.createElement('p');
      scoreEl.style.cssText = 'font-weight:700;margin-bottom:0.5rem;';
      container.appendChild(scoreEl);
      container.appendChild(area);
      let score = 0, targetCount = 0, gameOver = false;
      const spawn = () => {
        if (gameOver || targetCount >= 10) return;
        const t = document.createElement('button');
        t.style.cssText = 'position:absolute;width:44px;height:44px;border-radius:50%;background:#e53935;border:3px solid #fff;cursor:pointer;font-size:1.2rem;transition:transform 0.1s;';
        t.textContent = 'ðŸŽ¯';
        const aw = area.offsetWidth || 200, ah = area.offsetHeight || 180;
        const x = 20 + Math.random() * Math.max(0, aw - 80);
        const y = 20 + Math.random() * Math.max(0, ah - 80);
        t.style.left = x + 'px';
        t.style.top = y + 'px';
        t.onclick = () => { if (!gameOver) { score++; targetCount++; t.remove(); scoreEl.textContent = 'Score: ' + score + '/10'; if (targetCount >= 10) { gameOver = true; scoreEl.textContent = 'Done! Score: ' + score; gameWin(container, 'target', 1500, '10 targets hit!', 'ðŸŽ¯'); } else spawn(); } };
        area.appendChild(t);
        setTimeout(() => { if (t.parentNode) { t.remove(); if (!gameOver && targetCount < 10) spawn(); } }, 1200);
      };
      scoreEl.textContent = 'Score: 0/10 - Hit targets fast!';
      requestAnimationFrame(() => spawn());
    }

    function runMinesweeperGame(container) {
      const size = 5, mines = 3;
      const scoreEl = document.createElement('p');
      scoreEl.style.cssText = 'font-weight:700;margin-bottom:0.5rem;';
      scoreEl.textContent = 'Avoid the mines!';
      container.appendChild(scoreEl);
      const grid = document.createElement('div');
      grid.style.cssText = 'display:grid;grid-template-columns:repeat(5,44px);gap:2px;width:fit-content;';
      const minePos = new Set();
      while (minePos.size < mines) minePos.add(Math.floor(Math.random() * size * size));
      for (let i = 0; i < size * size; i++) {
        const btn = document.createElement('button');
        btn.style.cssText = 'width:44px;height:44px;font-size:1rem;font-weight:700;border:2px solid var(--border);border-radius:6px;background:var(--bg-elevated);cursor:pointer;';
        btn.dataset.i = i;
        btn.onclick = () => {
          if (btn.disabled) return;
          if (minePos.has(i)) { btn.textContent = 'ðŸ’£'; btn.style.background = '#e53935'; grid.querySelectorAll('button').forEach(b => { b.disabled = true; }); scoreEl.textContent = 'Game Over!'; scheduleGamehubReplay('minesweeper', 2000); return; }
          const row = Math.floor(i / size), col = i % size;
          let count = 0;
          for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) {
            const ni = (row + dr) * size + (col + dc);
            if (ni >= 0 && ni < size * size && minePos.has(ni)) count++;
          }
          btn.textContent = count || ''; btn.style.background = count ? '#e3f2fd' : '#bbdefb'; btn.disabled = true;
          const revealed = grid.querySelectorAll('button[disabled]').length;
          if (revealed === size * size - mines) { scoreEl.textContent = 'You win!'; gameWin(container, 'minesweeper', 1500, 'Mines cleared!', 'ðŸ’£'); }
        };
        grid.appendChild(btn);
      }
      container.appendChild(grid);
    }

    function runPuzzleGame(container) {
      const size = 3;
      let board = [1,2,3,4,5,6,7,8,0];
      const shuffle = () => { for (let i = board.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [board[i], board[j]] = [board[j], board[i]]; } };
      shuffle();
      const grid = document.createElement('div');
      grid.style.cssText = 'display:grid;grid-template-columns:repeat(3,70px);gap:4px;width:fit-content;';
      const scoreEl = document.createElement('p');
      scoreEl.style.cssText = 'font-weight:700;margin-bottom:0.5rem;';
      scoreEl.textContent = 'Slide tiles to order 1-8';
      container.appendChild(scoreEl);
      container.appendChild(grid);
      const render = () => {
        grid.innerHTML = '';
        board.forEach((val, i) => {
          const btn = document.createElement('button');
          btn.style.cssText = 'width:70px;height:70px;font-size:1.5rem;font-weight:700;border:2px solid var(--border);border-radius:8px;background:var(--bg-elevated);cursor:pointer;';
          btn.textContent = val || '';
          btn.dataset.i = i;
          if (val) btn.onclick = () => {
            const empty = board.indexOf(0);
            const row = Math.floor(i / size), col = i % size;
            const er = Math.floor(empty / size), ec = empty % size;
            if ((Math.abs(row - er) === 1 && col === ec) || (Math.abs(col - ec) === 1 && row === er)) {
              [board[i], board[empty]] = [board[empty], board[i]];
              render();
              if (board.every((v, j) => v === (j + 1) % 9)) { scoreEl.textContent = 'You win!'; gameWin(container, 'puzzle', 1500, 'Puzzle solved!', 'ðŸ§©'); }
            }
          };
          grid.appendChild(btn);
        });
      };
      render();
    }

    function runTetrisGame(container) {
      const COLS = 10, ROWS = 18, CELL = 22;
      const SHAPES = [
        [[1,1,1,1]],
        [[1,1],[1,1]],
        [[0,1,0],[1,1,1]],
        [[0,1,1],[1,1,0]],
        [[1,1,0],[0,1,1]],
        [[1,0,0],[1,1,1]],
        [[0,0,1],[1,1,1]]
      ];
      const COLORS = ['#42a5f5','#66bb6a','#ab47bc','#ffa726','#ef5350','#26c6da','#ffee58'];
      let grid = Array(ROWS).fill().map(() => Array(COLS).fill(0));
      let piece = null, pieceX = 0, pieceY = 0, pieceType = 0, pieceRot = 0;
      let score = 0, gameOver = false;
      let gameLoop, keyHandlerRef;
      const instructionsEl = document.createElement('p');
      instructionsEl.style.cssText = 'margin:0 0 0.5rem 0;font-size:0.9rem;color:var(--text-muted);';
      instructionsEl.textContent = 'â† â†’ move  Â·  â†‘ rotate  Â·  â†“ drop faster';
      const scoreEl = document.createElement('p');
      scoreEl.style.cssText = 'margin:0 0 0.5rem 0;font-weight:700;';
      const canvas = document.createElement('div');
      canvas.style.cssText = `display:grid;grid-template-columns:repeat(${COLS},${CELL}px);gap:1px;width:fit-content;background:#0d47a1;padding:4px;border-radius:8px;`;
      const cells = [];
      for (let y = 0; y < ROWS; y++) for (let x = 0; x < COLS; x++) {
        const c = document.createElement('div');
        c.style.cssText = `width:${CELL-2}px;height:${CELL-2}px;background:#1565c0;border-radius:3px;`;
        c.dataset.x = x; c.dataset.y = y;
        cells.push(c); canvas.appendChild(c);
      }
      function getShape(t, r) {
        let s = SHAPES[t];
        for (let i = 0; i < r; i++) {
          const n = s[0].length, m = s.length;
          s = Array(n).fill().map((_, i) => Array(m).fill().map((_, j) => s[m-1-j][i]));
        }
        return s;
      }
      function spawn() {
        pieceType = Math.floor(Math.random() * 7);
        piece = getShape(pieceType, 0);
        pieceX = Math.floor((COLS - piece[0].length) / 2);
        pieceY = 0;
        pieceRot = 0;
        if (collides(piece, pieceX, pieceY)) {
          gameOver = true;
          clearInterval(gameLoop);
          document.removeEventListener('keydown', keyHandlerRef);
          scoreEl.textContent = 'Game Over! Score: ' + score;
          scheduleGamehubReplay('tetris', 2500);
        }
      }
      function collides(p, px, py) {
        for (let y = 0; y < p.length; y++) for (let x = 0; x < p[y].length; x++) {
          if (p[y][x]) {
            const nx = px + x, ny = py + y;
            if (nx < 0 || nx >= COLS || ny >= ROWS) return true;
            if (ny >= 0 && grid[ny][nx]) return true;
          }
        }
        return false;
      }
      function merge() {
        const p = getShape(pieceType, pieceRot);
        for (let y = 0; y < p.length; y++) for (let x = 0; x < p[y].length; x++)
          if (p[y][x] && pieceY + y >= 0) grid[pieceY + y][pieceX + x] = pieceType + 1;
      }
      function clearLines() {
        let cleared = 0;
        for (let y = ROWS - 1; y >= 0; y--) {
          if (grid[y].every(c => c > 0)) {
            grid.splice(y, 1);
            grid.unshift(Array(COLS).fill(0));
            cleared++;
            y++;
          }
        }
        if (cleared) score += [0, 100, 300, 500, 800][cleared];
      }
      function render() {
        const display = grid.map(r => [...r]);
        const p = getShape(pieceType, pieceRot);
        for (let y = 0; y < p.length; y++) for (let x = 0; x < p[y].length; x++)
          if (p[y][x] && pieceY + y >= 0) display[pieceY + y][pieceX + x] = pieceType + 1;
        cells.forEach(c => {
          const x = +c.dataset.x, y = +c.dataset.y;
          const v = display[y] && display[y][x];
          c.style.background = v ? COLORS[(v - 1) % COLORS.length] : '#1565c0';
        });
        if (!gameOver) scoreEl.textContent = 'Score: ' + score;
      }
      function tick() {
        if (gameOver) return;
        if (collides(getShape(pieceType, pieceRot), pieceX, pieceY + 1)) {
          merge();
          clearLines();
          spawn();
        } else pieceY++;
        render();
      }
      keyHandlerRef = (e) => {
        if (gameOver) return;
        const p = getShape(pieceType, pieceRot);
        if (e.key === 'ArrowLeft' && !collides(p, pieceX - 1, pieceY)) pieceX--;
        else if (e.key === 'ArrowRight' && !collides(p, pieceX + 1, pieceY)) pieceX++;
        else if (e.key === 'ArrowDown' && !collides(p, pieceX, pieceY + 1)) { pieceY++; score++; }
        else if (e.key === 'ArrowUp') {
          const nr = (pieceRot + 1) % 4;
          const np = getShape(pieceType, nr);
          if (!collides(np, pieceX, pieceY)) pieceRot = nr;
        }
        e.preventDefault();
        render();
      };
      document.addEventListener('keydown', keyHandlerRef);
      container.appendChild(instructionsEl);
      container.appendChild(scoreEl);
      container.appendChild(canvas);
      spawn();
      render();
      gameLoop = setInterval(tick, 500);
    }

    function runCoinflipGame(container) {
      container.innerHTML = '';
      const p = document.createElement('p'); p.textContent = 'Pick heads or tails!'; p.style.marginBottom = '1rem'; container.appendChild(p);
      const heads = document.createElement('button'); heads.textContent = 'Heads'; heads.className = 'gamehub-btn'; heads.style.margin = '0.25rem';
      const tails = document.createElement('button'); tails.textContent = 'Tails'; tails.className = 'gamehub-btn'; tails.style.margin = '0.25rem';
      const pick = (choice) => {
        const result = Math.random() < 0.5 ? 'Heads' : 'Tails';
        p.textContent = 'Result: ' + result + ' â€” ' + (choice === result ? 'You win!' : 'Try again!');
        if (choice === result) gameWin(container, 'coinflip', 1800, 'Lucky flip!', 'ðŸª™');
        else scheduleGamehubReplay('coinflip', 1800);
      };
      heads.onclick = () => pick('Heads');
      tails.onclick = () => pick('Tails');
      container.appendChild(heads);
      container.appendChild(tails);
    }

    function runBlackjackGame(container) {
      let hand = 0, deck = [2,3,4,5,6,7,8,9,10,10,10,10,11];
      const hit = () => {
        const c = deck[Math.floor(Math.random() * deck.length)];
        hand += c;
        scoreEl.textContent = 'Total: ' + hand;
        if (hand > 21) { hitBtn.disabled = true; stayBtn.disabled = true; scoreEl.textContent = 'Bust! ' + hand; scheduleGamehubReplay('blackjack', 2000); }
        else if (hand === 21) { hitBtn.disabled = true; stayBtn.disabled = true; scoreEl.textContent = 'Blackjack!'; gameWin(container, 'blackjack', 1500, 'Blackjack!', 'ðŸƒ'); }
      };
      const scoreEl = document.createElement('p'); scoreEl.style.marginBottom = '1rem'; container.appendChild(scoreEl);
      hand = deck[Math.floor(Math.random() * deck.length)];
      scoreEl.textContent = 'Total: ' + hand;
      const hitBtn = document.createElement('button'); hitBtn.textContent = 'Hit'; hitBtn.className = 'gamehub-btn'; hitBtn.style.margin = '0.25rem';
      const stayBtn = document.createElement('button'); stayBtn.textContent = 'Stay'; stayBtn.className = 'gamehub-btn'; stayBtn.style.margin = '0.25rem';
      hitBtn.onclick = () => { if (hand < 21) hit(); };
      stayBtn.onclick = () => { hitBtn.disabled = true; stayBtn.disabled = true; scoreEl.textContent = 'You stayed at ' + hand + (hand >= 17 ? ' â€” Nice!' : ''); scheduleGamehubReplay('blackjack', 1800); };
      container.appendChild(hitBtn);
      container.appendChild(stayBtn);
    }

    function runOddoneGame(container) {
      const sets = [
        ['ðŸŽ','ðŸŽ','ðŸŽ','ðŸŠ','ðŸŽ'],
        ['ðŸ¶','ðŸ¶','ðŸ±','ðŸ¶','ðŸ¶'],
        ['â­','ðŸŒŸ','â­','â­','â­'],
        ['ðŸ”´','ðŸ”´','ðŸ”µ','ðŸ”´','ðŸ”´'],
        ['ðŸ•','ðŸ•','ðŸ”','ðŸ•','ðŸ•']
      ];
      const items = sets[Math.floor(Math.random() * sets.length)];
      const oddOne = items.find((e, i) => items.filter(x => x === e).length === 1);
      const shuffled = [...items].sort(() => Math.random() - 0.5);
      const p = document.createElement('p'); p.textContent = 'Find the odd one out!'; p.style.marginBottom = '1rem'; container.appendChild(p);
      const wrap = document.createElement('div'); wrap.style.cssText = 'display:flex;gap:0.5rem;flex-wrap:wrap;';
      shuffled.forEach((emoji) => {
        const b = document.createElement('button');
        b.textContent = emoji;
        b.style.cssText = 'font-size:2rem;padding:0.5rem;border:2px solid var(--border);border-radius:8px;background:var(--bg-elevated);cursor:pointer;';
        b.onclick = () => {
          if (emoji === oddOne) { p.textContent = 'Correct!'; gameWin(container, 'oddone', 1200, 'Sharp eyes!', 'ðŸ‘ï¸'); }
          else { p.textContent = 'Wrong! Try again.'; }
        };
        wrap.appendChild(b);
      });
      container.appendChild(wrap);
    }

    function runLightsoutGame(container) {
      const size = 3;
      let grid = Array(size * size).fill(0).map(() => Math.random() < 0.5 ? 1 : 0);
      const toggle = (i) => {
        const row = Math.floor(i / size), col = i % size;
        for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) {
          const ni = (row + dr) * size + (col + dc);
          if (ni >= 0 && ni < size * size && (dr === 0 || dc === 0)) grid[ni] = 1 - grid[ni];
        }
      };
      const el = document.createElement('div');
      el.style.cssText = 'display:grid;grid-template-columns:repeat(3,60px);gap:4px;';
      const render = () => {
        el.innerHTML = '';
        grid.forEach((v, i) => {
          const b = document.createElement('button');
          b.style.cssText = 'width:60px;height:60px;font-size:1.5rem;border:2px solid var(--border);border-radius:8px;background:' + (v ? '#ffc107' : '#37474f') + ';cursor:pointer;';
          b.textContent = v ? 'ðŸ’¡' : '';
          b.onclick = () => { toggle(i); render(); if (grid.every(x => x === 0)) { el.nextElementSibling.textContent = 'You win!'; gameWin(container, 'lightsout', 1500, 'Lights out!', 'ðŸ’¡'); } };
          el.appendChild(b);
        });
      };
      const p = document.createElement('p'); p.style.marginTop = '0.5rem'; container.appendChild(p);
      container.appendChild(el);
      render();
    }

    function runDodgeGame(container) {
      const area = document.createElement('div');
      area.style.cssText = 'position:relative;width:100%;height:200px;background:#1a1a2e;border-radius:12px;overflow:hidden;';
      const player = document.createElement('div');
      player.textContent = 'ðŸƒ';
      player.style.cssText = 'position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:2rem;transition:left 0.1s;';
      area.appendChild(player);
      const scoreEl = document.createElement('p'); scoreEl.style.marginBottom = '0.5rem'; container.appendChild(scoreEl);
      container.appendChild(area);
      let px = 50, obstacles = [], start = Date.now(), gameOver = false;
      area.onmousemove = area.ontouchmove = (e) => {
        if (gameOver) return;
        const rect = area.getBoundingClientRect();
        px = Math.max(10, Math.min(90, ((e.touches ? e.touches[0].clientX : e.clientX) - rect.left) / rect.width * 100));
        player.style.left = px + '%';
        player.style.transform = 'translateX(-50%)';
      };
      const tick = () => {
        if (gameOver) return;
        const elapsed = (Date.now() - start) / 1000;
        scoreEl.textContent = 'Survive 10s! ' + elapsed.toFixed(1) + 's';
        if (elapsed >= 10) { gameOver = true; scoreEl.textContent = 'You survived!'; gameWin(container, 'dodge', 1500, '10 seconds survived!', 'ðŸƒ'); return; }
        if (Math.random() < 0.03) {
          const o = document.createElement('div');
          o.textContent = 'ðŸ’¥';
          o.style.cssText = 'position:absolute;font-size:1.5rem;left:' + (10 + Math.random() * 80) + '%;top:-30px;';
          area.appendChild(o);
          let oy = 0;
          const fall = setInterval(() => {
            if (gameOver) { clearInterval(fall); return; }
            oy += 3;
            o.style.top = oy + 'px';
            const pr = player.getBoundingClientRect(), or = o.getBoundingClientRect();
            if (or.bottom >= pr.top && Math.abs(or.left + or.width/2 - pr.left - pr.width/2) < 30) { gameOver = true; scoreEl.textContent = 'Hit!'; scheduleGamehubReplay('dodge', 2000); o.remove(); clearInterval(fall); }
            else if (oy > 200) { o.remove(); clearInterval(fall); }
          }, 50);
        }
        requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
    }

    function runSpaceshooterGame(container) {
      const area = document.createElement('div');
      area.style.cssText = 'position:relative;width:100%;height:220px;background:linear-gradient(180deg,#0d47a1 0%,#1a237e 100%);border-radius:12px;overflow:hidden;';
      const ship = document.createElement('div');
      ship.textContent = 'ðŸš€';
      ship.style.cssText = 'position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:1.8rem;';
      area.appendChild(ship);
      const scoreEl = document.createElement('p'); scoreEl.style.marginBottom = '0.5rem'; container.appendChild(scoreEl);
      container.appendChild(area);
      let shipX = 50, bullets = [], aliens = [], score = 0, gameOver = false;
      area.onmousemove = area.ontouchmove = (e) => {
        if (gameOver) return;
        const rect = area.getBoundingClientRect();
        shipX = Math.max(5, Math.min(95, ((e.touches ? e.touches[0].clientX : e.clientX) - rect.left) / rect.width * 100));
        ship.style.left = shipX + '%';
      };
      area.onclick = () => {
        if (gameOver) return;
        const b = document.createElement('div');
        b.textContent = '|';
        b.style.cssText = 'position:absolute;color:#fff;font-size:1.2rem;left:' + (shipX - 1) + '%;bottom:50px;';
        area.appendChild(b);
        let by = 180;
        const move = setInterval(() => {
          by -= 8;
          b.style.bottom = by + 'px';
          aliens.forEach(a => {
            const ar = a.el.getBoundingClientRect(), br = b.getBoundingClientRect();
            if (ar.left < br.left + 10 && ar.right > br.left && ar.top < br.bottom && ar.bottom > br.top) { score++; a.el.remove(); aliens = aliens.filter(x => x !== a); }
          });
          if (by < 0) { b.remove(); clearInterval(move); }
        }, 30);
      };
      const spawn = () => {
        if (gameOver) return;
        const a = document.createElement('div');
        a.textContent = 'ðŸ‘¾';
        a.style.cssText = 'position:absolute;font-size:1.5rem;left:' + (10 + Math.random() * 80) + '%;top:10px;';
        area.appendChild(a);
        aliens.push({ el: a });
      };
      setInterval(spawn, 1200);
      const tick = () => {
        if (gameOver) return;
        scoreEl.textContent = 'Score: ' + score + ' â€” Shoot 10!';
        if (score >= 10) { gameOver = true; scoreEl.textContent = 'You win! Score: ' + score; gameWin(container, 'spaceshooter', 1500, '10 aliens defeated!', 'ðŸš€'); }
        requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
    }

    function runCatchlettersGame(container) {
      const target = 'A';
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const area = document.createElement('div');
      area.style.cssText = 'position:relative;width:100%;height:240px;background:linear-gradient(180deg,#5e35b1 0%,#7e57c2 100%);border-radius:12px;overflow:hidden;';
      const basket = document.createElement('div');
      basket.textContent = 'ðŸ§º';
      basket.style.cssText = 'position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:2.5rem;cursor:pointer;';
      area.appendChild(basket);
      const scoreEl = document.createElement('p'); scoreEl.style.marginBottom = '0.5rem'; scoreEl.textContent = 'Catch the letter A! Score: 0/5'; container.appendChild(scoreEl);
      container.appendChild(area);
      let score = 0, basketX = 50, gameOver = false;
      area.onmousemove = area.ontouchmove = (e) => {
        if (gameOver) return;
        const rect = area.getBoundingClientRect();
        basketX = Math.max(10, Math.min(90, ((e.touches ? e.touches[0].clientX : e.clientX) - rect.left) / rect.width * 100));
        basket.style.left = basketX + '%';
      };
      const spawn = () => {
        if (gameOver) return;
        const letter = letters[Math.floor(Math.random() * letters.length)];
        const el = document.createElement('div');
        el.textContent = letter;
        el.style.cssText = 'position:absolute;font-size:2rem;font-weight:700;color:#fff;left:' + (15 + Math.random() * 70) + '%;top:-30px;';
        area.appendChild(el);
        let y = 0;
        const fall = setInterval(() => {
          if (gameOver) { clearInterval(fall); return; }
          y += 4;
          el.style.top = y + 'px';
          const er = el.getBoundingClientRect(), br = basket.getBoundingClientRect();
          if (er.bottom >= br.top && Math.abs(er.left + er.width/2 - br.left - br.width/2) < 40) {
            if (letter === target) { score++; scoreEl.textContent = 'Catch A! Score: ' + score + '/5'; if (score >= 5) { gameOver = true; scoreEl.textContent = 'You win!'; gameWin(container, 'catchletters', 1500, '5 letters caught!', 'ðŸ”¤'); } }
            el.remove();
            clearInterval(fall);
          } else if (y > 250) { el.remove(); clearInterval(fall); }
        }, 50);
      };
      setInterval(spawn, 800);
    }

    function runBounceGame(container) {
      let count = 0;
      const target = 15;
      const p = document.createElement('p');
      p.textContent = 'Tap to bounce! Goal: ' + target;
      p.style.marginBottom = '1rem';
      const ball = document.createElement('button');
      ball.textContent = 'ðŸ€';
      ball.style.cssText = 'font-size:3rem;padding:1rem;border:none;background:none;cursor:pointer;animation:bounce 0.5s ease;';
      ball.onclick = () => {
        count++;
        p.textContent = 'Bounces: ' + count + '/' + target;
        if (count >= target) { p.textContent = 'Done! ' + count + ' bounces!'; gameWin(container, 'bounce', 1500, '15 bounces!', 'ðŸ€'); }
      };
      container.appendChild(p);
      container.appendChild(ball);
    }

    function runMazeGame(container) {
      const size = 5;
      const maze = Array(size).fill().map(() => Array(size).fill(1));
      for (let i = 0; i < size; i++) maze[0][i] = 0;
      for (let i = 1; i < size; i++) maze[i][size-1] = 0;
      maze[1][0] = 0; maze[2][0] = 0; maze[2][1] = 0; maze[2][2] = 0; maze[2][3] = 0;
      let px = 0, py = 0;
      const grid = document.createElement('div');
      grid.style.cssText = 'display:grid;grid-template-columns:repeat(5,50px);gap:2px;width:fit-content;';
      const render = () => {
        grid.innerHTML = '';
        for (let y = 0; y < size; y++) for (let x = 0; x < size; x++) {
          const c = document.createElement('div');
          c.style.cssText = 'width:50px;height:50px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;';
          if (x === px && y === py) { c.textContent = 'ðŸƒ'; c.style.background = '#43a047'; }
          else if (x === size-1 && y === size-1) { c.textContent = 'ðŸ'; c.style.background = '#ffc107'; }
          else c.style.background = maze[y][x] ? '#78909c' : '#cfd8dc';
          if (!maze[y][x] || (x === px && y === py) || (x === size-1 && y === size-1)) {
            c.onclick = () => {
              if (Math.abs(x - px) + Math.abs(y - py) === 1 && !maze[y][x]) {
                px = x; py = y;
                render();
                if (px === size-1 && py === size-1) { grid.nextElementSibling.textContent = 'You win!'; gameWin(container, 'maze', 1500, 'Maze solved!', 'ðŸ—ºï¸'); }
              }
            };
          }
          grid.appendChild(c);
        }
      };
      const p = document.createElement('p'); p.style.marginTop = '0.5rem'; container.appendChild(p);
      container.appendChild(grid);
      render();
    }

    function runGame2048Game(container) {
      const size = 4;
      let grid = Array(size).fill().map(() => Array(size).fill(0));
      const addTile = () => {
        const empty = [];
        for (let r = 0; r < size; r++) for (let c = 0; c < size; c++) if (grid[r][c] === 0) empty.push({r,c});
        if (empty.length) { const {r,c} = empty[Math.floor(Math.random() * empty.length)]; grid[r][c] = Math.random() < 0.9 ? 2 : 4; }
      };
      const scoreEl = document.createElement('p'); scoreEl.style.cssText = 'font-weight:700;margin-bottom:0.5rem;'; container.appendChild(scoreEl);
      const inst = document.createElement('p'); inst.style.cssText = 'font-size:0.85rem;color:var(--text-muted);margin-bottom:0.5rem;'; inst.textContent = 'Use arrow keys to merge tiles. Reach 2048!'; container.appendChild(inst);
      const el = document.createElement('div');
      el.style.cssText = 'display:grid;grid-template-columns:repeat(4,60px);gap:4px;width:fit-content;';
      const colors = {0:'#cdc1b4',2:'#eee4da',4:'#ede0c8',8:'#f2b179',16:'#f59563',32:'#f67c5f',64:'#f65e3b',128:'#edcf72',256:'#edcc61',512:'#edc850',1024:'#edc53f',2048:'#edc22e'};
      const mergeLine = (line) => {
        const filtered = line.filter(x => x > 0);
        const merged = [];
        for (let j = 0; j < filtered.length; j++) {
          if (j < filtered.length - 1 && filtered[j] === filtered[j + 1]) { merged.push(filtered[j] * 2); j++; }
          else merged.push(filtered[j]);
        }
        return [...merged, ...Array(size - merged.length).fill(0)];
      };
      const move = (dir) => {
        let moved = false;
        if (dir === 'up') {
          for (let c = 0; c < size; c++) {
            const col = grid.map(r => r[c]);
            const newCol = mergeLine(col);
            if (JSON.stringify(col) !== JSON.stringify(newCol)) moved = true;
            for (let r = 0; r < size; r++) grid[r][c] = newCol[r];
          }
        } else if (dir === 'down') {
          for (let c = 0; c < size; c++) {
            const col = grid.map(r => r[c]).reverse();
            const newCol = mergeLine(col).reverse();
            if (JSON.stringify(grid.map(r => r[c])) !== JSON.stringify(newCol)) moved = true;
            for (let r = 0; r < size; r++) grid[r][c] = newCol[r];
          }
        } else if (dir === 'left') {
          for (let r = 0; r < size; r++) {
            const row = grid[r].slice();
            const newRow = mergeLine(row);
            if (JSON.stringify(row) !== JSON.stringify(newRow)) moved = true;
            grid[r] = newRow;
          }
        } else if (dir === 'right') {
          for (let r = 0; r < size; r++) {
            const row = grid[r].slice().reverse();
            const newRow = mergeLine(row).reverse();
            if (JSON.stringify(grid[r]) !== JSON.stringify(newRow)) moved = true;
            grid[r] = newRow;
          }
        }
        if (moved) { addTile(); render(); }
      };
      const render = () => {
        let score = 0;
        el.innerHTML = '';
        for (let r = 0; r < size; r++) for (let c = 0; c < size; c++) {
          const v = grid[r][c];
          score += v;
          const cell = document.createElement('div');
          cell.style.cssText = 'width:60px;height:60px;display:flex;align-items:center;justify-content:center;font-size:' + (v >= 1024 ? '1rem' : v >= 128 ? '1.2rem' : '1.4rem') + ';font-weight:700;border-radius:6px;background:' + (colors[v] || '#3c3a32') + ';color:' + (v <= 4 ? '#776e65' : '#f9f6f2') + ';';
          cell.textContent = v || '';
          el.appendChild(cell);
        }
        scoreEl.textContent = 'Score: ' + score + (grid.some(r => r.some(c => c === 2048)) ? ' â€” You win!' : '');
        if (grid.some(r => r.some(c => c === 2048))) gameWin(container, 'game2048', 2000, '2048 reached!', 'ðŸ”¢');
      };
      const h = (e) => {
        if (e.key === 'ArrowUp') { move('up'); e.preventDefault(); }
        else if (e.key === 'ArrowDown') { move('down'); e.preventDefault(); }
        else if (e.key === 'ArrowLeft') { move('left'); e.preventDefault(); }
        else if (e.key === 'ArrowRight') { move('right'); e.preventDefault(); }
      };
      document.addEventListener('keydown', h);
      addTile(); addTile();
      container.appendChild(el);
      render();
    }

    function runSumtenGame(container) {
      const nums = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5);
      const p = document.createElement('p'); p.textContent = 'Tap two numbers that add to 10!'; p.style.marginBottom = '1rem'; container.appendChild(p);
      const wrap = document.createElement('div'); wrap.style.cssText = 'display:flex;gap:0.5rem;flex-wrap:wrap;';
      let selected = [];
      nums.forEach(n => {
        const b = document.createElement('button');
        b.textContent = n;
        b.className = 'gamehub-btn';
        b.style.margin = '0.25rem';
        b.onclick = () => {
          if (selected.includes(b)) return;
          selected.push(b);
          b.style.background = 'var(--primary)';
          b.style.color = '#fff';
          if (selected.length === 2) {
            const sum = +selected[0].textContent + +selected[1].textContent;
            if (sum === 10) { p.textContent = 'Correct! 10!'; gameWin(container, 'sumten', 1200, 'Sum to 10!', 'âž•'); }
            else { selected.forEach(x => { x.style.background = ''; x.style.color = ''; }); selected = []; p.textContent = 'Try again! Tap two that add to 10.'; }
          }
        };
        wrap.appendChild(b);
      });
      container.appendChild(wrap);
    }

    function runConnect4Game(container) {
      const cols = 7, rows = 6;
      let board = Array(rows).fill().map(() => Array(cols).fill(0));
      let turn = 1;
      const p = document.createElement('p'); p.style.marginBottom = '0.5rem'; container.appendChild(p);
      const grid = document.createElement('div');
      grid.style.cssText = 'display:grid;grid-template-columns:repeat(7,40px);gap:2px;width:fit-content;background:#1565c0;padding:8px;border-radius:8px;';
      const checkWin = (r, c) => {
        const d = [[0,1],[1,0],[1,1],[1,-1]];
        for (const [dr, dc] of d) {
          let count = 1;
          for (let s = 1; s <= 3; s++) { const nr = r + dr * s, nc = c + dc * s; if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && board[nr][nc] === turn) count++; else break; }
          for (let s = 1; s <= 3; s++) { const nr = r - dr * s, nc = c - dc * s; if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && board[nr][nc] === turn) count++; else break; }
          if (count >= 4) return true;
        }
        return false;
      };
      const dropInCol = (c) => {
        if (board[0][c] !== 0) return;
        let row = rows - 1;
        while (row >= 0 && board[row][c] !== 0) row--;
        if (row < 0) return;
        board[row][c] = turn;
        render();
        if (checkWin(row, c)) { p.textContent = (turn === 1 ? 'Red' : 'Yellow') + ' wins!'; gameWin(container, 'connect4', 2000, (turn === 1 ? 'Red' : 'Yellow') + ' wins!', 'ðŸ”´'); return; }
        if (board.every(rr => rr.every(cc => cc !== 0))) { p.textContent = 'Draw!'; scheduleGamehubReplay('connect4', 2000); return; }
        turn *= -1;
        p.textContent = (turn === 1 ? 'Red' : 'Yellow') + '\'s turn';
      };
      const render = () => {
        grid.innerHTML = '';
        for (let r = 0; r < rows; r++) for (let c = 0; c < cols; c++) {
          const cell = document.createElement('div');
          cell.style.cssText = 'width:36px;height:36px;border-radius:50%;background:' + (board[r][c] === 1 ? '#e53935' : board[r][c] === -1 ? '#ffeb3b' : '#fff') + ';';
          if (r === 0) { cell.style.cursor = 'pointer'; cell.onclick = () => dropInCol(c); }
          grid.appendChild(cell);
        }
        p.textContent = (turn === 1 ? 'Red' : 'Yellow') + '\'s turn â€” click top of column to drop';
      };
      container.appendChild(grid);
      render();
    }

    function runAnagramsGame(container) {
      const words = ['CAT','DOG','HAT','BAT','RAT','BED','RED','SUN','RUN','TOP'];
      const word = words[Math.floor(Math.random() * words.length)];
      const scramble = (w) => w.split('').sort(() => Math.random() - 0.5).join('');
      const p = document.createElement('p');
      p.textContent = 'Unscramble: ' + scramble(word);
      p.style.cssText = 'font-size:1.3rem;letter-spacing:0.2em;margin-bottom:1rem;font-family:monospace;';
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.placeholder = 'Type your answer';
      inp.style.cssText = 'width:100%;padding:0.75rem;font-size:1.1rem;margin-bottom:0.5rem;text-transform:uppercase;';
      const btn = document.createElement('button');
      btn.textContent = 'Check';
      btn.className = 'gamehub-btn';
      btn.onclick = () => {
        if (inp.value.toUpperCase().trim() === word) { p.textContent = 'Correct!'; p.style.color = '#2e7d32'; gameWin(container, 'anagrams', 1200, 'Word unscrambled!', 'ðŸ“'); }
        else { p.textContent = 'Wrong! Try again: ' + scramble(word); p.style.color = '#c62828'; }
      };
      container.appendChild(p);
      container.appendChild(inp);
      container.appendChild(btn);
    }

    function runTruefalseGame(container) {
      const qs = [
        { q: 'The Earth is flat.', a: false },
        { q: 'Water boils at 100Â°C.', a: true },
        { q: 'Humans have 206 bones.', a: true },
        { q: 'The sun revolves around Earth.', a: false },
        { q: 'There are 7 continents.', a: true }
      ];
      let idx = 0, score = 0;
      const p = document.createElement('p'); p.style.marginBottom = '1rem'; container.appendChild(p);
      const trueBtn = document.createElement('button'); trueBtn.textContent = 'True'; trueBtn.className = 'gamehub-btn'; trueBtn.style.margin = '0.25rem';
      const falseBtn = document.createElement('button'); falseBtn.textContent = 'False'; falseBtn.className = 'gamehub-btn'; falseBtn.style.margin = '0.25rem';
      const ask = () => {
        if (idx >= 5) { p.textContent = 'Score: ' + score + '/5'; gameWin(container, 'truefalse', 2000, score + '/5 correct!', 'âœ“'); return; }
        const q = qs[idx];
        p.textContent = q.q;
        const check = (ans) => {
          if (ans === q.a) score++;
          idx++;
          ask();
        };
        trueBtn.onclick = () => check(true);
        falseBtn.onclick = () => check(false);
      };
      container.appendChild(trueBtn);
      container.appendChild(falseBtn);
      ask();
    }

    function runSplatGame(container) {
      const area = document.createElement('div');
      area.style.cssText = 'position:relative;width:100%;height:220px;background:linear-gradient(180deg,#8d6e63 0%,#5d4037 100%);border-radius:12px;overflow:hidden;';
      const scoreEl = document.createElement('p'); scoreEl.style.marginBottom = '0.5rem'; scoreEl.textContent = 'Squash 15 bugs! 0/15'; container.appendChild(scoreEl);
      container.appendChild(area);
      let score = 0;
      const spawn = () => {
        if (score >= 15) return;
        const b = document.createElement('button');
        b.textContent = 'ðŸª²';
        b.style.cssText = 'position:absolute;font-size:2rem;border:none;background:none;cursor:pointer;left:' + (5 + Math.random() * 85) + '%;top:' + (5 + Math.random() * 70) + '%;transition:transform 0.1s;';
        b.onclick = () => { score++; b.textContent = 'ðŸ’¥'; b.style.transform = 'scale(1.5)'; setTimeout(() => b.remove(), 150); scoreEl.textContent = 'Squash 15 bugs! ' + score + '/15'; if (score >= 15) { scoreEl.textContent = 'Done!'; gameWin(container, 'splat', 1500, '15 bugs squashed!', 'ðŸª²'); } else spawn(); };
        area.appendChild(b);
      };
      for (let i = 0; i < 15; i++) setTimeout(spawn, i * 250);
    }

    function runSpinnerGame(container) {
      const prizes = ['ðŸŽ‰ Win!', 'ðŸ˜Š Try again', 'â­ Bonus!', 'ðŸŽ Gift!', 'ðŸ”¥ Hot!', 'ðŸ’Ž Gem!'];
      const p = document.createElement('p'); p.style.cssText = 'font-size:1.2rem;margin-bottom:1rem;'; container.appendChild(p);
      const wheel = document.createElement('div');
      wheel.style.cssText = 'width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg,#e91e63,#f48fb1);border:4px solid #fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1rem;margin:0 auto 1rem;';
      wheel.textContent = 'SPIN';
      const btn = document.createElement('button');
      btn.textContent = 'Spin!';
      btn.className = 'gamehub-btn';
      btn.onclick = () => {
        btn.disabled = true;
        const result = prizes[Math.floor(Math.random() * prizes.length)];
        wheel.textContent = result;
        wheel.style.transform = 'rotate(' + (360 + Math.random() * 720) + 'deg)';
        wheel.style.transition = 'transform 2s ease-out';
        p.textContent = 'Spinning...';
        setTimeout(() => { p.textContent = result; btn.disabled = false; if (result.includes('Win') || result.includes('Bonus') || result.includes('Gift') || result.includes('Hot') || result.includes('Gem')) gameWin(container, 'spinner', 2000, result, 'ðŸŽ¡'); else scheduleGamehubReplay('spinner', 2000); }, 2000);
      };
      container.appendChild(wheel);
      container.appendChild(btn);
    }

    function runTreasureGame(container) {
      const size = 4;
      const treasure = { r: Math.floor(Math.random() * size), c: Math.floor(Math.random() * size) };
      const p = document.createElement('p'); p.textContent = 'Find the treasure!'; p.style.marginBottom = '1rem'; container.appendChild(p);
      const grid = document.createElement('div');
      grid.style.cssText = 'display:grid;grid-template-columns:repeat(4,60px);gap:4px;width:fit-content;';
      for (let r = 0; r < size; r++) for (let c = 0; c < size; c++) {
        const cell = document.createElement('button');
        cell.style.cssText = 'width:60px;height:60px;font-size:1.5rem;border:2px solid var(--border);border-radius:8px;background:var(--bg-elevated);cursor:pointer;';
        cell.textContent = 'â“';
        cell.onclick = () => {
          if (r === treasure.r && c === treasure.c) { cell.textContent = 'ðŸ’Ž'; cell.style.background = '#ffd700'; p.textContent = 'You found it!'; gameWin(container, 'treasure', 1500, 'Treasure found!', 'ðŸ’Ž'); }
          else { cell.textContent = 'ðŸ•³ï¸'; cell.disabled = true; }
        };
        grid.appendChild(cell);
      }
      container.appendChild(grid);
    }

    function runWordchainGame(container) {
      const words = ['CAT','TEA','APE','ELF','FAN','NET','TAR','RAT','TIN','NAP','PEN','NOD','DOG','GUM','MAT','TAP','PET','TOE','EAR','RUN'];
      let chain = [], lastChar = '';
      const p = document.createElement('p'); p.textContent = 'Chain 5 words! Each must start with the last letter of the previous.'; p.style.marginBottom = '1rem'; container.appendChild(p);
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.placeholder = 'Type a word';
      inp.style.cssText = 'width:100%;padding:0.75rem;font-size:1.1rem;margin-bottom:0.5rem;text-transform:uppercase;';
      const btn = document.createElement('button');
      btn.textContent = 'Add';
      btn.className = 'gamehub-btn';
      btn.onclick = () => {
        const w = inp.value.toUpperCase().trim();
        if (!w || w.length < 2) return;
        if (chain.length > 0 && w[0] !== lastChar) { p.textContent = 'Must start with "' + lastChar + '"!'; return; }
        if (chain.includes(w)) { p.textContent = 'Already used!'; return; }
        chain.push(w);
        lastChar = w[w.length - 1];
        p.textContent = 'Chain: ' + chain.join(' â†’ ') + (chain.length >= 5 ? ' â€” Done!' : ' (next: ' + lastChar + ')');
        inp.value = '';
        if (chain.length >= 5) gameWin(container, 'wordchain', 1500, '5 words chained!', 'ðŸ”—');
      };
      container.appendChild(inp);
      container.appendChild(btn);
    }

    function runFruitninjaGame(container) {
      const fruits = ['ðŸŽ','ðŸŠ','ðŸ‹','ðŸ‡','ðŸ“','ðŸ‘','ðŸ‰','ðŸ¥'];
      const area = document.createElement('div');
      area.style.cssText = 'position:relative;width:100%;height:220px;background:linear-gradient(180deg,#1a237e 0%,#3949ab 100%);border-radius:12px;overflow:hidden;';
      const scoreEl = document.createElement('p'); scoreEl.style.marginBottom = '0.5rem'; scoreEl.textContent = 'Slice 10 fruit! 0/10'; container.appendChild(scoreEl);
      container.appendChild(area);
      let score = 0;
      const spawn = () => {
        if (score >= 10) return;
        const f = document.createElement('button');
        f.textContent = fruits[Math.floor(Math.random() * fruits.length)];
        f.style.cssText = 'position:absolute;font-size:2.5rem;border:none;background:none;cursor:pointer;left:' + (10 + Math.random() * 75) + '%;top:' + (10 + Math.random() * 65) + '%;';
        f.onclick = () => { score++; f.textContent = 'âœ¨'; f.style.transform = 'scale(0.5)'; setTimeout(() => f.remove(), 200); scoreEl.textContent = 'Slice 10 fruit! ' + score + '/10'; if (score >= 10) { scoreEl.textContent = 'Done!'; gameWin(container, 'fruitninja', 1500, '10 fruit sliced!', 'ðŸ‰'); } else spawn(); };
        area.appendChild(f);
      };
      for (let i = 0; i < 10; i++) setTimeout(spawn, i * 400);
    }

    function runGuessGame(container) {
      const secret = 1 + Math.floor(Math.random() * 100);
      let tries = 0, maxTries = 7;
      const p = document.createElement('p');
      p.textContent = 'Guess 1-100 (7 tries)';
      p.style.marginBottom = '1rem';
      const inp = document.createElement('input');
      inp.type = 'number';
      inp.min = 1;
      inp.max = 100;
      inp.placeholder = 'Your guess';
      inp.style.cssText = 'width:100px;padding:0.5rem;font-size:1.1rem;margin-right:0.5rem;';
      const btn = document.createElement('button');
      btn.textContent = 'Guess';
      btn.className = 'gamehub-btn';
      btn.onclick = () => {
        const g = +inp.value;
        if (isNaN(g) || g < 1 || g > 100) return;
        tries++;
        if (g === secret) { p.textContent = 'Correct! ' + secret + ' in ' + tries + ' tries!'; gameWin(container, 'guess', 1800, 'Number guessed in ' + tries + ' tries!', 'ðŸŽ¯'); return; }
        if (tries >= maxTries) { p.textContent = 'Out of tries! It was ' + secret; scheduleGamehubReplay('guess', 2000); return; }
        p.textContent = (g < secret ? 'Higher!' : 'Lower!') + ' (' + (maxTries - tries) + ' left)';
        inp.value = '';
      };
      container.appendChild(p);
      container.appendChild(inp);
      container.appendChild(btn);
    }

    function closeMenu() {
      const check = document.getElementById('menuCheck');
      if (check) check.checked = false;
    }

    document.getElementById('menuClose').addEventListener('click', closeMenu);
    document.getElementById('menuOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'menuOverlay') closeMenu();
    });
    const PARENT_GATE_EQUATIONS = [
      { text: '(17 Ã— 4) âˆ’ 23', answer: 45 },
      { text: '(12 + 8) Ã— 3 âˆ’ 15', answer: 45 },
      { text: '56 Ã· 7 + 9 Ã— 2', answer: 26 },
      { text: '(3 Ã— 7) + (4 Ã— 5)', answer: 41 },
      { text: '18 Ã— 3 âˆ’ 24 Ã· 2', answer: 42 },
      { text: '(100 âˆ’ 37) Ã· 7', answer: 9 },
      { text: '5Â² + 4 Ã— 3', answer: 37 },
      { text: 'âˆš81 + 7 Ã— 2', answer: 23 },
      { text: '15% of 80', answer: 12 },
      { text: '(6 Ã— 9) âˆ’ (8 Ã— 4)', answer: 22 },
      { text: '144 Ã· 12 + 5 Ã— 2', answer: 22 },
      { text: '2Â³ Ã— 3 âˆ’ 10', answer: 14 }
    ];
    let pendingParentPanel = false;
    function showParentGate() {
      const eq = PARENT_GATE_EQUATIONS[Math.floor(Math.random() * PARENT_GATE_EQUATIONS.length)];
      const overlay = document.getElementById('parentGateOverlay');
      const eqEl = document.getElementById('parentGateEquation');
      const inputEl = document.getElementById('parentGateAnswer');
      const errEl = document.getElementById('parentGateError');
      if (eqEl) eqEl.textContent = eq.text + ' = ?';
      if (inputEl) { inputEl.value = ''; inputEl.focus(); }
      if (errEl) errEl.style.display = 'none';
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden', 'false');
      overlay.dataset.correctAnswer = String(eq.answer);
    }
    function hideParentGate() {
      const overlay = document.getElementById('parentGateOverlay');
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden', 'true');
    }
    document.getElementById('parentGateAnswer').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('parentGateSubmit').click();
    });
    document.getElementById('parentGateSubmit').addEventListener('click', () => {
      const input = document.getElementById('parentGateAnswer');
      const err = document.getElementById('parentGateError');
      const overlay = document.getElementById('parentGateOverlay');
      const correct = parseInt(overlay.dataset.correctAnswer, 10);
      const given = parseInt(input.value, 10);
      if (!isNaN(given) && given === correct) {
        hideParentGate();
        if (pendingParentPanel) { switchPanel('forParents'); closeMenu(); pendingParentPanel = false; }
      } else {
        err.style.display = 'block';
        input.value = '';
        input.focus();
      }
    });
    document.getElementById('parentGateCancel').addEventListener('click', () => {
      hideParentGate();
      pendingParentPanel = false;
    });
    document.getElementById('parentGateOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'parentGateOverlay') { hideParentGate(); pendingParentPanel = false; }
    });
    document.querySelectorAll('.menu-item').forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.dataset.panel) {
          if (btn.dataset.panel === 'forParents') {
            closeMenu();
            pendingParentPanel = true;
            showParentGate();
          } else {
            switchPanel(btn.dataset.panel);
            closeMenu();
          }
        }
      });
    });
    document.getElementById('menuExportData').addEventListener('click', () => {
      const data = {
        streaks: loadStreaks(),
        calendar: loadCalendarActivities(),
        gems: loadGemData(),
        streaktopia: loadStreaktopia(),
        achievements: loadAchievements(),
        reminders: typeof loadReminders === 'function' ? loadReminders() : [],
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'streaks-backup-' + new Date().toISOString().slice(0, 10) + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
      closeMenu();
    });
    document.getElementById('menuImportData').addEventListener('click', () => {
      closeMenu();
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,application/json';
      input.onchange = () => {
        const f = input.files?.[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = () => {
          try {
            const data = JSON.parse(r.result);
            if (data.streaks) saveStreaks(data.streaks);
            if (data.calendar) saveCalendarActivities(data.calendar);
            if (data.gems) saveGemData(data.gems);
            if (data.streaktopia) saveStreaktopia(data.streaktopia);
            if (data.reminders && typeof saveReminders === 'function') saveReminders(data.reminders);
            if (data.achievements) saveAchievements(data.achievements);
            render();
            if (document.getElementById('panelCalendar').classList.contains('active')) { renderCalendar(); renderDayView(); }
            if (document.getElementById('panelStreaktopia').classList.contains('active')) renderStreaktopia();
            if (document.getElementById('panelReminders').classList.contains('active') && typeof renderReminders === 'function') renderReminders();
            if (document.getElementById('panelGamehub').classList.contains('active')) renderGamehub();
            if (document.getElementById('panelAchievements').classList.contains('active')) renderAchievements();
            alert('Data imported successfully.');
          } catch (err) {
            alert('Import failed: ' + (err.message || 'Invalid file'));
          }
        };
        r.readAsText(f);
      };
      input.click();
    });


    document.getElementById('calendarPrev').addEventListener('click', () => {
      calendarCurrent.setMonth(calendarCurrent.getMonth() - 1);
      renderCalendar();
    });
    document.getElementById('calendarNext').addEventListener('click', () => {
      calendarCurrent.setMonth(calendarCurrent.getMonth() + 1);
      renderCalendar();
    });

    document.querySelectorAll('input[name="activityType"]').forEach(radio => {
      radio.addEventListener('change', () => {
        const regularOpts = document.getElementById('regularOptions');
        regularOpts.style.display = radio.value === 'regular' ? 'block' : 'none';
        toggleFrequencyRows();
      });
    });
    document.querySelectorAll('input[name="frequency"]').forEach(radio => {
      radio.addEventListener('change', toggleFrequencyRows);
    });
    function toggleFrequencyRows() {
      const freq = document.querySelector('input[name="frequency"]:checked');
      const weeklyRow = document.getElementById('weeklyDaysRow');
      const monthlyRow = document.getElementById('monthlyDaysRow');
      if (!freq) return;
      weeklyRow.style.display = freq.value === 'weekly' ? 'block' : 'none';
      monthlyRow.style.display = freq.value === 'monthly' ? 'block' : 'none';
    }

    document.getElementById('addActivityForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      const input = document.getElementById('activityInput');
      const name = input.value.trim();
      const errorEl = document.getElementById('activityNameError');
      const submitBtn = document.querySelector('#addActivityForm button[type="submit"]');
      clearStreakNameError(input, errorEl);
      const dateInput = document.getElementById('addActivityDate');
      const date = (dateInput && dateInput.value) || document.getElementById('addActivityForm').dataset.date;
      const typeRadio = document.querySelector('input[name="activityType"]:checked');
      const type = typeRadio ? typeRadio.value : 'once';
      if (!name) return;
      if (submitBtn) { submitBtn.textContent = 'Checkingâ€¦'; submitBtn.disabled = true; }
      const check = await isRealActivity(name);
      if (submitBtn) { submitBtn.textContent = 'Add'; submitBtn.disabled = false; }
      if (!check.ok) {
        showStreakNameError(input, errorEl, check.msg);
        return;
      }
      if (!date || isPastDate(date)) return;
      const activities = loadCalendarActivities();
      if (type === 'regular') {
        const freqRadio = document.querySelector('input[name="frequency"]:checked');
        const frequency = freqRadio ? freqRadio.value : 'daily';
        const payload = {
          id: Date.now().toString(),
          name,
          startDate: date,
          type: 'regular',
          frequency,
          completedDates: []
        };
        if (frequency === 'weekly') {
          const weekdays = Array.from(document.querySelectorAll('input[name="weekday"]:checked')).map(c => parseInt(c.value, 10));
          payload.weekdays = weekdays.length ? weekdays : [0, 1, 2, 3, 4, 5, 6];
        } else if (frequency === 'monthly') {
          const monthInput = document.getElementById('monthDaysInput');
          const raw = monthInput ? monthInput.value.trim() : '';
          const monthDays = raw ? raw.split(/[,\s]+/).map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n) && n >= 1 && n <= 31) : [];
          payload.monthDays = monthDays.length ? [...new Set(monthDays)] : [1];
        }
        activities.push(payload);
      } else {
        activities.push({
          id: Date.now().toString(),
          name,
          date,
          type: 'once',
          completed: false
        });
      }
      saveCalendarActivities(activities);
      input.value = '';
      clearStreakNameError(input, errorEl);
      const monthDaysEl = document.getElementById('monthDaysInput');
      if (monthDaysEl) monthDaysEl.value = '';
      document.querySelectorAll('input[name="weekday"]').forEach(c => { c.checked = false; });
      renderCalendar();
      renderDayView();
      render();
    });
    document.getElementById('activityInput').addEventListener('input', () => {
      clearStreakNameError(document.getElementById('activityInput'), document.getElementById('activityNameError'));
    });

    let deferredInstallPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredInstallPrompt = e;
    });
    document.addEventListener('click', (e) => {
      if (e.target.matches('[data-install-dismiss]') || e.target.closest('[data-install-dismiss]')) {
        hideAllInstallPrompts();
      }
      if (e.target.matches('[data-install-btn]') || e.target.closest('[data-install-btn]')) {
        if (deferredInstallPrompt) {
          deferredInstallPrompt.prompt();
          deferredInstallPrompt.userChoice.then(() => { deferredInstallPrompt = null; });
        } else {
          if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
            alert('To add Streakify to your home screen: tap the Share button, then "Add to Home Screen".');
          } else {
            alert('To install Streakify: use your browser\'s menu to "Install app" or "Add to Home Screen".');
          }
        }
        hideAllInstallPrompts();
      }
    });

    checkDailyLoginBonus();
    if (!localStorage.getItem(ONBOARDING_SEEN_KEY) && loadStreaks().length === 0) {
      document.getElementById('onboardingOverlay').style.display = 'flex';
      document.getElementById('onboardingOverlay').setAttribute('aria-hidden', 'false');
    }
    document.getElementById('onboardingGotIt').addEventListener('click', () => {
      localStorage.setItem(ONBOARDING_SEEN_KEY, '1');
      document.getElementById('onboardingOverlay').style.display = 'none';
      document.getElementById('onboardingOverlay').setAttribute('aria-hidden', 'true');
    });
    window.addEventListener('online', () => { document.getElementById('offlineBanner').style.display = 'none'; render(); });
    window.addEventListener('offline', () => { document.getElementById('offlineBanner').style.display = 'block'; });
    if (!navigator.onLine) document.getElementById('offlineBanner').style.display = 'block';
    const lastBackup = localStorage.getItem(LAST_BACKUP_REMINDER_KEY);
    const daysSinceBackup = lastBackup ? (Date.now() - parseInt(lastBackup, 10)) / 86400000 : 999;
    if (daysSinceBackup > 7 && loadStreaks().length > 0) {
      const toast = document.createElement('div');
      toast.className = 'streaktopia-toast';
      toast.style.cssText = 'bottom:auto;top:4rem;left:50%;transform:translateX(-50%);';
      toast.textContent = 'ðŸ’¾ Tip: Export your data from the menu to backup!';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
      localStorage.setItem(LAST_BACKUP_REMINDER_KEY, String(Date.now()));
    }
    document.getElementById('quickDarkToggle').addEventListener('click', () => {
      const s = loadSettings();
      saveSettings({ ...s, darkMode: !s.darkMode });
      document.body.classList.toggle('dark-mode', !s.darkMode);
      document.getElementById('quickDarkToggle').textContent = s.darkMode ? 'ðŸŒ™' : 'â˜€ï¸';
      document.getElementById('quickDarkToggle').title = s.darkMode ? 'Switch to light mode' : 'Switch to dark mode';
    });
    const qdt = document.getElementById('quickDarkToggle');
    if (qdt && loadSettings().darkMode) { qdt.textContent = 'â˜€ï¸'; qdt.title = 'Switch to light mode'; }
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeMenu();
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.key === '?' || e.key === '/') { e.preventDefault(); document.getElementById('searchQuests')?.focus(); }
    });
    render();
    showInstallPromptInActivePanel();
    document.body.className = 'theme-' + (loadSettings().theme || 'default');
    if (loadSettings().darkMode) document.body.classList.add('dark-mode');
  </script>
</body>
</html>
